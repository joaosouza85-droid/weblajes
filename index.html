<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>Orçamento—Freitas Lajes</title>
<link rel="icon" type="image/x-icon" href="favicon.ico">
<!-- PDF.js library for PDF rendering -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
  // Configure PDF.js worker
  if(typeof pdfjsLib !== 'undefined'){
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  }
</script>
<style>
:root{
  /* Primary brand reds - use semantic tokens for easier tuning */
  --red-900: #420606; /* very dark */
  --red-700: #6f0f0f; /* dark */
  --red-500: #b21919; /* vivid */
  --primario: var(--red-700);
  --primEsc: var(--red-500);
}
body{font-family:Arial,Helvetica,sans-serif;background:#f4f4f4;margin:0;padding:18px}
.card{max-width:1400px;margin:0 auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;background:linear-gradient(180deg,#fff 0%,#fafafa 100%);padding:16px 24px;border-radius:10px;box-shadow:0 4px 12px rgba(0,0,0,0.08),0 1px 3px rgba(0,0,0,0.05);border-bottom:2px solid rgba(178,25,25,0.12);transition:all 0.3s ease}
header:hover{box-shadow:0 6px 16px rgba(0,0,0,0.1),0 2px 4px rgba(0,0,0,0.06);transform:translateY(-1px)}
h1{font-size:18px;margin:0;color:var(--primario)}
#modulo-atual-titulo{font-size:20px;font-weight:700;color:var(--primario);text-transform:uppercase;letter-spacing:0.5px;transition:all 0.3s ease;text-shadow:0 2px 4px rgba(0,0,0,0.05)}
.header-logo{transition:all 0.25s ease;filter:drop-shadow(0 2px 3px rgba(0,0,0,0.08))}
.header-logo:hover{transform:scale(1.08);filter:drop-shadow(0 4px 8px rgba(178,25,25,0.3))}
.tabs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
.tabs{transition:opacity .22s ease, max-height .22s ease;overflow:hidden}
.tabs.hidden{opacity:0;max-height:0;pointer-events:none}
.tabs{display:flex}
.tab{padding:8px 12px;border-radius:6px;border:1px solid #ddd;cursor:pointer;background:#fff}
.tab.active{background:var(--primario);color:#fff;border-color:var(--primario)}
.section{display:none}
.section.active{display:block}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{padding:8px;border:1px solid #eee;text-align:left;font-size:14px}
th{background:#fceaea;color:var(--primario)}
.right{text-align:right}
.qtd, .price, .desc, .unit, .cliente-input, .cliente-textarea, .lead-input, .lead-textarea {padding:6px; width:100%; box-sizing:border-box}
.small{width:90px}
.actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
/* Styles for catalog action buttons */
.btn-edit{background:#fff;color:var(--primario);border:1px solid #d0d0d0;padding:6px 10px;border-radius:6px;cursor:pointer;font-weight:600}
.btn-edit:hover{background:#f6f8fb}
.btn-save{background:#2b76d2;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;font-weight:700}
.btn-save:hover{background:#205f9a}
.btn-cancel{background:#fff;color:#666;border:1px solid #ddd;padding:6px 10px;border-radius:6px;cursor:pointer}
.btn-cancel:hover{box-shadow:0 2px 6px rgba(0,0,0,0.06);transform:translateY(-1px)}
/* Module dashboard / home cards - mobile-first layout */
.module-grid{display:grid;grid-template-columns:repeat(1,1fr);gap:12px}
@media(min-width:900px){ .module-grid{grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px} }
/* Header logo area (uploadable, responsive) */
.header-left{display:flex;align-items:center;gap:12px}
.header-logo{display:flex;align-items:center;gap:8px}
.header-logo img{width:64px;height:64px;object-fit:contain;border-radius:8px;transition:transform .16s,box-shadow .16s,filter .16s}
.header-logo img:hover,.header-logo img:focus{transform:scale(1.06);box-shadow:0 10px 30px rgba(178,25,25,0.18);filter:brightness(1.04)}
.header-logo button{padding:6px 8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06);background:#fff;color:var(--primario);cursor:pointer}
  /* fluid brand title: scales between 20px and 36px depending on viewport */
  .header-logo .brand-title{font-size:clamp(20px, calc(2.6vw + 8px), 36px);font-weight:700;color:var(--primario)}
/* Responsive adjustments for header logo */
@media(max-width:720px){
}
/* Accessibility: visible focus for keyboard users */
.module-card:focus-visible{outline:3px solid rgba(178,25,25,0.18);box-shadow:0 20px 60px rgba(6,6,6,0.12), 0 6px 28px rgba(178,25,25,0.12);transform:translateY(-8px) scale(1.01)}
/* Global module card styling — use Home visual language for all cards */
.module-card{transition:transform .22s cubic-bezier(.22,.9,.3,1),box-shadow .22s,background .22s}
.module-card{background:linear-gradient(180deg,#efeded,#f6f5f5);border:1px solid rgba(0,0,0,0.06);border-radius:14px;padding:12px;display:flex;flex-direction:row;align-items:center;gap:12px;cursor:pointer;min-height:110px}
.module-card:hover{transform:translateY(-10px) scale(1.02);box-shadow:0 32px 80px rgba(6,6,6,0.18), 0 6px 30px rgba(178,20,20,0.14);background:linear-gradient(180deg,var(--red-500) 0%, var(--red-700) 60%, var(--red-900) 100%);border-color: rgba(178,25,25,0.18)}
.module-card:focus{outline:none;box-shadow:0 18px 56px rgba(112,16,16,0.12);transform:translateY(-6px)}
.module-card .icon{font-size:22px;background:linear-gradient(135deg,var(--red-700) 0%, var(--red-500) 50%, var(--red-900) 100%);width:64px;height:64px;border-radius:12px;display:flex;align-items:center;justify-content:center;transition:transform .12s;color:#fff;box-shadow:inset 0 -6px 14px rgba(0,0,0,0.14);position:relative;overflow:hidden}
.module-card:hover .icon{
  /* diagonal grayscale gradient (same style as default red gradient but in gray tones) */
  background:linear-gradient(135deg, #bdbdbd 0%, #8f8f91 45%, #6b6b6d 100%);
  color:#000;
  box-shadow:inset 0 -8px 22px rgba(0,0,0,0.2), 0 10px 32px rgba(0,0,0,0.18);
  transform:scale(1.08);
  position:relative;
}
/* removed the rectangular highlight to avoid boxed look; radial shine (:before) remains */

/* radial shine similar to client icons, only visible on hover (grayscale) */
.module-card .icon:before{
  content:'';position:absolute;left:-6px;top:-6px;right:-6px;bottom:-6px;border-radius:14px;pointer-events:none;mix-blend-mode:overlay;
  /* larger, brighter radial shine (simulates a subtle blur by spreading the gradient) */
  background: radial-gradient(circle at 34% 28%, rgba(255,255,255,0.36) 0%, rgba(255,255,255,0.18) 28%, rgba(255,255,255,0) 50%);
  opacity:0;transition:opacity .18s ease-in-out, transform .18s;
  transform:scale(0.98);
}
.module-card:hover .icon:before{opacity:1;transform:scale(1)}
.module-card .title{font-size:18px;font-weight:900;color:#111;white-space:normal;transition:color .18s;line-height:1.12;letter-spacing:normal;word-spacing:normal}
.module-card:hover .title, .client-module-cards .client-card:hover .title, .lead-module-cards .lead-card:hover .title{ color: #fff; }
.module-card .subtitle{font-size:13px;color:#222;opacity:0.95;transition:color .16s;line-height:1.18;letter-spacing:normal;word-spacing:normal}
/* Home module subtitles: very dark gray (same tone as title) when not hovered, white on hover */
#home .module-card .subtitle{ color: #111; font-weight:700; }
#home .module-card:hover .subtitle{ color: #fff; font-weight:700; }
.module-card::after{content:'';display:block;height:4px;border-radius:4px;margin-top:8px;background:linear-gradient(90deg, rgba(178,25,25,0.12), rgba(112,16,16,0.02))}

/* Favorites UI: star button on cards and favorites strip on Home */
.module-card{position:relative}
.fav-btn{position:absolute;top:10px;right:10px;border:0;background:transparent;font-size:22px;cursor:pointer;padding:6px;border-radius:6px;transition:all .2s ease;opacity:0.3;filter:grayscale(100%) brightness(0.5)}
.fav-btn[aria-pressed="true"]{opacity:1;filter:grayscale(0%) brightness(1.2) drop-shadow(0 2px 4px rgba(255,193,7,0.5));transform:scale(1.15)}
.fav-btn:hover{transform:scale(1.25);opacity:0.7}
.fav-btn[aria-pressed="true"]:hover{opacity:1;transform:scale(1.3);filter:grayscale(0%) brightness(1.3) drop-shadow(0 3px 6px rgba(255,193,7,0.7))}
.fav-btn:focus{outline:2px solid rgba(112,16,16,0.12)}
.favorites-strip{display:flex;gap:10px;align-items:center;padding:8px 0}
.favorites-strip .fav-item{display:flex;align-items:center;gap:8px;padding:8px 12px;background:linear-gradient(180deg,#f5f5f5 0%, #2b2b2b 100%);border:1px solid rgba(0,0,0,0.06);border-radius:10px;cursor:pointer;transition:transform .22s cubic-bezier(.22,.9,.3,1),box-shadow .22s,background .22s,color .14s}
.favorites-strip .fav-item .icon{font-size:18px;color:#fff}
.favorites-strip .fav-item .title{font-weight:700;color:#fff;transition:color .14s}
.favorites-strip .fav-item .subtitle{ font-weight:700; color:#fff }
/* on hover, replicate the module-card hover background and set title to very light gray */
/* Make favorite items behave like module cards (movement, shadow, transitions) */
.favorites-strip .fav-item:hover{transform:translateY(-10px) scale(1.02);box-shadow:0 32px 80px rgba(0,0,0,0.34);background:linear-gradient(180deg,#e6e6e6 0%, #121212 100%);border-color: rgba(0,0,0,0.28)}
.favorites-strip .fav-item:hover .title, .favorites-strip .fav-item:hover .subtitle{color:#f3f3f3}
.favorites-strip .fav-item:focus-visible{outline:3px solid rgba(178,25,25,0.18);box-shadow:0 20px 60px rgba(6,6,6,0.12), 0 6px 28px rgba(178,25,25,0.12);transform:translateY(-8px) scale(1.01)}

/* Entrada (aparecimento) da área de favoritos: inicialmente oculta/fora de posição, aparece com transição */
#favoritos-area{opacity:0;transform:translateY(12px);transition:opacity .36s cubic-bezier(.2,.9,.3,1), transform .36s cubic-bezier(.2,.9,.3,1);}
#favoritos-area.appear{opacity:1;transform:translateY(0);}
/* Styles for favoritos header and description */
.fav-header{margin:0; font-size:18px; font-weight:700}
.fav-desc{margin-top:6px; font-size:13px; opacity:0.9; font-weight:700}

/* Fav-module-card: applied to favorite cards rendered in #favoritos-grid */
.fav-module-card{
  /* from light gray (matching WebLajes light tone) to dark red brand color */
  background: linear-gradient(135deg, #f5f5f5 0%, var(--red-900) 100%);
  border: 1px solid rgba(0,0,0,0.48);
  color: #fff;
  box-shadow: 0 10px 30px rgba(0,0,0,0.36);
}
/* Force white text for favorites using a more specific selector to override general .subtitle rules */
#favoritos-area .fav-module-card .title,
#favoritos-area .fav-module-card .subtitle,
#favoritos-area .fav-module-card .icon{
  color:#ffffff;
}
.fav-module-card .subtitle{color:#ffffff}
.fav-module-card:hover{
  /* hover: from light red to dark gray */
  background: linear-gradient(135deg, var(--red-500) 0%, #2b2b2b 100%);
  border-color: rgba(0,0,0,0.6);
  box-shadow: 0 40px 100px rgba(0,0,0,0.6);
  transform: translateY(-8px) scale(1.02);
}
.fav-module-card:hover .title, .fav-module-card:hover .subtitle, .fav-module-card:hover .icon{color:#fff}

/* Background for the favoritos header area */
/* Header-only background for favoritos */
#favoritos-area{ padding:0; }
.fav-header-wrap{background:linear-gradient(180deg,#234a52 0%, #1f2729 100%);padding:12px;border-radius:8px;margin-bottom:12px;border:1px solid rgba(30,60,66,0.12);box-shadow: inset 0 -8px 14px rgba(0,0,0,0.18)}
.fav-header-wrap .fav-header, .fav-header-wrap .fav-desc{color:#e9f6f6}

/* Dashboard card tweaks */
.dashboard-card{min-height:90px;display:flex;align-items:center;background:linear-gradient(180deg,#fff,#fcfbfb);border:1px solid rgba(16,16,16,0.04)}
.dashboard-card .title{font-size:16px}
.dashboard-card .subtitle{font-size:13px;color:#555}
.dashboard-card .subtitle #db-clientes-count, .dashboard-card .subtitle #db-orcamentos-count, .dashboard-card .subtitle #db-produtos-count, .dashboard-card .subtitle #db-anexos-count{font-weight:800;color:var(--primario);margin-right:6px}

/* Clientes module cards: use the same flex-based layout as Home (.module-card) for identical positioning */
.client-module-cards{display:flex;gap:12px;flex-wrap:wrap}
.client-module-cards .client-card{background:linear-gradient(180deg,#efeded,#f6f5f5);border:1px solid rgba(0,0,0,0.06);border-radius:14px;padding:12px;display:flex;flex-direction:row;align-items:center;gap:12px;cursor:pointer;min-height:110px;transition:transform .22s cubic-bezier(.22,.9,.3,1),box-shadow .22s,background .22s;position:relative}
.client-module-cards .client-card .icon{font-size:22px;width:64px;height:64px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;box-shadow:inset 0 -6px 14px rgba(0,0,0,0.14);position:relative;overflow:hidden;background:linear-gradient(135deg,var(--red-700) 0%, var(--red-500) 50%, var(--red-900) 100%);transition:transform .12s, background .12s, color .12s, box-shadow .12s;flex:0 0 64px}
.client-module-cards .client-card .icon:before{content:'';position:absolute;left:-6px;top:-6px;right:-6px;bottom:-6px;border-radius:14px;pointer-events:none;mix-blend-mode:overlay;background: radial-gradient(circle at 34% 28%, rgba(255,255,255,0.36) 0%, rgba(255,255,255,0.18) 28%, rgba(255,255,255,0) 50%);opacity:0;transition:opacity .18s ease-in-out, transform .18s;transform:scale(0.98)}
.client-module-cards .client-card .icon:after{display:none}
.client-module-cards .client-card .title{font-size:18px;font-weight:900;color:#111;flex:1 1 auto;min-width:0}
.client-module-cards .client-card .subtitle{font-size:13px;color:#222;opacity:0.95;flex:1 1 auto;min-width:0}
.client-module-cards .client-card:hover{transform:translateY(-10px) scale(1.02);box-shadow:0 32px 80px rgba(6,6,6,0.18), 0 6px 30px rgba(178,20,20,0.14);background:linear-gradient(180deg,var(--red-500) 0%, var(--red-700) 60%, var(--red-900) 100%)}
.client-module-cards .client-card:hover .title, .client-module-cards .client-card:hover .subtitle { color: #fff; }
.client-module-cards .client-card:hover .icon{transform:scale(1.08);background:linear-gradient(135deg, #bdbdbd 0%, #8f8f91 45%, #6b6b6d 100%);color:#000;box-shadow:inset 0 -8px 22px rgba(0,0,0,0.2), 0 10px 32px rgba(0,0,0,0.18)}
.client-module-cards .client-card:hover .icon:before{opacity:1;transform:scale(1)}
.client-module-cards .client-card:focus{outline:none;box-shadow:0 18px 56px rgba(112,16,16,0.12);transform:translateY(-6px)}

@media (max-width:720px){
  .client-module-cards .client-card{flex-direction:column;align-items:flex-start;padding:10px}
  .client-module-cards .client-card .icon{width:56px;height:56px}
  .client-module-cards .client-card .title{font-size:16px}
}
@media(max-width:420px){
  .client-module-cards{gap:10px}
  .client-module-cards .client-card{flex-direction:column;align-items:flex-start;padding:8px}
  .client-module-cards .client-card .icon{width:48px;height:48px;font-size:20px}
  .client-module-cards .client-card .title{font-size:15px}
  .client-module-cards .client-card .subtitle{font-size:12px}
}

/* Leads module cards: same styling as clientes */
.lead-module-cards{display:flex;gap:12px;flex-wrap:wrap}
.lead-module-cards .lead-card{background:linear-gradient(180deg,#efeded,#f6f5f5);border:1px solid rgba(0,0,0,0.06);border-radius:14px;padding:12px;display:flex;flex-direction:row;align-items:center;gap:12px;cursor:pointer;min-height:110px;transition:transform .22s cubic-bezier(.22,.9,.3,1),box-shadow .22s,background .22s;position:relative}
.lead-module-cards .lead-card .icon{font-size:22px;width:64px;height:64px;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;box-shadow:inset 0 -6px 14px rgba(0,0,0,0.14);position:relative;overflow:hidden;background:linear-gradient(135deg,var(--red-700) 0%, var(--red-500) 50%, var(--red-900) 100%);transition:transform .12s, background .12s, color .12s, box-shadow .12s;flex:0 0 64px}
.lead-module-cards .lead-card .icon:before{content:'';position:absolute;left:-6px;top:-6px;right:-6px;bottom:-6px;border-radius:14px;pointer-events:none;mix-blend-mode:overlay;background: radial-gradient(circle at 34% 28%, rgba(255,255,255,0.36) 0%, rgba(255,255,255,0.18) 28%, rgba(255,255,255,0) 50%);opacity:0;transition:opacity .18s ease-in-out, transform .18s;transform:scale(0.98)}
.lead-module-cards .lead-card .icon:after{display:none}
.lead-module-cards .lead-card .title{font-size:18px;font-weight:900;color:#111;flex:1 1 auto;min-width:0}
.lead-module-cards .lead-card .subtitle{font-size:13px;color:#222;opacity:0.95;flex:1 1 auto;min-width:0}
.lead-module-cards .lead-card:hover{transform:translateY(-10px) scale(1.02);box-shadow:0 32px 80px rgba(6,6,6,0.18), 0 6px 30px rgba(178,20,20,0.14);background:linear-gradient(180deg,var(--red-500) 0%, var(--red-700) 60%, var(--red-900) 100%)}
.lead-module-cards .lead-card:hover .title, .lead-module-cards .lead-card:hover .subtitle { color: #fff; }
.lead-module-cards .lead-card:hover .icon{transform:scale(1.08);background:linear-gradient(135deg, #bdbdbd 0%, #8f8f91 45%, #6b6b6d 100%);color:#000;box-shadow:inset 0 -8px 22px rgba(0,0,0,0.2), 0 10px 32px rgba(0,0,0,0.18)}
.lead-module-cards .lead-card:hover .icon:before{opacity:1;transform:scale(1)}
.lead-module-cards .lead-card:focus{outline:none;box-shadow:0 18px 56px rgba(112,16,16,0.12);transform:translateY(-6px)}

@media (max-width:720px){
  .lead-module-cards .lead-card{flex-direction:column;align-items:flex-start;padding:10px}
  .lead-module-cards .lead-card .icon{width:56px;height:56px}
  .lead-module-cards .lead-card .title{font-size:16px}
}
@media(max-width:420px){
  .lead-module-cards{gap:10px}
  .lead-module-cards .lead-card{flex-direction:column;align-items:flex-start;padding:8px}
  .lead-module-cards .lead-card .icon{width:48px;height:48px;font-size:20px}
  .lead-module-cards .lead-card .title{font-size:15px}
  .lead-module-cards .lead-card .subtitle{font-size:12px}
}

/* Darker variant for Home module cards */
/* Home cards: base and hover effects */
/* ensure title/subtitle take remaining space and wrap across all module-card instances */
.module-card > .title, .module-card > .subtitle {flex:1 1 auto;min-width:0}
@media (max-width:720px){
  .module-card{flex-direction:column;align-items:flex-start;padding:10px}
  .module-card .icon{width:56px;height:56px}
  .module-card .title{font-size:16px}
}
@media(max-width:420px){
  .module-grid{grid-template-columns:repeat(1,1fr);gap:10px}
  .module-card{flex-direction:column;align-items:flex-start;padding:8px}
  .module-card .icon{width:48px;height:48px;font-size:20px}
  .module-card .title{font-size:15px}
  .module-card .subtitle{font-size:12px}
}
/* prevent icon+text from breaking awkwardly */
.module-card .icon, .module-card .title{flex-shrink:0}
.module-card > .title, .module-card > .subtitle {min-width:0}

/* Sidebar de módulos (recolhível) */
#module-sidebar{position:fixed;left:0;top:80px;bottom:20px;width:280px;background:#fff;border-right:1px solid rgba(0,0,0,0.04);box-shadow:2px 8px 32px rgba(0,0,0,0.08);padding:14px;overflow:auto;z-index:1400;transform:translateX(0);opacity:1;transition:transform .28s cubic-bezier(.2,.9,.3,1),opacity .22s}
#module-sidebar.hidden{transform:translateX(-100%);opacity:0;pointer-events:none}
#module-sidebar .sidebar-title{font-weight:700;color:var(--primario);margin-bottom:8px}
#module-sidebar .module-grid{grid-template-columns:1fr;gap:10px}
/* Sidebar subtitles: bold by default; white and bold on hover */
#module-sidebar .module-card .subtitle{ font-weight:700; }
#module-sidebar .module-card:hover .subtitle{ color: #fff; font-weight:700; }
/* Sidebar toggle button - more prominent */
#module-sidebar-toggle{position:fixed;left:12px;top:22px;width:48px;height:48px;border-radius:999px;background:var(--primario);border:none;color:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:1500;transition:left .18s,transform .18s,box-shadow .18s,background .12s;box-shadow:0 8px 28px rgba(112,16,16,0.18);font-size:18px}
#module-sidebar-toggle:hover{box-shadow:0 12px 40px rgba(112,16,16,0.22);transform:translateY(-2px)}
#module-sidebar-toggle:focus{outline:none;box-shadow:0 0 0 4px rgba(112,16,16,0.12)}
#module-sidebar-toggle .toggle-icon{width:20px;height:20px;display:block;fill:currentColor;transition:transform .18s}
#module-sidebar-toggle.open .toggle-icon{transform:rotate(90deg)}
/* Ajuste automático do conteúdo quando sidebar visível (aberta ou fechada, mas não hidden) */
body.sidebar-visible .card{margin-left:300px;transition:margin-left .28s}
body.sidebar-open .card{margin-left:300px;transition:margin-left .28s}
/* when sidebar is open, position the toggle inside the bar (slightly inset) */
body.sidebar-open #module-sidebar-toggle{left:236px}
@media(max-width:900px){#module-sidebar{display:none} #module-sidebar-toggle{display:none} body.sidebar-visible .card{margin-left:0} body.sidebar-open .card{margin-left:0}}

/* entrada dos cards: slide-up + fade */
@keyframes slideUpFade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
/* Fade-in for newly added observation rows */
@keyframes obsFadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.obs-fade{animation: obsFadeIn .36s ease forwards}
button{
  background:var(--primario);
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
  transition:background .1s
}
button.secondary{background:#fff;color:var(--primario);border:1px solid var(--primario)}
button.danger{background:#e03a3a}
input:invalid {border:1px solid #e03a3a}
.row{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.note{font-size:13px;color:#555;margin-top:12px;border-top:1px dashed #ddd;padding-top:10px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.floater{display:flex;gap:8px;align-items:center}
.orcamento-list{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.orcamento-list button{padding:6px 10px;font-size:13px;}
.toast {
  position: fixed;
  left:50%;
  bottom:32px;
  z-index:1000;
  transform:translateX(-50%);
  min-width:240px;
  padding:12px 30px;
  background:rgba(112,16,16,0.95);
  color:#fff;
  border-radius:8px;
  font-size:16px;
  box-shadow: 0 8px 36px rgba(0,0,0,0.18);}
.toast.erro{background:#e03a3a}
/* Modal footer button specific styles */
#cliente-modal-salvar{background:#2b76d2}
#cliente-modal-salvar:hover, #cliente-modal-salvar:focus{background:#205f9a}
#cliente-modal-cancelar:hover, #cliente-modal-cancelar:focus{box-shadow:0 2px 6px rgba(0,0,0,0.08);transform:translateY(-1px)}

/* Responsive: stack footer buttons vertically on small screens */
@media (max-width:520px){
  #cliente-modal-footer{display:flex;flex-direction:column;gap:10px;padding:12px}
  #cliente-modal-footer button{width:100%;display:block}
  #cliente-modal-salvar{order:2}
  #cliente-modal-cancelar{order:1}
}
/* Fixed actions bar for observations */
.painel-actions{position:fixed;right:24px;bottom:90px;background:rgba(255,255,255,0.98);padding:10px 12px;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,0.12);max-width:420px;width:calc(100% - 60px);z-index:2001}
@media (max-width:520px){
  .painel-actions{right:12px;left:12px;bottom:84px;width:auto}
}
.toast.sucesso{background:#34a853}
@media(max-width:900px){.row{flex-direction:column;align-items:stretch}.small{width:100%}}
/* Borda ativa de input */
input:focus, textarea:focus {outline: 2px solid var(--primario);}
select:focus {outline: 2px solid var(--primario);}
::-webkit-input-placeholder { color: #bdbdbd; }
::-moz-placeholder { color: #bdbdbd; }
:-ms-input-placeholder { color: #bdbdbd; }
::placeholder { color: #bdbdbd; }
/* screen-reader only helper (kept in CSS head) */
.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
/* Highlight for focused lists */
.list-focus-highlight{box-shadow:0 0 0 4px rgba(178,25,25,0.12) inset, 0 10px 40px rgba(178,25,25,0.06);border-radius:6px;transition:box-shadow .28s, transform .12s}

/* Right column panel headings: prevent wrapping so titles stay on one line */
.painel-right .panel-heading{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:block}

/* Destaque para campo de busca de clientes */
#cliente-busca{
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #d9dbe0;
  box-shadow:0 6px 18px rgba(6,6,6,0.06);
  transition:box-shadow .16s ease, border-color .12s ease, transform .12s;
  background:linear-gradient(180deg,#fff,#fbfcff);
}
#cliente-busca::placeholder{color:#9ea6b0}
#cliente-busca:focus{border-color:var(--primario);box-shadow:0 8px 28px rgba(112,16,16,0.08);outline:none;transform:translateY(-1px)}

/* Lupa dentro do campo de busca (background SVG) */
#cliente-busca{background-repeat:no-repeat;background-position:right 12px center;padding-right:40px;background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%239ea6b0' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='11' cy='11' r='7'></circle><line x1='21' y1='21' x2='16.65' y2='16.65'></line></svg>");}
#cliente-busca:focus{background-image:url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%23b21919' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><circle cx='11' cy='11' r='7'></circle><line x1='21' y1='21' x2='16.65' y2='16.65'></line></svg>");}

/* Responsive modal rules for cliente modal */
.cliente-modal-content{width:1100px;max-width:95%;}
@media (max-width:1000px){
  .cliente-modal-content{width:min(920px,95%);} 
}
@media (max-width:900px){
  .cliente-modal-content{width:95%;height:auto;margin:12px;}
  .cliente-modal-columns{flex-direction:column}
  .cliente-modal-left{width:100%;}
  .cliente-modal-right{width:100%;flex:0 0 auto;border-left:none;border-top:1px solid rgba(0,0,0,0.06);}
  .cliente-modal-body{padding:12px}
}
</style>
</head>
<body>
<!-- Module Sidebar (retrátil) -->
<button id="module-sidebar-toggle" onclick="toggleSidebar()" aria-label="Toggle módulos" title="Abrir/Fechar módulos">
  <span class="toggle-icon">☰</span>
</button>
<div id="module-sidebar" class="hidden">
  <div class="sidebar-title">Módulos</div>
  <div class="module-grid">
    <div class="module-card" data-module="leads" onclick="abrir('leads')">
      <div class="icon">🎯</div>
      <div class="label">
        <div class="title">Leads</div>
        <div class="subtitle">Gerenciar potenciais clientes</div>
      </div>
    </div>
    <div class="module-card" data-module="clientes" onclick="abrir('clientes')">
      <div class="icon">👥</div>
      <div class="label">
        <div class="title">Clientes</div>
        <div class="subtitle">Abrir cadastro de clientes</div>
      </div>
    </div>
    <div class="module-card" data-module="orc" onclick="abrir('orc')">
      <div class="icon">🧾</div>
      <div class="label">
        <div class="title">Orçamentos</div>
        <div class="subtitle">Criar e gerenciar orçamentos</div>
      </div>
    </div>
    <div class="module-card" data-module="vendas" onclick="abrir('vendas')">
      <div class="icon">💳</div>
      <div class="label">
        <div class="title">Vendas</div>
        <div class="subtitle">Processo de vendas</div>
      </div>
    </div>
    <div class="module-card" data-module="producao" onclick="abrir('producao')">
      <div class="icon">🏗️</div>
      <div class="label">
        <div class="title">Produção</div>
        <div class="subtitle">Acompanhar produção</div>
      </div>
    </div>
    <div class="module-card" data-module="entrega" onclick="abrir('entrega')">
      <div class="icon">🚚</div>
      <div class="label">
        <div class="title">Entrega</div>
        <div class="subtitle">Gerenciar entregas</div>
      </div>
    </div>
    <div class="module-card" data-module="posvendas" onclick="abrir('posvendas')">
      <div class="icon">🔧</div>
      <div class="label">
        <div class="title">Pós-Vendas</div>
        <div class="subtitle">Suporte pós-venda</div>
      </div>
    </div>
    <div class="module-card" data-module="configuracoes" onclick="abrir('configuracoes')">
      <div class="icon">⚙️</div>
      <div class="label">
        <div class="title">Configurações</div>
        <div class="subtitle">Preferências do sistema</div>
      </div>
    </div>
    <div class="module-card" data-module="relatorios" onclick="abrir('relatorios')">
      <div class="icon">📊</div>
      <div class="label">
        <div class="title">Relatórios</div>
        <div class="subtitle">Análises e relatórios</div>
      </div>
    </div>
    <div class="module-card" data-module="dashboard" onclick="abrir('dashboard')">
      <div class="icon">📈</div>
      <div class="label">
        <div class="title">Dashboard</div>
        <div class="subtitle">Visão geral do negócio</div>
      </div>
    </div>
  </div>
</div>

<script>
// Força abertura da home ao carregar/recarregar - versão otimizada
function forcarHome() {
  // Remove active de todas as abas e seções
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  
  // Ativa apenas home - verifica se existe antes de tentar acessar
  const homeSection = document.getElementById('home');
  if(homeSection) homeSection.classList.add('active');
  
  // Esconde tabs se necessário
  const tabs = document.querySelector('.tabs');
  if(tabs) tabs.classList.add('hidden');
}

// Executa apenas uma vez quando o DOM estiver pronto
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', forcarHome);
} else {
  // DOM já está carregado
  forcarHome();
}
</script>
<script>
// Make header logo container keyboard-activatable (Enter/Space) and show pointer cursor
document.addEventListener('DOMContentLoaded', function(){
  const headerLogo = document.getElementById('header-logo-container');
  if(headerLogo){
    headerLogo.addEventListener('keydown', function(e){
      if(e.key === 'Enter' || e.key === ' ' || e.code === 'Space'){
        e.preventDefault();
        abrir('home');
      }
    });
    // ensure pointer cursor via inline style if not present in stylesheet
    headerLogo.style.cursor = 'pointer';
  }
});
</script>
<!-- Module sidebar removed per user request. To re-enable, restore the #module-sidebar and #module-sidebar-toggle elements. -->
<div class="card">
<header>
  <div class="header-left">
  <div class="header-logo" id="header-logo-container" tabindex="0" role="button" title="Ir para Início" aria-label="Ir para Início" onclick="abrir('home')">
  <img id="app-logo" src="LOGO.png" alt="WebLajes" tabindex="0">
      <div style="display:flex;flex-direction:column">
  <div class="brand-title">WebLajes</div>
      </div>
    </div>
  </div>
  <div style="flex:1;display:flex;justify-content:center;align-items:center">
    <h1 id="modulo-atual-titulo" style="margin:0;font-size:28px;color:var(--primario);font-weight:700">Início</h1>
  </div>
  <div style="width:200px"></div>
</header>



<!-- Favorite panel modal: shows favorited item in a modular panel -->
<div id="fav-panel" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;z-index:2200">
  <div style="background:#fff;padding:12px;border-radius:10px;max-width:760px;width:92%;box-shadow:0 18px 60px rgba(0,0,0,0.24);">
    <div style="display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;padding-bottom:8px;margin-bottom:8px">
      <h3 class="fav-panel-title" style="margin:0">Favorito</h3>
      <div><button onclick="closeFavPanel()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button></div>
    </div>
    <div id="fav-panel-content" style="min-height:120px;padding:6px;overflow:auto"></div>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button onclick="closeFavPanel()" class="btn-cancel">Fechar</button>
      <button onclick="favPanelOpen()" class="btn-save">Abrir</button>
    </div>
  </div>
</div>

<script>
// Funções de Favoritos - Declaradas antes do HTML para serem acessíveis via onclick
const KEY_FAVS = 'orc_home_favorites_v1';
function loadFavorites(){ const s = localStorage.getItem(KEY_FAVS); return s?JSON.parse(s):[]; }
function saveFavorites(arr){ localStorage.setItem(KEY_FAVS, JSON.stringify(arr)); }
function isFavorite(key){ const f = loadFavorites(); return f.indexOf(key)!==-1; }
function toggleFavorite(key, btnEl){ 
  console.log('Toggle favorite:', key, 'Button:', btnEl);
  let f = loadFavorites(); 
  console.log('Favoritos atuais:', f);
  const idx=f.indexOf(key); 
  if(idx===-1){ 
    f.push(key); 
    console.log('Adicionando favorito');
  } else { 
    f.splice(idx,1); 
    console.log('Removendo favorito');
  } 
  saveFavorites(f); 
  console.log('Favoritos salvos:', f);
  if(typeof renderFavoritesUI === 'function') renderFavoritesUI(); 
  if(typeof renderFavoritosArea === 'function') renderFavoritosArea();
  if(btnEl){ 
    const isPressed = f.indexOf(key)!==-1;
    btnEl.setAttribute('aria-pressed', isPressed ? 'true' : 'false'); 
    console.log('Botão aria-pressed:', isPressed);
  } 
}

// Função para renderizar a área de favoritos na Home
function renderFavoritosArea(){
  console.log('=== renderFavoritosArea INICIADA ===');
  const favs = loadFavorites();
  console.log('Total de favoritos:', favs.length, 'Lista:', favs);
  
  const area = document.getElementById('favoritos-area');
  const grid = document.getElementById('favoritos-grid');
  
  if(!area) {
    console.error('ERRO: elemento favoritos-area não encontrado!');
    return;
  }
  if(!grid) {
    console.error('ERRO: elemento favoritos-grid não encontrado!');
    return;
  }
  
  console.log('Elementos encontrados com sucesso');
  
  // Filtrar apenas favoritos internos (que contêm ':')
  const favoritosInternos = favs.filter(k => typeof k === 'string' && k.indexOf(':') !== -1);
  console.log('Favoritos internos (com :):', favoritosInternos.length, 'Lista:', favoritosInternos);
  
  if(favoritosInternos.length === 0){
    console.log('Nenhum favorito interno encontrado - ocultando área');
    // hide with fade-out
    area.classList.remove('appear');
    setTimeout(()=>{ area.style.display = 'none'; }, 360);
    return;
  }
  
  console.log('>>> EXIBINDO ÁREA DE FAVORITOS <<<');
  // ensure area is present but start hidden to allow transition
  area.style.display = 'block';
  area.classList.remove('appear');
  // force reflow then add class to trigger transition
  void area.offsetWidth;
  setTimeout(()=> area.classList.add('appear'), 20);
  grid.innerHTML = '';
  
  let cardsAdicionados = 0;
  
  favoritosInternos.forEach(key => {
    console.log('Buscando card para:', key);
    const originalCard = document.querySelector(`[data-fav-key="${key}"]`);
    
    if(!originalCard) {
      console.warn('Card original não encontrado para:', key);
      return;
    }
    
    console.log('Card original encontrado!');
    cardsAdicionados++;
    
    // Extrair informações do card original
    const iconEl = originalCard.querySelector('.icon');
    const titleEl = originalCard.querySelector('.title');
    const subtitleEl = originalCard.querySelector('.subtitle');
    
    const icon = iconEl ? iconEl.textContent : '⭐';
    const title = titleEl ? titleEl.textContent : key;
    const subtitle = subtitleEl ? subtitleEl.textContent : '';
    
    // Criar card favorito
  const card = document.createElement('div');
  card.className = 'module-card fav-module-card';
    card.setAttribute('role', 'button');
    card.setAttribute('tabindex', '0');
    card.setAttribute('aria-label', `Abrir ${title}`);
  card.style.position = 'relative';
    
    // Badge de favorito
    const badge = document.createElement('div');
    badge.style.position = 'absolute';
    badge.style.top = '8px';
    badge.style.right = '8px';
    badge.style.fontSize = '16px';
    badge.textContent = '⭐';
    
    // Conteúdo do card
    const content = document.createElement('div');
    content.style.display = 'flex';
    content.style.alignItems = 'center';
    content.style.gap = '12px';
    
    const iconDiv = document.createElement('div');
    iconDiv.className = 'icon';
    iconDiv.textContent = icon;
    
    const labelDiv = document.createElement('div');
    labelDiv.className = 'label';
    
    const titleDiv = document.createElement('div');
    titleDiv.className = 'title';
    titleDiv.textContent = title;
    
    const subtitleDiv = document.createElement('div');
    subtitleDiv.className = 'subtitle';
    subtitleDiv.textContent = subtitle;
    
    labelDiv.appendChild(titleDiv);
    labelDiv.appendChild(subtitleDiv);
    content.appendChild(iconDiv);
    content.appendChild(labelDiv);
    card.appendChild(badge);
    card.appendChild(content);
    
    // Adicionar evento de click igual ao original
    card.onclick = function(){
      if(originalCard && originalCard.onclick){
        originalCard.onclick();
      }
    };
    
    card.onkeydown = function(event){
      if(event.key === 'Enter' || event.key === ' '){
        event.preventDefault();
        if(originalCard && originalCard.onclick){
          originalCard.onclick();
        }
      }
    };
    
    grid.appendChild(card);
  });
  
  console.log('=== renderFavoritosArea FINALIZADA ===');
  console.log('Total de cards adicionados:', cardsAdicionados);
  console.log('Display da área:', area.style.display);
}
</script>

<!-- ORÇAMENTO -->
<section id="orc" class="section">
<div class="row">
<div class="controls">
<input id="orcamento-nome" placeholder="Nome do orçamento *" required style="padding:6px; flex:1">
<input id="orcamento-vendedor" placeholder="Vendedor responsável" style="padding:6px; flex:1">
<button onclick="salvarOrcamentoAtual()">💾 Salvar Orçamento</button>
<button onclick="novoOrcamento()" class="secondary">+ Novo Orçamento</button>
</div>
</div>
<div class="row">
<div class="controls">
<select id="novo-item-select"></select>
<button onclick="adicionarItemSelecionado()">+ Adicionar Item</button>
<button onclick="limparOrcamento()" class="secondary">Limpar orçamento</button>
</div>
<div style="margin-left:auto" class="floater">
<button onclick="gerarPDF()">📄 Gerar PDF</button>
</div>
</div>
<table class="orcamento-table" id="itens-table">
<thead>
<tr>
<th style="width:12%;">Qtd / Unid.</th>
<th>Descrição</th>
<th style="width:14%;" class="right">Preço Unit.</th>
<th style="width:14%;" class="right">Total</th>
<th style="width:8%;">Desconto</th>
<th style="width:8%;">Valor Desc.</th>
<th style="width:8%;">Ação</th>
</tr>
</thead>
<tbody></tbody>
</table>
<div id="totais-box" class="note"></div>
</section>

<!-- HOME: Painel de módulos -->
<section id="home" class="section active">
  <div class="module-grid" style="margin-top:12px">
  <div class="module-card" data-module="leads" role="button" tabindex="0" aria-label=
"Abrir Leads" onclick="abrir('leads')" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrir('leads'); }">                                       <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">🎯</div>
  <div class="label"><div class="title">Leads</div><div class="subtitle">Gerenciar potenciais clientes</div></div>                                                        </div>
    </div>
    <div class="module-card" data-module="clientes" role="button" tabindex="0" aria-label="Abrir Clientes" onclick="abrir('clientes')" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrir('clientes'); }">                         <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">👥</div>
  <div class="label"><div class="title">Clientes</div><div class="subtitle">Abrir cadastro de clientes</div></div>                                                        </div>
    </div>
  <div class="module-card" data-module="orc" role="button" tabindex="0" aria-label="Abrir Orçamentos" onclick="abrir('orc')" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrir('orc'); }">                                        <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">🧾</div>
  <div class="label"><div class="title">Orçamentos</div><div class="subtitle">Criar e gerenciar orçamentos</div></div>                                                    </div>
    </div>
  <div class="module-card" data-module="vendas" role="button" tabindex="0" aria-label="Abrir Vendas" onclick="abrir('vendas')" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrir('vendas'); }">                                   <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">💳</div>
  <div class="label"><div class="title">Vendas</div><div class="subtitle">Processo de vendas</div></div>                                                                  </div>
    </div>
  <div class="module-card" data-module="producao" role="button" tabindex="0" aria-label="Abrir Produção" onclick="abrir('producao')" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrir('producao'); }">                           <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">🏗️</div>
  <div class="label"><div class="title">Produção</div><div class="subtitle">Acompanhar produção</div></div>                                                               </div>
    </div>
  <div class="module-card" data-module="entrega" role="button" tabindex="0" aria-label="Abrir Entrega" onclick="abrir('entrega')" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrir('entrega'); }">                               <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">🚚</div>
  <div class="label"><div class="title">Entrega</div><div class="subtitle">Gerenciar entregas</div></div>                                                                 </div>
    </div>
  <div class="module-card" data-module="posvendas" role="button" tabindex="0" aria-label="Abrir Pós-Vendas" onclick="abrir('posvendas')" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrir('posvendas'); }">                      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">🔧</div>
  <div class="label"><div class="title">Pós-Vendas</div><div class="subtitle">Suporte pós-venda</div></div>                                                               </div>
    </div>
  <div class="module-card" data-module="configuracoes" role="button" tabindex="0" aria-label="Abrir Configurações" onclick="abrir('configuracoes')" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrir('configuracoes'); }">       <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">⚙️</div>
  <div class="label"><div class="title">Configurações</div><div class="subtitle">Preferências do sistema</div></div>                                                      </div>
    </div>
  <div class="module-card" data-module="relatorios" role="button" tabindex="0" aria-label="Abrir Relatórios" onclick="abrir('relatorios')" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrir('relatorios'); }">                   <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">📊</div>
  <div class="label"><div class="title">Relatórios</div><div class="subtitle">Análises e relatórios</div></div>                                                           </div>
    </div>
  <div class="module-card" data-module="dashboard" role="button" tabindex="0" aria-label="Abrir Dashboard" onclick="abrir('dashboard')" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrir('dashboard'); }">                       <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">📈</div>
  <div class="label"><div class="title">Dashboard</div><div class="subtitle">Visão geral do negócio</div></div>                                                           </div>
    </div>
  </div>
  
  <!-- Área de Favoritos -->
  <div id="favoritos-area" style="margin-top:24px;display:none">
    <div class="fav-header-wrap">
      <h3 class="fav-header">⭐ Meus Favoritos</h3>
      <div class="fav-desc">Acesso rápido aos seus cards mais usados</div>
    </div>
    <div id="favoritos-grid" class="module-grid"></div>
  </div>
</section>

<!-- ======================== MÓDULO LEADS ======================== -->
<section id="leads" class="section">
  <!-- Lead module cards -->
  <div class="lead-module-cards" style="margin:12px 0 18px">
    <div class="module-card lead-card" data-fav-key="leads:novo" role="button" tabindex="0" aria-label="Abrir cadastro de leads" onclick="abrirCadastroLead()" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrirCadastroLead(); }">
      <button class="fav-btn" aria-pressed="false" title="Favoritar" onclick="event.stopPropagation(); toggleFavorite('leads:novo', this)">⭐</button>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">🎯</div>
        <div class="label"><div class="title">Cadastro de Leads</div><div class="subtitle">Registrar novo lead ou abrir formulário rápido</div></div>
      </div>
    </div>
    <div class="module-card lead-card" data-fav-key="leads:list" role="button" tabindex="0" aria-label="Abrir lista de leads" onclick="abrirListaLeads()" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrirListaLeads(); }">
      <button class="fav-btn" aria-pressed="false" title="Favoritar" onclick="event.stopPropagation(); toggleFavorite('leads:list', this)">⭐</button>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">📋</div>
        <div class="label"><div class="title">Lista de Leads</div><div class="subtitle">Ver e gerenciar leads cadastrados</div></div>
      </div>
    </div>
    <div class="module-card lead-card" data-fav-key="leads:buscar" role="button" tabindex="0" aria-label="Buscar lead" onclick="abrirBuscaLead()" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrirBuscaLead(); }">
      <button class="fav-btn" aria-pressed="false" title="Favoritar" onclick="event.stopPropagation(); toggleFavorite('leads:buscar', this)">⭐</button>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">🔍</div>
        <div class="label"><div class="title">Buscar Lead</div><div class="subtitle">Pesquisar por nome, documento, telefone ou endereço</div></div>
      </div>
    </div>
  </div>
  <!-- Formulário de cadastro/edição -->
  <form id="form-lead" autocomplete="off" onsubmit="event.preventDefault();salvarLead();" style="display:none;margin-top:12px">
    <div class="row">
      <div style="flex:1; min-width:200px;">
        <input id="lead-doc" class="lead-input" maxlength="18" placeholder="CPF / CNPJ" oninput="mascaraNumDoc(this)" pattern="[0-9]*" inputmode="numeric">
      </div>
      <div style="flex:2; min-width:200px;">
        <input id="lead-nome" class="lead-input" placeholder="Nome / Razão Social">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <input id="lead-tel1" class="lead-input" placeholder="Telefone 1" maxlength="16" oninput="mascaraTelefone(this)">
      </div>
      <div style="flex:1">
        <input id="lead-tel2" class="lead-input" placeholder="Telefone 2" maxlength="16" oninput="mascaraTelefone(this)">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <input id="lead-email" class="lead-input" type="email" placeholder="Email">
      </div>
      <div style="flex:1">
        <input id="lead-cep" class="lead-input" placeholder="CEP" oninput="mascaraNumCep(this)" onchange="buscarEnderecoLead()">
      </div>
    </div>
    <div class="row">
      <div style="flex:2">
        <input id="lead-logradouro" class="lead-input" placeholder="Rua / Logradouro">
      </div>
      <div style="flex:1">
        <input id="lead-numero" class="lead-input" placeholder="Número">
      </div>
      <div style="flex:1">
        <input id="lead-complemento" class="lead-input" placeholder="Complemento">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <input id="lead-bairro" class="lead-input" placeholder="Bairro">
      </div>
      <div style="flex:1">
        <input id="lead-cidade" class="lead-input" placeholder="Cidade">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <textarea id="lead-observacao" class="lead-textarea" placeholder="Observações"></textarea>
      </div>
      <div style="flex:1">
        <input type="file" id="lead-anexo" multiple>
      </div>
    </div>
    <div class="row actions">
      <button type="submit">💾 Salvar Lead </button>
      <button type="button" onclick="novoLeadForm()">+ Novo</button>
    </div>
  </form>
  <!-- Busca, filtros e ordenação -->
  <div class="row" style="margin-top:12px;align-items:flex-end;">
    <div style="flex:1;min-width:120px;">
      <input id="lead-busca" class="lead-input" placeholder="Buscar nome, doc, tel..." oninput="filtrosLeads.busca=this.value;renderizarListaLeads();">
    </div>
  </div>
  <!-- Tabela de leads -->
  <div id="leads-header" style="margin-top:12px;cursor:pointer;padding:8px 12px;background:#f2f4f7;border-radius:6px;border:1px solid #e0e3e8;display:flex;align-items:center;justify-content:space-between" onclick="toggleLeadsTable()">
    <div style="font-weight:600">Lista de Leads</div>
    <div id="leads-header-icon" style="font-size:12px;opacity:0.7">▸</div>
  </div>
  <table id="tabela-leads" class="catalog-table" style="margin-top:10px" tabindex="0">
    <thead>
      <tr>
  <th><span style="cursor:pointer;user-select:none" onclick="ordenarLeads('nome')">Nome / Razão Social <span id="sort-lead-nome" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></span></th>
  <th><span style="cursor:pointer;user-select:none" onclick="ordenarLeads('doc')">CPF/CNPJ <span id="sort-lead-doc" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></span></th>
  <th><span style="cursor:pointer;user-select:none" onclick="ordenarLeads('telefone1')">Telefone <span id="sort-lead-telefone1" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></span></th>
  <th><span style="cursor:pointer;user-select:none" onclick="ordenarLeads('cidade')">Cidade <span id="sort-lead-cidade" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></span></th>
  <th><span style="cursor:pointer;user-select:none" onclick="ordenarLeads('dataAtualizacao')">Atualização<span id="sort-lead-dataAtualizacao" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></span></th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Modal de Busca de Lead -->
<div id="busca-lead-modal" onclick="if(event.target===this) fecharBuscaLead()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:1200">
  <div style="background:#fff;width:800px;max-width:95%;border-radius:8px;padding:0;box-shadow:0 8px 24px rgba(0,0,0,0.2);position:relative;max-height:calc(100vh - 60px);display:flex;flex-direction:column;">
    <div style="padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee">
      <h3 style="margin:0">🔍 Buscar Lead</h3>
      <button onclick="fecharBuscaLead()" style="background:#f44336;color:#fff;border:none;font-size:20px;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold" onmouseover="this.style.background='#d32f2f'" onmouseout="this.style.background='#f44336'">✕</button>
    </div>
    <div style="padding:16px;border-bottom:1px solid #eee">
      <input id="busca-lead-input" type="text" placeholder="Digite nome, CPF/CNPJ, telefone, email ou endereço..." 
        style="width:100%;padding:12px;font-size:16px;border:2px solid #ddd;border-radius:6px;box-sizing:border-box"
        oninput="realizarBuscaLead()" autofocus>
      <div style="margin-top:8px;font-size:13px;color:#666">
        💡 A busca é feita em tempo real em todos os campos do lead
      </div>
    </div>
    <div id="busca-lead-resultados" style="padding:16px;overflow:auto;flex:1;max-height:500px">
      <div style="color:#999;text-align:center;padding:40px">Digite para buscar leads...</div>
    </div>
  </div>
</div>

<!-- Modal / Painel do Lead -->
<div id="lead-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:1200">
  <div class="lead-modal-content" style="background:#fff;width:1100px;max-width:95%;border-radius:8px;padding:0;box-shadow:0 8px 24px rgba(0,0,0,0.2);position:relative;display:flex;flex-direction:column;max-height:calc(100vh - 60px);">
    <div style="padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;flex:0 0 auto">
      <h3 style="margin:0">Detalhes do Lead</h3>
  <div><button onclick="event.stopPropagation(); fecharPainelLead()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button></div>
    </div>
  <!-- Close icon top-right -->
  <button aria-label="Fechar painel" title="Fechar" onclick="event.stopPropagation(); fecharPainelLead()" onmouseover="this.style.background='#ff4444'; this.style.color='#fff'" onmouseout="this.style.background='#f44336'; this.style.color='#fff'" style="position:absolute;top:8px;right:8px;background:#f44336;border:2px solid #fff;color:#fff;font-size:22px;font-weight:bold;cursor:pointer;padding:4px;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1301">✕</button>
  <div class="lead-modal-body" style="padding:16px;overflow:auto;flex:1 1 auto">
  <div class="lead-modal-columns" style="display:flex;gap:12px">
  <!-- Área 1: Dados editáveis (wrapper grey) -->
  <div class="lead-modal-left" style="flex:1">
        <div style="background:#fafafa;padding:12px;border-radius:6px;border:1px solid #eee">
          <h4 style="margin-top:0;text-align:center;color:#333;font-weight:700;padding-bottom:8px;border-bottom:1px solid #dcdcdc">Dados do Lead</h4>
        <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Nome:</label><input id="painel-lead-nome" style="flex:1"></div>
    <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">CPF/CNPJ:</label><input id="painel-lead-doc" style="flex:1" maxlength="18" oninput="mascaraNumDoc(this)" onblur="validarDocModalLead()" pattern="[0-9]*" inputmode="numeric" placeholder="Somente números"></div>
  <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Tel 1:</label><input id="painel-lead-tel1" style="flex:1" oninput="mascaraTelefone(this)" onblur="validarTelModalLead(1)" maxlength="16"></div>
  <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Tel 2:</label><input id="painel-lead-tel2" style="flex:1" oninput="mascaraTelefone(this)" onblur="validarTelModalLead(2)" maxlength="16"></div>
  <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Email:</label><input id="painel-lead-email" style="flex:1" type="email" placeholder="exemplo@dominio.com"></div>
  <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">CEP:</label><input id="painel-lead-cep" style="flex:1" maxlength="8" oninput="mascaraNumCep(this); if(this.value.replace(/\D/g,'').length===8) buscarEnderecoModalLead(true);" onchange="buscarEnderecoModalLead(true)"></div>
        <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Rua:</label><input id="painel-lead-logradouro" style="flex:1"></div>
        <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Número:</label><input id="painel-lead-numero" style="width:120px"><label style="width:90px">Complemento:</label><input id="painel-lead-complemento" style="flex:1"></div>
        <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Bairro:</label><input id="painel-lead-bairro" style="flex:1"><label style="width:90px">Cidade:</label><input id="painel-lead-cidade" style="width:160px"></div>
        <hr style="margin:10px 0">
        <div style="margin-top:6px;margin-bottom:6px">
          <div style="background:#f0f0f2;padding:8px;border-radius:6px;border:1px solid #e6e6e6">
            <div style="margin-bottom:8px;text-align:center;color:#333;font-weight:700;padding-bottom:6px;border-bottom:1px solid #e0e0e0">Anexos</div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
              <input type="file" id="painel-lead-anexo" multiple style="display:none" onchange="adicionarAnexosModalLead()">
              <label for="painel-lead-anexo" style="cursor:pointer;display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:#2b76d2;color:#fff;border-radius:6px;font-weight:600;border:1px solid rgba(0,0,0,0.08)">📎 Anexar arquivos</label>
              <small style="color:#666;margin-left:8px">PNG, JPG, PDF — clique para selecionar</small>
            </div>
            <div id="painel-lead-anexos" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          </div>
        </div>
        <hr style="margin:10px 0">
        <div style="background:#f5f5f7;padding:10px;border-radius:6px;margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <div style="text-align:center;color:#333;font-weight:700;padding-bottom:8px;border-bottom:1px solid #dcdcdc;margin-bottom:8px">Cadastro de Observações</div>
          <div>
            <textarea id="painel-lead-observacao" class="lead-textarea" style="height:80px;width:100%"></textarea>
          </div>
          <div style="display:flex;justify-content:flex-start;margin-top:6px">
            <button data-preserve="true" onclick="adicionarObservacaoModalLead()">Adicionar observação</button>
          </div>
            <div style="margin-top:4px">
            <div style="font-weight:600;margin-bottom:6px">Histórico de Observações</div>
            <div style="overflow:auto;max-height:180px;border:1px solid #eee;border-radius:6px">
              <table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr>
                <th style="padding:6px;border-bottom:1px solid #eee;cursor:pointer" onclick="ordenarObservacoesLead('texto')">Observação <span id="sort-obs-lead-texto" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></th>
                <th style="padding:6px;border-bottom:1px solid #eee;cursor:pointer" onclick="ordenarObservacoesLead('data')">Data / Hora <span id="sort-obs-lead-data" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></th>
                <th style="padding:6px;border-bottom:1px solid #eee;cursor:pointer" onclick="ordenarObservacoesLead('usuario')">Usuário <span id="sort-obs-lead-usuario" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></th>
              </tr></thead><tbody id="painel-observacoes-lead-tbody"></tbody></table>
            </div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
            <button id="painel-lead-salvar" data-preserve="true" type="button" onclick="salvarPainelLead()">Salvar</button>
            <button id="painel-lead-cancelar" data-preserve="true" type="button" onclick="fecharPainelLead()">Cancelar</button>
          </div>
        </div>
  </div>
      </div>
      <!-- Área 2/3/4: Espaços destacados -->
      <div class="lead-modal-right painel-right" style="width:420px;display:flex;flex-direction:column;gap:10px">
        <div id="painel-lead-orcamentos" style="flex:1;border:1px solid #eee;padding:10px;border-radius:6px;background:#fbfbff" class="painel-right">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong class="panel-heading">Orçamentos em aberto</strong>
            <button id="painel-lead-novo-orc" onclick="criarNovoOrcamentoLead()" style="padding:6px 12px;font-size:13px;background:#2b76d2;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">+ Novo Orçamento</button>
          </div>
        </div>
        <div id="painel-lead-pedidos" style="flex:1;border:1px solid #eee;padding:10px;border-radius:6px;background:#fffaf0" class="painel-right">
          <strong class="panel-heading">Pedidos em aberto</strong>
        </div>
        <div id="painel-lead-historico" style="flex:1;border:1px solid #eee;padding:10px;border-radius:6px;background:#f6fff6" class="painel-right">
          <strong class="panel-heading">Histórico de pedidos</strong>
        </div>
        </div>
        <div id="lead-modal-footer" style="padding:10px 18px;border-top:1px solid #e6e6e6;flex:0 0 auto;display:flex;justify-content:center;gap:12px;position:sticky;bottom:0;background:linear-gradient(180deg, rgba(255,255,255,0.95), #fff);box-shadow:0 -6px 18px rgba(0,0,0,0.06);border-radius:0 0 8px 8px">
        </div>
      </div>
    </div>
  </div>
</div>
<!-- ======================== FIM MÓDULO LEADS ======================== -->

<section id="vendas" class="section">
  <h3>Vendas</h3>
  <div class="note">Módulo de Vendas em construção.</div>
</section>
<section id="producao" class="section">
  <h3>Produção</h3>
  <div class="note">Módulo de Produção em construção.</div>
</section>
<section id="entrega" class="section">
  <h3>Entrega</h3>
  <div class="note">Módulo de Entrega em construção.</div>
</section>
<section id="posvendas" class="section">
  <h3>Pós-Vendas</h3>
  <div class="note">Módulo de Pós-Vendas em construção.</div>
</section>
<section id="configuracoes" class="section">
  <h3>Configurações</h3>
  <div class="note">Módulo de Configurações em construção.</div>
  <div style="margin-top:12px" class="module-grid">
    <div class="module-card" role="button" tabindex="0" aria-label="Tabelas Auxiliares" onclick="abrirTabelasAuxiliares()" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrirTabelasAuxiliares(); }">
      <div class="icon">🧾</div>
      <div class="label"><div class="title">Tabelas Auxiliares</div><div class="subtitle">Dados auxiliares do sistema</div></div>
    </div>
  </div>

  <!-- Tabelas Auxiliares area (hidden by default) -->
  <div id="tabelas-auxiliares" style="margin-top:12px;display:none">
    <h4 style="margin-top:0">Tabelas Auxiliares</h4>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <div class="module-card" style="min-width:220px;cursor:default">
        <div class="icon">🔖</div>
        <div class="label"><div class="title">Status dos Leads</div><div class="subtitle">Criar / editar / excluir status</div></div>
        <div style="margin-top:8px"><button onclick="abrirStatusLeads()">Gerenciar</button></div>
      </div>
      <div class="module-card" style="min-width:220px;cursor:default">
        <div class="icon">📦</div>
        <div class="label"><div class="title">Catálogo de Produtos</div><div class="subtitle">Gerenciar produtos disponíveis</div></div>
        <div style="margin-top:8px"><button onclick="abrirCatalogoProdutos()">Gerenciar</button></div>
      </div>
    </div>
  </div>
</section>
<section id="relatorios" class="section">
  <h3>Relatórios</h3>
  <div class="note">Módulo de Relatórios em construção.</div>
</section>
<section id="dashboard" class="section">
  <h3>Dashboard</h3>
  <div style="margin-top:12px" id="dashboard-grid" class="module-grid">
    <div class="module-card dashboard-card" id="db-clientes" role="button" tabindex="0" aria-label="Clientes">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">👥</div>
        <div class="label"><div class="title">Clientes</div><div class="subtitle"><span id="db-clientes-count">0</span> registrados</div></div>
      </div>
    </div>
    <div class="module-card dashboard-card" id="db-orcamentos" role="button" tabindex="0" aria-label="Orçamentos">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">🧾</div>
        <div class="label"><div class="title">Orçamentos</div><div class="subtitle"><span id="db-orcamentos-count">0</span> salvos</div></div>
      </div>
    </div>
    <div class="module-card dashboard-card" id="db-produtos" role="button" tabindex="0" aria-label="Produtos">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">📦</div>
        <div class="label"><div class="title">Produtos</div><div class="subtitle"><span id="db-produtos-count">0</span> itens</div></div>
      </div>
    </div>
    <div class="module-card dashboard-card" id="db-anexos" role="button" tabindex="0" aria-label="Anexos">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">📎</div>
        <div class="label"><div class="title">Anexos</div><div class="subtitle"><span id="db-anexos-count">0</span> arquivos</div></div>
      </div>
    </div>
    <div class="module-card dashboard-card" id="db-leads" role="button" tabindex="0" aria-label="Leads">
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">📋</div>
        <div class="label"><div class="title">Leads</div><div class="subtitle"><span id="db-leads-count">0</span> cadastrados</div>
          <div id="db-leads-statuses" style="margin-top:6px;font-size:13px;opacity:0.9"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- ORÇAMENTOS SALVOS -->
<section id="salvos" class="section">
<h3>Orçamentos Realizados</h3>
<div id="lista-orcamentos-salvos"></div>
<div class="note">
Clique em "Carregar" para editar ou "Excluir" para remover permanentemente.
</div>
</section>

<!-- CLIENTES -->
<section id="clientes" class="section">
  <!-- Client module cards -->
  <div class="client-module-cards" style="margin:12px 0 18px">
    <div class="module-card client-card" data-fav-key="clientes:novo" role="button" tabindex="0" aria-label="Abrir cadastro de clientes" onclick="abrirCadastroCliente()" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrirCadastroCliente(); }">
      <button class="fav-btn" aria-pressed="false" title="Favoritar" onclick="event.stopPropagation(); toggleFavorite('clientes:novo', this)">⭐</button>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">👤</div>
        <div class="label"><div class="title">Cadastro de Clientes</div><div class="subtitle">Registrar novo cliente ou abrir formulário rápido</div></div>
      </div>
    </div>
    <div class="module-card client-card" data-fav-key="clientes:list" role="button" tabindex="0" aria-label="Abrir lista de clientes" onclick="abrirListaClientes()" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrirListaClientes(); }">
      <button class="fav-btn" aria-pressed="false" title="Favoritar" onclick="event.stopPropagation(); toggleFavorite('clientes:list', this)">⭐</button>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">📋</div>
        <div class="label"><div class="title">Lista de Clientes</div><div class="subtitle">Ver e gerenciar clientes cadastrados</div></div>
      </div>
    </div>
    <div class="module-card client-card" data-fav-key="clientes:buscar" role="button" tabindex="0" aria-label="Buscar cliente" onclick="abrirBuscaCliente()" onkeydown="if(event.key==='Enter'||event.key===' '){ event.preventDefault(); abrirBuscaCliente(); }">
      <button class="fav-btn" aria-pressed="false" title="Favoritar" onclick="event.stopPropagation(); toggleFavorite('clientes:buscar', this)">⭐</button>
      <div style="display:flex;align-items:center;gap:12px;">
        <div class="icon">🔍</div>
        <div class="label"><div class="title">Buscar Cliente</div><div class="subtitle">Pesquisar por nome, documento, telefone ou endereço</div></div>
      </div>
    </div>
  </div>
  <!-- Formulário de cadastro/edição -->
  <form id="form-cliente" autocomplete="off" onsubmit="event.preventDefault();salvarCliente();" style="display:none;margin-top:12px">
    <div class="row">
      <div style="flex:1; min-width:200px;">
        <input id="cliente-doc" class="cliente-input" maxlength="18" placeholder="CPF / CNPJ" oninput="mascaraNumDoc(this)" pattern="[0-9]*" inputmode="numeric">
      </div>
      <div style="flex:2; min-width:200px;">
        <input id="cliente-nome" class="cliente-input" placeholder="Nome / Razão Social *" required>
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <input id="cliente-tel1" class="cliente-input" placeholder="Telefone 1 *" required maxlength="16" oninput="mascaraTelefone(this)">
      </div>
      <div style="flex:1">
        <input id="cliente-tel2" class="cliente-input" placeholder="Telefone 2" maxlength="16" oninput="mascaraTelefone(this)">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <input id="cliente-cep" class="cliente-input" placeholder="CEP *" required oninput="mascaraNumCep(this)" onchange="buscarEndereco()">
      </div>
      <div style="flex:2">
        <input id="cliente-logradouro" class="cliente-input" placeholder="Rua / Logradouro">
      </div>
      <div style="flex:1">
        <input id="cliente-numero" class="cliente-input" placeholder="Número">
      </div>
      <div style="flex:1">
        <input id="cliente-complemento" class="cliente-input" placeholder="Complemento">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <input id="cliente-bairro" class="cliente-input" placeholder="Bairro">
      </div>
      <div style="flex:1">
        <input id="cliente-cidade" class="cliente-input" placeholder="Cidade">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <textarea id="cliente-observacao" class="cliente-textarea" placeholder="Observações"></textarea>
      </div>
      <div style="flex:1">
        <input type="file" id="cliente-anexo" multiple>
      </div>
    </div>
    <div class="row actions">
      <button type="submit">💾 Salvar Cliente </button>
      <button type="button" onclick="novoClienteForm()">+ Novo</button>
    </div>
  </form>
  <!-- Busca, filtros e ordenação -->
  <div class="row" style="margin-top:12px;align-items:flex-end;">
    <div style="flex:1;min-width:120px;">
      <input id="cliente-busca" class="cliente-input" placeholder="Buscar nome, doc, tel..." oninput="filtrosClientes.busca=this.value;renderizarListaClientes();">
    </div>
    <!-- Filtro de status removido -->
    <!-- Botões de ordenação removidos -->
  </div>
  <!-- Tabela de clientes/leads -->
  <div id="clientes-header" style="margin-top:12px;cursor:pointer;padding:8px 12px;background:#f2f4f7;border-radius:6px;border:1px solid #e0e3e8;display:flex;align-items:center;justify-content:space-between" onclick="toggleClientesTable()">
    <div style="font-weight:600">Lista de Clientes</div>
    <div id="clientes-header-icon" style="font-size:12px;opacity:0.7">▸</div>
  </div>
  <table id="tabela-clientes" class="catalog-table" style="margin-top:10px" tabindex="0">
    <thead>
      <tr>
  <th><span style="cursor:pointer;user-select:none" onclick="ordenarClientes('nome')">Nome / Razão Social <span id="sort-nome" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></span></th>
  <th><span style="cursor:pointer;user-select:none" onclick="ordenarClientes('doc')">CPF/CNPJ <span id="sort-doc" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></span></th>
  <th><span style="cursor:pointer;user-select:none" onclick="ordenarClientes('telefone1')">Telefone <span id="sort-telefone1" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></span></th>
  <th><span style="cursor:pointer;user-select:none" onclick="ordenarClientes('cidade')">Cidade <span id="sort-cidade" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></span></th>
  <!-- Colunas Status, Anexos e Cadastro removidas -->
  <th><span style="cursor:pointer;user-select:none" onclick="ordenarClientes('dataAtualizacao')">Atualização<span id="sort-dataAtualizacao" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></span></th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Modal de Busca de Cliente -->
<div id="busca-cliente-modal" onclick="if(event.target===this) fecharBuscaCliente()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:1200">
  <div style="background:#fff;width:800px;max-width:95%;border-radius:8px;padding:0;box-shadow:0 8px 24px rgba(0,0,0,0.2);position:relative;max-height:calc(100vh - 60px);display:flex;flex-direction:column;">
    <div style="padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee">
      <h3 style="margin:0">🔍 Buscar Cliente</h3>
      <button onclick="fecharBuscaCliente()" style="background:#f44336;color:#fff;border:none;font-size:20px;cursor:pointer;width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold" onmouseover="this.style.background='#d32f2f'" onmouseout="this.style.background='#f44336'">✕</button>
    </div>
    <div style="padding:16px;border-bottom:1px solid #eee">
      <input id="busca-cliente-input" type="text" placeholder="Digite nome, CPF/CNPJ, telefone, email ou endereço..." 
        style="width:100%;padding:12px;font-size:16px;border:2px solid #ddd;border-radius:6px;box-sizing:border-box"
        oninput="realizarBuscaCliente()" autofocus>
      <div style="margin-top:8px;font-size:13px;color:#666">
        💡 A busca é feita em tempo real em todos os campos do cliente
      </div>
    </div>
    <div id="busca-cliente-resultados" style="padding:16px;overflow:auto;flex:1;max-height:500px">
      <div style="color:#999;text-align:center;padding:40px">Digite para buscar clientes...</div>
    </div>
  </div>
</div>

<!-- Modal / Painel do Cliente -->
<div id="cliente-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:1200">
  <div class="cliente-modal-content" style="background:#fff;width:1100px;max-width:95%;border-radius:8px;padding:0;box-shadow:0 8px 24px rgba(0,0,0,0.2);position:relative;display:flex;flex-direction:column;max-height:calc(100vh - 60px);">
    <div style="padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;flex:0 0 auto">
      <h3 style="margin:0">Detalhes do Cliente</h3>
  <div><button onclick="event.stopPropagation(); fecharPainelCliente()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button></div>
    </div>
  <!-- Close icon top-right -->
  <button aria-label="Fechar painel" title="Fechar" onclick="event.stopPropagation(); fecharPainelCliente()" onmouseover="this.style.background='#ff4444'; this.style.color='#fff'" onmouseout="this.style.background='#f44336'; this.style.color='#fff'" style="position:absolute;top:8px;right:8px;background:#f44336;border:2px solid #fff;color:#fff;font-size:22px;font-weight:bold;cursor:pointer;padding:4px;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1301">✕</button>
  <div class="cliente-modal-body" style="padding:16px;overflow:auto;flex:1 1 auto">
  <div class="cliente-modal-columns" style="display:flex;gap:12px">
  <!-- Área 1: Dados editáveis (wrapper grey) -->
  <div class="cliente-modal-left" style="flex:1">
        <div style="background:#fafafa;padding:12px;border-radius:6px;border:1px solid #eee">
          <h4 style="margin-top:0;text-align:center;color:#333;font-weight:700;padding-bottom:8px;border-bottom:1px solid #dcdcdc">Dados do Cliente</h4>
        <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Nome:</label><input id="painel-cliente-nome" style="flex:1"></div>
    <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">CPF/CNPJ:</label><input id="painel-cliente-doc" style="flex:1" maxlength="18" oninput="mascaraNumDoc(this)" onblur="validarDocModal()" pattern="[0-9]*" inputmode="numeric" placeholder="Somente números"></div>
  <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Tel 1:</label><input id="painel-cliente-tel1" style="flex:1" oninput="mascaraTelefone(this)" onblur="validarTelModal(1)" maxlength="16" required></div>
  <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Tel 2:</label><input id="painel-cliente-tel2" style="flex:1" oninput="mascaraTelefone(this)" onblur="validarTelModal(2)" maxlength="16"></div>
  <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Email:</label><input id="painel-cliente-email" style="flex:1" type="email" placeholder="exemplo@dominio.com"></div>
  <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">CEP:</label><input id="painel-cliente-cep" style="flex:1" maxlength="8" oninput="mascaraNumCep(this); if(this.value.replace(/\D/g,'').length===8) buscarEnderecoModal(true);" onchange="buscarEnderecoModal(true)" required></div>
        <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Rua:</label><input id="painel-cliente-logradouro" style="flex:1"></div>
        <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Número:</label><input id="painel-cliente-numero" style="width:120px"><label style="width:90px">Complemento:</label><input id="painel-cliente-complemento" style="flex:1"></div>
        <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Bairro:</label><input id="painel-cliente-bairro" style="flex:1"><label style="width:90px">Cidade:</label><input id="painel-cliente-cidade" style="width:160px"></div>
        <hr style="margin:10px 0">
        <div style="margin-top:6px;margin-bottom:6px">
          <div style="background:#f0f0f2;padding:8px;border-radius:6px;border:1px solid #e6e6e6">
            <div style="margin-bottom:8px;text-align:center;color:#333;font-weight:700;padding-bottom:6px;border-bottom:1px solid #e0e0e0">Anexos</div>
            <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
              <!-- hidden native input; triggered by the styled label below -->
              <input type="file" id="painel-cliente-anexo" multiple style="display:none" onchange="adicionarAnexosModal()">
              <label for="painel-cliente-anexo" style="cursor:pointer;display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:#2b76d2;color:#fff;border-radius:6px;font-weight:600;border:1px solid rgba(0,0,0,0.08)">📎 Anexar arquivos</label>
              <small style="color:#666;margin-left:8px">PNG, JPG, PDF — clique para selecionar</small>
            </div>
            <div id="painel-cliente-anexos" style="display:flex;flex-wrap:wrap;gap:8px"></div>
          </div>
        </div>
        <hr style="margin:10px 0">
        <div style="background:#f5f5f7;padding:10px;border-radius:6px;margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <div style="text-align:center;color:#333;font-weight:700;padding-bottom:8px;border-bottom:1px solid #dcdcdc;margin-bottom:8px">Cadastro de Observações</div>
          <!-- main free-text observation (now grouped) -->
          <div>
            <textarea id="painel-cliente-observacao" class="cliente-textarea" style="height:80px;width:100%"></textarea>
          </div>
          <!-- Adicionar observação button right below textarea -->
          <div style="display:flex;justify-content:flex-start;margin-top:6px">
            <button data-preserve="true" onclick="adicionarObservacaoModal()">Adicionar observação</button>
          </div>
            <div style="margin-top:4px">
            <div style="font-weight:600;margin-bottom:6px">Histórico de Observações</div>
            <div style="overflow:auto;max-height:180px;border:1px solid #eee;border-radius:6px">
              <table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr>
                <th style="padding:6px;border-bottom:1px solid #eee;cursor:pointer" onclick="ordenarObservacoes('texto')">Observação <span id="sort-obs-texto" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></th>
                <th style="padding:6px;border-bottom:1px solid #eee;cursor:pointer" onclick="ordenarObservacoes('data')">Data / Hora <span id="sort-obs-data" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></th>
                <th style="padding:6px;border-bottom:1px solid #eee;cursor:pointer" onclick="ordenarObservacoes('usuario')">Usuário <span id="sort-obs-usuario" style="font-size:12px;opacity:0.7;margin-left:6px">↕</span></th>
              </tr></thead><tbody id="painel-observacoes-tbody"></tbody></table>
            </div>
          </div>
          <!-- Save/Cancel buttons below observations table -->
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
            <button id="painel-cliente-salvar" data-preserve="true" type="button" onclick="salvarPainelCliente()">Salvar</button>
            <button id="painel-cliente-cancelar" data-preserve="true" type="button" onclick="fecharPainelCliente()">Cancelar</button>
          </div>
        </div>
  </div>
      </div>
      <!-- Área 2/3/4: Espaços destacados -->
      <div class="cliente-modal-right painel-right" style="width:420px;display:flex;flex-direction:column;gap:10px">
        <div id="painel-orcamentos" style="flex:1;border:1px solid #eee;padding:10px;border-radius:6px;background:#fbfbff" class="painel-right">
          <strong class="panel-heading">Orçamentos em aberto</strong>
        </div>
        <div id="painel-pedidos" style="flex:1;border:1px solid #eee;padding:10px;border-radius:6px;background:#fffaf0" class="painel-right">
          <strong class="panel-heading">Pedidos em aberto</strong>
        </div>
        <div id="painel-historico" style="flex:1;border:1px solid #eee;padding:10px;border-radius:6px;background:#f6fff6" class="painel-right">
          <strong class="panel-heading">Histórico de pedidos</strong>
        </div>
        </div>
        <div id="cliente-modal-footer" style="padding:10px 18px;border-top:1px solid #e6e6e6;flex:0 0 auto;display:flex;justify-content:center;gap:12px;position:sticky;bottom:0;background:linear-gradient(180deg, rgba(255,255,255,0.95), #fff);box-shadow:0 -6px 18px rgba(0,0,0,0.06);border-radius:0 0 8px 8px">
        </div>
      </div>
    </div>
  </div>

        <!-- Overlay para anexo-slide -->
        <div id="anexo-slide-overlay" onclick="fecharAnexoSlide()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:1299;cursor:pointer"></div>
        
        <!-- Slide-in viewer para anexos -->
        <div id="anexo-slide" style="position:fixed;right:0;top:0;bottom:0;width:600px;background:#fff;box-shadow:-8px 0 24px rgba(0,0,0,0.2);z-index:1300;transform:translateX(110%);transition:transform .25s ease;overflow:auto;">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;border-bottom:1px solid #eee">
            <strong id="anexo-slide-title">Anexo</strong>
            <button onclick="fecharAnexoSlide()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button>
          </div>
          <div id="anexo-slide-body" style="padding:12px"></div>
          <div id="anexo-slide-actions" style="padding:12px;border-top:1px solid #eee"></div>
        </div>
</div>

<!-- Modal de Orçamento -->
<div id="orcamento-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:1200">
  <div class="orcamento-modal-content" style="background:#fff;width:1200px;max-width:95%;border-radius:8px;padding:0;box-shadow:0 8px 24px rgba(0,0,0,0.2);position:relative;display:flex;flex-direction:column;max-height:calc(100vh - 60px);">
    <div style="padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;flex:0 0 auto">
      <h3 style="margin:0">Novo Orçamento</h3>
  <div><button onclick="event.stopPropagation(); fecharPainelOrcamento()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button></div>
    </div>
  <!-- Close icon top-right -->
  <button aria-label="Fechar painel" title="Fechar" onclick="event.stopPropagation(); fecharPainelOrcamento()" onmouseover="this.style.background='#ff4444'; this.style.color='#fff'" onmouseout="this.style.background='#f44336'; this.style.color='#fff'" style="position:absolute;top:8px;right:8px;background:#f44336;border:2px solid #fff;color:#fff;font-size:22px;font-weight:bold;cursor:pointer;padding:4px;border-radius:50%;width:40px;height:40px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1301">✕</button>
    <div class="orcamento-modal-body" style="padding:16px;overflow:auto;flex:1 1 auto">
      <div style="background:#fafafa;padding:16px;border-radius:6px;border:1px solid #eee">
        <!-- Informações básicas do orçamento -->
        <div style="display:flex;gap:12px;margin-bottom:16px">
          <div style="flex:1">
            <label style="display:block;margin-bottom:4px;font-weight:600">Nome do orçamento *</label>
            <input id="painel-orcamento-nome" placeholder="Nome do orçamento" required style="width:100%;padding:8px">
          </div>
          <div style="flex:1">
            <label style="display:block;margin-bottom:4px;font-weight:600">Vendedor responsável</label>
            <input id="painel-orcamento-vendedor" placeholder="Vendedor responsável" style="width:100%;padding:8px">
          </div>
          <div style="width:150px">
            <label style="display:block;margin-bottom:4px;font-weight:600">Código</label>
            <input id="painel-orcamento-codigo" readonly style="width:100%;padding:8px;background:#f0f0f0;cursor:not-allowed">
          </div>
        </div>

        <!-- Adicionar itens -->
        <div style="margin-bottom:16px;padding-top:12px;border-top:1px solid #ddd">
          <label style="display:block;margin-bottom:8px;font-weight:600">Adicionar item ao orçamento</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="painel-novo-item-select" style="flex:1;padding:8px"></select>
            <button onclick="adicionarItemSelecionadoModal()">+ Adicionar Item</button>
            <button onclick="limparOrcamentoModal()" class="secondary">Limpar orçamento</button>
          </div>
        </div>

        <!-- Tabela de itens -->
        <div style="margin-bottom:16px">
          <table class="orcamento-table" id="painel-itens-table" style="width:100%">
            <thead>
              <tr>
                <th style="width:12%;">Qtd / Unid.</th>
                <th>Descrição</th>
                <th style="width:14%;" class="right">Preço Unit.</th>
                <th style="width:14%;" class="right">Total</th>
                <th style="width:8%;">Desconto</th>
                <th style="width:8%;">Valor Desc.</th>
                <th style="width:8%;">Ação</th>
              </tr>
            </thead>
            <tbody id="painel-itens-tbody"></tbody>
          </table>
        </div>

        <!-- Totais -->
        <div id="painel-totais-box" class="note" style="margin-top:12px"></div>

        <!-- Botões de ação -->
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;padding-top:12px;border-top:1px solid #ddd">
          <button onclick="gerarPDFModal()">📄 Gerar PDF</button>
          <button onclick="salvarOrcamentoModal()">💾 Salvar Orçamento</button>
          <button onclick="fecharPainelOrcamento()" class="secondary">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Catálogo de Produtos -->
<div id="catalogo-produtos-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;z-index:1200">
  <div style="background:#fff;width:1000px;max-width:95%;border-radius:8px;padding:0;box-shadow:0 8px 24px rgba(0,0,0,0.2);position:relative;display:flex;flex-direction:column;max-height:calc(100vh - 60px);">
    <div style="padding:16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #eee;flex:0 0 auto">
      <h3 style="margin:0">Catálogo de Produtos</h3>
      <div><button onclick="fecharCatalogoProdutos()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button></div>
    </div>
    <div style="padding:16px;overflow:auto;flex:1 1 auto">
      <div style="background:#fafafa;padding:16px;border-radius:6px;border:1px solid #eee">
        
        <!-- Formulário de adicionar/editar produto -->
        <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid #ddd">
          <h4 style="margin-top:0;margin-bottom:12px">Adicionar/Editar Produto</h4>
          <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:8px;margin-bottom:8px">
            <input id="cat-modal-desc" placeholder="Descrição do produto *" required style="padding:8px">
            <input id="cat-modal-unit" placeholder="Unidade" style="padding:8px">
            <input id="cat-modal-price" type="number" step="0.01" placeholder="Preço *" required style="padding:8px">
            <input id="cat-modal-discount" type="number" step="0.01" placeholder="% Desc." style="padding:8px">
          </div>
          <div style="display:flex;gap:8px">
            <button id="cat-modal-add-btn" onclick="adicionarProdutoCatalogo()">+ Adicionar Produto</button>
            <button id="cat-modal-cancel-btn" onclick="cancelarEdicaoProduto()" class="secondary" style="display:none">Cancelar</button>
          </div>
        </div>

        <!-- Tabela de produtos -->
        <div style="overflow:auto;max-height:400px">
          <table style="width:100%;border-collapse:collapse">
            <thead>
              <tr style="background:#f0f0f0;position:sticky;top:0">
                <th style="padding:10px;text-align:left;border-bottom:2px solid #ddd">Descrição</th>
                <th style="padding:10px;text-align:left;border-bottom:2px solid #ddd;width:100px">Unidade</th>
                <th style="padding:10px;text-align:right;border-bottom:2px solid #ddd;width:120px">Preço</th>
                <th style="padding:10px;text-align:center;border-bottom:2px solid #ddd;width:100px">% Desconto</th>
                <th style="padding:10px;text-align:center;border-bottom:2px solid #ddd;width:150px">Ações</th>
              </tr>
            </thead>
            <tbody id="catalogo-produtos-tbody">
              <!-- Produtos serão renderizados aqui -->
            </tbody>
          </table>
        </div>

        <!-- Rodapé com total de produtos -->
        <div style="margin-top:16px;padding-top:12px;border-top:1px solid #ddd;display:flex;justify-content:space-between;align-items:center">
          <div style="color:#666;font-size:14px">
            Total de produtos: <strong id="total-produtos-count">0</strong>
          </div>
          <button onclick="fecharCatalogoProdutos()">Fechar</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function toggleClientesTable(){
  const tbl = document.getElementById('tabela-clientes');
  const icon = document.getElementById('clientes-header-icon');
  if(!tbl) return;
  if(tbl.style.display==='none'){
    tbl.style.display='table';
    icon.textContent='▾';
  } else {
    tbl.style.display='none';
    icon.textContent='▸';
  }
}
function toggleLeadsTable(){
  const tbl = document.getElementById('tabela-leads');
  const icon = document.getElementById('leads-header-icon');
  if(!tbl) return;
  if(tbl.style.display==='none'){ tbl.style.display='table'; icon.textContent='▾'; }
  else { tbl.style.display='none'; icon.textContent='▸'; }
}
// Inicializa com tabela visível (se quiser começar recolhido, troque para 'none')
document.addEventListener('DOMContentLoaded', ()=>{ const t=document.getElementById('tabela-clientes'); if(t) t.style.display='none'; if(typeof updateSortIcons==='function') updateSortIcons(); const tl=document.getElementById('tabela-leads'); if(tl) tl.style.display='none'; if(typeof updateSortIconsLeads==='function') updateSortIconsLeads(); });
// Abrir lista de clientes automaticamente quando o usuário começa a digitar na busca
document.addEventListener('DOMContentLoaded', ()=>{
  const busca = document.getElementById('cliente-busca');
  if(!busca) return;
  let timer = null;
  busca.addEventListener('input', (e)=>{
    // se tiver texto, abrir a lista e renderizar; se vazio, fechar a tabela (debounce)
    clearTimeout(timer);
    timer = setTimeout(()=>{
      const val = (e.target.value||'').trim();
      try{
        if(val.length>0){
          abrirListaClientes();
        } else {
          // esconder tabela e atualizar ícone
          const tb = document.getElementById('tabela-clientes');
          const icon = document.getElementById('clientes-header-icon');
          if(tb) tb.style.display = 'none';
          if(icon) icon.textContent = '▸';
        }
      }catch(err){ console.warn('abrirListaClientes failed', err); }
    }, 200);
  });
  // Clear field error for CPF/CNPJ in modal when user starts typing
  const painelDoc = document.getElementById('painel-cliente-doc');
  if(painelDoc){ painelDoc.addEventListener('input', ()=>{ clearFieldError(painelDoc); }); }
});
</script>
</div>
<div id="toast" style="display:none;" class="toast"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// ... O mesmo JavaScript da versão anterior, NADA foi modificado nos scripts. ...
// Copie daqui para baixo o mesmo JS da resposta anterior; ele permanece 100% igual

function mascaraNumDoc(el){
    el.value = el.value.replace(/\D/g,"").slice(0,14);
}
function mascaraNumCep(el){
    el.value = el.value.replace(/[^\d]/g,'').slice(0,8);
}
function validarCPF(cpf) {
    cpf = cpf.replace(/[^\d]+/g,'');
    if(cpf.length!=11 || /^(\d)\1{10}$/.test(cpf)) return false;
    let soma=0, resto; for(let i=1;i<=9;i++) soma+=parseInt(cpf.substring(i-1,i))*(11-i);
    resto=(soma*10)%11; if(resto===10||resto===11)resto=0;
    if(resto!==parseInt(cpf.substring(9,10))) return false;
    soma=0; for(let i=1;i<=10;i++) soma+=parseInt(cpf.substring(i-1,i))*(12-i);
    resto=(soma*10)%11; if(resto===10||resto===11)resto=0;
    if(resto!==parseInt(cpf.substring(10,11))) return false;
    return true;
}
function validarCNPJ(cnpj) {
    cnpj = cnpj.replace(/[^\d]+/g,'');
    if(cnpj.length!=14) return false;
    if(/^(\d)\1+$/.test(cnpj)) return false;
    let t, d, v=[]; v[1]=0;
    t=cnpj.length-2; d=cnpj.substring(0,t);
    let val=[
        [5,4,3,2,9,8,7,6,5,4,3,2],
        [6,5,4,3,2,9,8,7,6,5,4,3,2]
    ];
    let arr=[];for(let i=0;i<2;i++){
        let sum=0;
        for(let j=0;j<t+i;j++){sum+=parseInt(d[j])*val[i][j];}
        arr[i]=sum%11<2?0:11-sum%11;
        d+=arr[i];
    }
    return d.slice(-2)===cnpj.slice(-2);
}

// MÁSCARA E VALIDAÇÃO TELEFONE
function mascaraTelefone(el) {
    let v = el.value.replace(/\D/g,'').slice(0,11);
    if (v.length > 10) {
        el.value = `(${v.slice(0,2)}) ${v.slice(2,7)}-${v.slice(7,11)}`.replace(/[-]+$/,'');
    } else if (v.length > 6) {
        el.value = `(${v.slice(0,2)}) ${v.slice(2,6)}-${v.slice(6,10)}`.replace(/[-]+$/,'');
    } else if (v.length > 2) {
        el.value = `(${v.slice(0,2)}) ${v.slice(2)}`;
    } else if (v.length > 0) {
        el.value = `(${v.slice(0,2)}`;
    } else {
        el.value = '';
    }
}
function telefoneValido(tel){
    tel = tel.replace(/\D/g,'');
    // Aceita celular 11 dígitos com 9 na frente (ex: 11999999999) e fixo (ex: 1133333333)
    if(tel.length===11 && /^([1-9]{2})9\d{8}$/.test(tel)) return true; // celular
    else if(tel.length===10 && /^([1-9]{2})[2-8]\d{7}$/.test(tel)) return true; // fixo
    return false;
}

function buscarEndereco(){
  const cep = document.getElementById('cliente-cep').value.replace(/\D/g, '');
  if(cep.length!==8) return;
  fetch('https://viacep.com.br/ws/'+cep+'/json/').then(r=>r.json()).then(data=>{
    if(data.erro) {
      showMessage('CEP não encontrado','erro');
    } else {
      document.getElementById('cliente-logradouro').value = data.logradouro||'';
      document.getElementById('cliente-bairro').value = data.bairro||'';
      document.getElementById('cliente-cidade').value = data.localidade||'';
    }
  });
}
const CATALOGO_PADRAO = [
  {descricao:"Laje H8 – CER", preco:44.59, unidade:"m²", desconto:2},
  {descricao:"Laje H10 – CER", preco:48.90, unidade:"m²", desconto:2},
  {descricao:"Laje H12 – CER", preco:52.30, unidade:"m²", desconto:2},
  {descricao:"Laje H15 – CER", preco:58.75, unidade:"m²", desconto:2},
  {descricao:"Laje H20 – CER", preco:67.80, unidade:"m²", desconto:2},
  {descricao:"Laje H8 – CON", preco:46.20, unidade:"m²", desconto:2},
  {descricao:"Laje H10 – CON", preco:50.60, unidade:"m²", desconto:2},
  {descricao:"Laje H12 – CON", preco:54.10, unidade:"m²", desconto:2},
  {descricao:"Laje H15 – CON", preco:60.90, unidade:"m²", desconto:2},
  {descricao:"Laje H20 – CON", preco:70.30, unidade:"m²", desconto:2},
  {descricao:"Vigota Pré-moldada 2,40m", preco:12.50, unidade:"un", desconto:0},
  {descricao:"Vigota Pré-moldada 3,00m", preco:15.80, unidade:"un", desconto:0},
  {descricao:"Vigota Pré-moldada 4,00m", preco:21.40, unidade:"un", desconto:0},
  {descricao:"Vigota Pré-moldada 5,00m", preco:26.70, unidade:"un", desconto:0},
  {descricao:"Tavela Cerâmica 8cm", preco:2.85, unidade:"un", desconto:0},
  {descricao:"Tavela Cerâmica 10cm", preco:3.20, unidade:"un", desconto:0},
  {descricao:"Tavela Cerâmica 12cm", preco:3.65, unidade:"un", desconto:0},
  {descricao:"Tavela EPS 8cm", preco:4.50, unidade:"un", desconto:0},
  {descricao:"Tavela EPS 10cm", preco:5.20, unidade:"un", desconto:0},
  {descricao:"Capeamento 3cm", preco:28.50, unidade:"m²", desconto:0},
  {descricao:"Capeamento 4cm", preco:32.80, unidade:"m²", desconto:0},
  {descricao:"Capeamento 5cm", preco:37.40, unidade:"m²", desconto:0},
  {descricao:"Frete (até 30km)", preco:180.00, unidade:"un", desconto:0},
  {descricao:"Frete (30-50km)", preco:280.00, unidade:"un", desconto:0},
  {descricao:"Montagem/Instalação", preco:15.50, unidade:"m²", desconto:0}
];
const KEY_CATALOGO='orc_catalogo_v1';
const KEY_ORCAMENTOS='orc_orcamentos_v1';
const KEY_CLIENTES='orc_clientes_v1';
const KEY_COUNTERS='orc_counters_v1'; // Para armazenar contadores de códigos
let catalogo=loadCatalogo();
let orcamentos=loadOrcamentos();
let clientes=loadClientes();
let orcAtual=null;
let leadAtualId=null; // ID do lead atualmente aberto no modal
// Índice do produto atualmente em edição; null quando não está editando
let editingCatalogIndex = null;
let filtrosClientes = {busca:"", status:"", ordenaPor:"dataAtualizacao", direcao:"desc"};
let filtrosObservacao = {ordenaPor:'data', direcao:'desc'};
document.addEventListener('DOMContentLoaded', ()=>{
  // Garante que os leads estejam carregados antes de qualquer ação no módulo
  try{ if(typeof loadLeads === 'function') loadLeads(); }catch(e){}
    popularSelect();
    renderizarCatalogo();
    renderizarListaOrcamentosSalvos();
    renderizarListaClientes();
    // Removido carregamento automático de orçamento ao iniciar
    // Agora apenas abre a tela inicial (home) sem modal
});
function showMessage(msg, tipo='info') {
  const toast = document.getElementById('toast');
  toast.textContent=msg;
  toast.className = 'toast '+tipo;
  toast.style.display='block';
  clearTimeout(toast._timer);
  toast._timer=setTimeout(()=>{toast.style.display='none';}, tipo==='erro'?4000:2300);
}
function formatarMoeda(v){ return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);}
// Escapa caracteres perigosos para uso em HTML (texto e atributos)
function escapeHtml(s){
  return (s==null? '' : String(s))
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#39;');
}
function formataData(valIso){
  if(!valIso) return "";
  try {const dt = new Date(valIso);return dt.toLocaleString('pt-BR').replace(",","");}
  catch{ return valIso; }
}
function loadCatalogo(){ const s=localStorage.getItem(KEY_CATALOGO); return s?JSON.parse(s):JSON.parse(JSON.stringify(CATALOGO_PADRAO));}
function saveCatalogo(){ localStorage.setItem(KEY_CATALOGO,JSON.stringify(catalogo)); popularSelect(); renderizarCatalogo(); if(orcAtual) propagarPrecosParaItens();}
function loadOrcamentos(){ const s=localStorage.getItem(KEY_ORCAMENTOS); return s?JSON.parse(s):[];}
function saveOrcamentos(){ 
  localStorage.setItem(KEY_ORCAMENTOS,JSON.stringify(orcamentos)); 
  renderizarListaOrcamentosSalvos(); 
  try { if(typeof renderDashboardCounts === 'function') renderDashboardCounts(); } catch(e) {}
}
function loadClientes(){ 
  const s=localStorage.getItem(KEY_CLIENTES); 
  return s?JSON.parse(s):[];
}
function saveClientes(){ 
  localStorage.setItem(KEY_CLIENTES,JSON.stringify(clientes)); 
  try { if(typeof renderDashboardCounts === 'function') renderDashboardCounts(); } catch(e) {}
}

// Funções para gerenciar códigos sequenciais
function loadCounters(){
  const s=localStorage.getItem(KEY_COUNTERS);
  return s?JSON.parse(s):{orcamento:0,pedido:0};
}
function saveCounters(counters){
  localStorage.setItem(KEY_COUNTERS,JSON.stringify(counters));
}
function gerarCodigoOrcamento(){
  const counters=loadCounters();
  counters.orcamento+=1;
  saveCounters(counters);
  return 'O-'+String(counters.orcamento).padStart(4,'0');
}
function abrir(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  const tabEl = document.getElementById('tab-'+id);
  if(tabEl) tabEl.classList.add('active');
  const sectionEl = document.getElementById(id);
  if(sectionEl) sectionEl.classList.add('active');
  
  // Atualiza o título do cabeçalho com o nome do módulo atual
  const tituloEl = document.getElementById('modulo-atual-titulo');
  if(tituloEl){
    const titulos = {
      'home': '🏠 Início',
      'clientes': '👤 Clientes',
      'orc': '🧾 Orçamento',
      'salvos': '💾 Negociação',
      'cat': '📦 Produtos',
      'dashboard': '📈 Dashboard',
      'leads': '📋 Leads',
      'vendas': '💳 Vendas',
      'producao': '🏗️ Produção',
      'entrega': '🚚 Entrega',
      'posvendas': '🔧 Pós-Vendas',
      'configuracoes': '⚙️ Configurações',
      'relatorios': '📊 Relatórios'
    };
    tituloEl.textContent = titulos[id] || 'WebLajes';
  }
  
    // Esconder as tabs superiores na tela inicial com transição (fade)
    const tabs = document.querySelector('.tabs');
    if(tabs){
      if(id==='home') tabs.classList.add('hidden');
      else tabs.classList.remove('hidden');
    }
    // Animação dos cards na tela inicial e animação dos cards internos do módulo Clientes
    if(id==='home'){
      // Atualizar área de favoritos
      if(typeof renderFavoritosArea === 'function'){
        renderFavoritosArea();
      }
      const cards = document.querySelectorAll('.module-card');
      cards.forEach((c, idx)=>{ c.style.opacity=0; c.style.transform='translateY(10px)'; c.style.animation='none'; });
      cards.forEach((c, idx)=>{
        setTimeout(()=>{
          c.style.animation = 'slideUpFade .36s ease forwards';
        }, idx * 70);
      });
    } else if(id==='clientes'){
      const cards = document.querySelectorAll('#clientes .client-card');
      cards.forEach((c, idx)=>{ c.style.opacity=0; c.style.transform='translateY(10px)'; c.style.animation='none'; });
      cards.forEach((c, idx)=>{
        setTimeout(()=>{ c.style.animation = 'slideUpFade .36s ease forwards'; }, idx * 70);
      });
    } else if(id==='leads'){
      const cards = document.querySelectorAll('#leads .lead-card');
      cards.forEach((c, idx)=>{ c.style.opacity=0; c.style.transform='translateY(10px)'; c.style.animation='none'; });
      cards.forEach((c, idx)=>{
        setTimeout(()=>{ c.style.animation = 'slideUpFade .36s ease forwards'; }, idx * 70);
      });
    } else {
      // limpa animações
      const cards = document.querySelectorAll('.module-card, #clientes .client-card, #leads .lead-card');
      cards.forEach(c=>{ c.style.animation='none'; c.style.opacity=''; c.style.transform=''; });
    }
    // Sidebar visibility: hide sidebar and toggle on Home, show on other modules
    const sidebar = document.getElementById('module-sidebar');
    const toggle = document.getElementById('module-sidebar-toggle');
    if(id === 'home'){
      if(sidebar) { sidebar.classList.add('hidden'); sidebar.setAttribute('aria-hidden','true'); }
      if(toggle){ toggle.style.display='none'; toggle.setAttribute('aria-hidden','true'); toggle.setAttribute('aria-pressed','false'); toggle.classList.remove('open'); }
      document.body.classList.remove('sidebar-open');
      document.body.classList.remove('sidebar-visible');
    } else {
      // Sidebar começa ABERTA quando página não é Home
      if(sidebar) { sidebar.classList.remove('hidden'); sidebar.setAttribute('aria-hidden','false'); }
      if(toggle){ 
        toggle.style.display='flex'; 
        toggle.setAttribute('aria-hidden','false'); 
        toggle.classList.add('open');
        toggle.setAttribute('aria-pressed','true');
      }
      document.body.classList.add('sidebar-visible');
      document.body.classList.add('sidebar-open');
    }
    // update layout now that visibility changed
    if(typeof adjustSidebarLayout === 'function') setTimeout(adjustSidebarLayout,60);
  if(id==='orc' && orcAtual){ renderizarItens(); calcularEGerarOrcamento(); }
}

// Toggle sidebar: open/close animation
function toggleSidebar(){
  const sidebar = document.getElementById('module-sidebar');
  const toggle = document.getElementById('module-sidebar-toggle');
  if(!sidebar || !toggle) return;
  
  const isHidden = sidebar.classList.contains('hidden');
  if(isHidden){
    sidebar.classList.remove('hidden');
    sidebar.setAttribute('aria-hidden','false');
    toggle.classList.add('open');
    toggle.setAttribute('aria-pressed','true');
    document.body.classList.add('sidebar-open');
  } else {
    sidebar.classList.add('hidden');
    sidebar.setAttribute('aria-hidden','true');
    toggle.classList.remove('open');
    toggle.setAttribute('aria-pressed','false');
    document.body.classList.remove('sidebar-open');
  }
}

// Força abertura da home imediatamente após definir a função
abrir('home');

function abrirTabelasAuxiliares(){ 
  const el = document.getElementById('tabelas-auxiliares');
  if(el) {
    el.style.display = 'block';
  }
  abrir('configuracoes'); 
}

// Safety: ensure the sidebar toggle and logo are visible on load if accidentally hidden
document.addEventListener('DOMContentLoaded', ()=>{
  try{
    const toggle = document.getElementById('module-sidebar-toggle');
    if(toggle && (toggle.style.display==='' || toggle.style.display==='none')){
      // Respect media query: only force if viewport is wide enough
      if(window.innerWidth>900){ toggle.style.display='flex'; }
    }
    const img = document.getElementById('app-logo');
    if(img && (!img.src || img.src.trim()==='')){
      // try to set project-local LOGO.png as an immediate fallback
      img.src = './LOGO.png';
      img.style.display = 'block';
    }
  }catch(e){}
});
function popularSelect(){
  let sel=document.getElementById('novo-item-select');
  sel.innerHTML='';
  catalogo.forEach((c,i)=>{
    let opt=document.createElement('option');
    opt.value=i;
    opt.textContent = c.descricao+" ("+formatarMoeda(c.preco)+")";
    sel.appendChild(opt);
  });
}
function renderizarCatalogo(){
  const table = document.getElementById('catalogo-table');
  if(!table) return; // Tabela não existe, retorna sem erro
  let tb = table.querySelector('tbody');
  if(!tb) return;
  tb.innerHTML='';
  catalogo.forEach((p,i)=>{
    let tr=document.createElement('tr');
    tr.innerHTML = `<td>${p.codigo||''}</td>
      <td>${p.descricao}</td>
      <td class="right">${p.unidade||''}</td>
      <td class="right">${formatarMoeda(p.preco)}</td>
      <td class="right">${p.desconto||0}%</td>
      <td>
        <button class="btn-edit" onclick="editarCatalogo(${i})">Editar</button>
        <button onclick="removerCatalogo(${i})" class="danger">Remover</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function adicionarCatalogo(){
  const codigo = (document.getElementById('cat-codigo').value||'').trim();
  const desc = document.getElementById('cat-desc').value.trim();
  const unidade = document.getElementById('cat-unit').value.trim();
  const preco = parseFloat(document.getElementById('cat-price').value);
  const desconto = parseFloat(document.getElementById('cat-discount').value)||0;
  if(!codigo||!desc||!unidade||isNaN(preco)){ showMessage('Preencha todos campos (código obrigatório)','erro');return;}
  // valida unicidade de código (case-insensitive)
  const exists = catalogo.findIndex((c,idx)=> (c.codigo||'').toLowerCase()===codigo.toLowerCase() && idx!==editingCatalogIndex) !== -1;
  if(exists){ showMessage('Código já existe. Escolha outro código.','erro'); return; }
  if(editingCatalogIndex===null){
    catalogo.push({codigo:codigo, descricao:desc,preco,unidade,desconto});
  } else {
    // salvar edição
    catalogo[editingCatalogIndex] = {codigo:codigo, descricao:desc,preco,unidade,desconto};
    editingCatalogIndex = null;
    document.getElementById('cat-add-btn').textContent = '+ Adicionar ao Produtos';
    document.getElementById('cat-cancel-btn').style.display = 'none';
  }
  saveCatalogo();
  renderDashboardCounts();
  document.getElementById('cat-desc').value='';
  document.getElementById('cat-unit').value='';
  document.getElementById('cat-price').value='';
  document.getElementById('cat-discount').value='';
}
function editarCatalogo(i){
  const p = catalogo[i];
  if(!p) return;
  document.getElementById('cat-codigo').value = p.codigo || '';
  document.getElementById('cat-desc').value = p.descricao || '';
  document.getElementById('cat-unit').value = p.unidade || '';
  document.getElementById('cat-price').value = p.preco || '';
  document.getElementById('cat-discount').value = p.desconto || 0;
  editingCatalogIndex = i;
  const addBtn = document.getElementById('cat-add-btn');
  addBtn.textContent = '💾 Salvar alteração';
  addBtn.classList.add('btn-save');
  addBtn.classList.remove('');
  document.getElementById('cat-cancel-btn').style.display = 'inline-block';
  // switch to Produtos tab so user can see the inputs (optional)
  abrir('cat');
}
function cancelarEditarCatalogo(){
  editingCatalogIndex = null;
  document.getElementById('cat-desc').value='';
  document.getElementById('cat-unit').value='';
  document.getElementById('cat-price').value='';
  document.getElementById('cat-discount').value='';
  const addBtn = document.getElementById('cat-add-btn');
  addBtn.textContent = '+ Adicionar ao Produtos';
  addBtn.classList.remove('btn-save');
  document.getElementById('cat-cancel-btn').style.display = 'none';
}
function removerCatalogo(i){
  if(confirm('Remover este produto?')){ catalogo.splice(i,1); saveCatalogo(); renderDashboardCounts(); }
}
function resetCatalogoConfirm(){
  if(confirm('Restaurar produtos padrão?')) {
    localStorage.removeItem(KEY_CATALOGO);
    catalogo=loadCatalogo();
    saveCatalogo();
  }
}
function novoOrcamento(){
  abrirPainelOrcamento();
}
function novoOrcamentoCliente(clienteId){
  const cliente = clientes.find(c => String(c.id) === String(clienteId));
  if(!cliente){
    showMessage('Cliente não encontrado','erro');
    return;
  }
  
  // Fecha o modal do cliente
  fecharPainelCliente();
  
  // Abre o modal de orçamento
  abrirPainelOrcamento(clienteId);
  
  // Mensagem movida para DENTRO de abrirPainelOrcamento para evitar disparar ao fechar
}
function salvarOrcamentoAtual(){
  const nome=document.getElementById('orcamento-nome').value.trim();
  const vendedor=document.getElementById('orcamento-vendedor').value.trim();
  if(!nome){ showMessage('Informe um nome para o orçamento','erro'); return;}
  orcAtual.nome=nome; orcAtual.vendedor=vendedor;
  const index=orcamentos.findIndex(o=>o.codigo===orcAtual.codigo);
  if(index!==-1) orcamentos[index]=JSON.parse(JSON.stringify(orcAtual));
  else orcamentos.push(JSON.parse(JSON.stringify(orcAtual)));
  saveOrcamentos();
  showMessage('Orçamento salvo!','sucesso');
}
function carregarOrcamento(codigo){
  const o=orcamentos.find(x=>x.codigo==codigo);
  if(!o) return;
  orcAtual=JSON.parse(JSON.stringify(o));
  document.getElementById('orcamento-nome').value=orcAtual.nome;
  document.getElementById('orcamento-vendedor').value=orcAtual.vendedor||'';
  abrir('orc'); renderizarItens(); calcularEGerarOrcamento();
}
function renderizarItens(){
  if(!orcAtual) return;
  const tbody=document.querySelector('#itens-table tbody'); tbody.innerHTML='';
  orcAtual.itens.forEach(it=>{
      const desconto = it.desconto || 0;
      const valorDesc = ((it.preco_unitario ||0) * desconto/100)*it.quantidade;
      const total=(parseFloat(it.quantidade)||0)*(parseFloat(it.preco_unitario)||0)-valorDesc;
      const tr=document.createElement('tr');
      tr.innerHTML=`
<td>
<input class="qtd small" type="number" step="0.01" value="${(it.quantidade||0).toFixed(2)}" onchange="atualizarItem(${it.id},'quantidade',this.value)" required>
<div style="font-size:12px;color:#666;margin-top:4px">${escapeHtml(it.unidade||'un')}</div>
</td>
<td><input class="desc" value="${escapeHtml(it.descricao)}" onchange="atualizarItem(${it.id},'descricao',this.value)" required></td>
<td class="right"><input class="price small" type="number" step="0.01" value="${(it.preco_unitario||0).toFixed(2)}" onchange="atualizarItem(${it.id},'preco_unitario',this.value)" required></td>
<td class="right">${formatarMoeda(total + valorDesc)}</td>
<td><input type="number" value="${desconto}" step="0.01" onchange="atualizarItem(${it.id},'desconto',this.value)"></td>
<td class="right">${formatarMoeda(valorDesc)}</td>
<td><button class="danger" onclick="removerItem(${it.id})">X</button></td>`;
      tbody.appendChild(tr);
  });
}
function adicionarItemSelecionado(){
  const sel=document.getElementById('novo-item-select'); const idx=sel.value;
  if(idx===''){ showMessage('Selecione um item do Produtos','erro'); return;}
  const modelo=catalogo[Number(idx)];
  if(!modelo) return;
  const novo={id:Date.now()+Math.floor(Math.random()*999),descricao:modelo.descricao,quantidade:0,unidade:modelo.unidade,preco_unitario:modelo.preco,desconto:modelo.desconto||0};
  orcAtual.itens.push(novo);
  renderizarItens(); calcularEGerarOrcamento();
  showMessage('Item adicionado!','sucesso');
}
function atualizarItem(id,campo,valor){
  const it=orcAtual.itens.find(x=>x.id===id); if(!it) return;
  if(campo==='descricao') it.descricao=valor;
  else if(campo==='quantidade') it.quantidade=parseFloat(valor)||0;
  else if(campo==='preco_unitario') it.preco_unitario=parseFloat(valor)||0;
  else if(campo==='desconto') it.desconto=parseFloat(valor)||0;
  renderizarItens(); calcularEGerarOrcamento();
}
function removerItem(id){
  if(!confirm('Remover item do orçamento?')) return;
  orcAtual.itens=orcAtual.itens.filter(x=>x.id!==id);
  renderizarItens(); calcularEGerarOrcamento();
  showMessage('Item removido');
}
function limparOrcamento(){
  if(!confirm('Limpar todo o orçamento?')) return;
  orcAtual.itens=[]; renderizarItens(); calcularEGerarOrcamento();
  showMessage('Itens removidos');
}
function propagarPrecosParaItens(){
  if(!orcAtual) return;
  orcAtual.itens=orcAtual.itens.map(it=>{
      const m=catalogo.find(c=>c.descricao===it.descricao);
      return m?{...it,preco_unitario:m.preco,unidade:m.unidade,desconto:m.desconto||0}:it;
  });
  renderizarItens(); calcularEGerarOrcamento();
}
function calcularEGerarOrcamento(){
  if(!orcAtual) return;
  let total=0;
  orcAtual.itens.forEach(i=>{
      const desc = i.desconto||0;
      total += (parseFloat(i.quantidade)||0)*(parseFloat(i.preco_unitario)||0)*(1 - desc/100);
  });
  const taxaPix=0.01987, totalPix=total*(1-taxaPix);
  const taxa2x=0.0403, taxa6x=0.0695, taxa12x=0.1165;
  const total2x=total*(1+taxa2x), total6x=total*(1+taxa6x), total12x=total*(1+taxa12x);
  const hoje=new Date(), validade=new Date(hoje); validade.setDate(hoje.getDate()+3);
  const dataHoje=hoje.toLocaleDateString('pt-BR'), dataValidade=validade.toLocaleDateString('pt-BR');
  document.getElementById('totais-box').innerHTML=`
<div style="display:flex;justify-content:space-between"><strong>Total à Vista:</strong><div><strong>${formatarMoeda(total)}</strong></div></div>
<div style="display:flex;justify-content:space-between"><span>*Desconto Pix (${(taxaPix*100).toFixed(2)}%):</span><div>${formatarMoeda(totalPix)}</div></div>
<hr style="margin:8px 0;border:none;border-top:1px dashed #ddd">
<div style="display:flex;justify-content:space-between"><strong>Parcelado 2x (${(taxa2x*100).toFixed(2)}%):</strong><div>${formatarMoeda(total2x)}</div></div>
<div style="display:flex;justify-content:space-between"><strong>Parcelado 6x (${(taxa6x*100).toFixed(2)}%):</strong><div>${formatarMoeda(total6x)}</div></div>
<div style="display:flex;justify-content:space-between"><strong>Parcelado 12x (${(taxa12x*100).toFixed(2)}%):</strong><div>${formatarMoeda(total12x)}</div></div>
<div style="display:none!important;gap:12px;margin-top:6px">
<div>2x: ${formatarMoeda(total2x/2)}</div>
<div>6x: ${formatarMoeda(total6x/6)}</div>
<div>12x: ${formatarMoeda(total12x/12)}</div>
</div>
<div style="margin-top:10px;font-size:13px;color:#555">
Orçamento emitido: <strong>${dataHoje}</strong> · Válido até: <strong>${dataValidade}</strong>
<div>Obs: Pagamento antecipado p/ emissão do pedido. Prazo entrega: 5-7 dias úteis.</div>
</div>`;
}
function gerarPDF(){
  if(!orcAtual) return;
  const clone=document.querySelector('.card').cloneNode(true);
  clone.querySelectorAll('button').forEach(b=>b.remove());
  const opt={margin:0.4, filename:(orcAtual.nome||'orcamento')+'.pdf', html2canvas:{scale:2}, jsPDF:{unit:'in',format:'a4',orientation:'portrait'} };
  html2pdf().set(opt).from(clone).save();
}
function renderizarListaOrcamentosSalvos(){
  const div=document.getElementById('lista-orcamentos-salvos'); div.innerHTML='';
  orcamentos.forEach(o=>{
      const container=document.createElement('div'); container.className='orcamento-list';
      const nome=document.createElement('div'); nome.textContent=o.nome; nome.style.flex='1';
      const btnCarregar=document.createElement('button'); btnCarregar.textContent='Carregar'; btnCarregar.onclick=()=>{ abrir('orc'); carregarOrcamento(o.codigo); };
      const btnExcluir=document.createElement('button'); btnExcluir.textContent='Excluir'; btnExcluir.className='danger'; btnExcluir.onclick=()=>{ if(confirm('Excluir este orçamento?')){orcamentos=orcamentos.filter(x=>x.codigo!==o.codigo); saveOrcamentos(); showMessage('Orçamento removido'); }};
      container.appendChild(nome); container.appendChild(btnCarregar); container.appendChild(btnExcluir); div.appendChild(container);
  });
}
// Reinicia o formulário do Cliente (usado no módulo Clientes)
function novoClienteForm(){
  const form = document.getElementById('form-cliente');
  if(form){
    form.reset();
    form.setAttribute('data-id','');
  }
  const doc = document.getElementById('cliente-doc');
  if(doc) doc.value = '';
}

// ========== Funções do Modal de Orçamento ==========
function abrirPainelOrcamento(clienteId){
  // Cria novo orçamento
  orcAtual={
    codigo:gerarCodigoOrcamento(),
    nome:'Novo Orçamento',
    vendedor:'',
    itens:[],
    clienteId: clienteId || null
  };
  
  // Se tiver cliente, adiciona nome do cliente
  if(clienteId){
    const cliente = clientes.find(c => String(c.id) === String(clienteId));
    if(cliente){
      orcAtual.nome = 'Orçamento - ' + (cliente.nome || 'Cliente');
    }
  }
  
  // Popula select de produtos
  const sel = document.getElementById('painel-novo-item-select');
  sel.innerHTML = '<option value="">Selecione um produto</option>';
  catalogo.forEach((p,i)=>{
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = `${p.descricao} - ${formatarMoeda(p.preco)} / ${p.unidade}`;
    sel.appendChild(opt);
  });
  
  // Preenche campos
  document.getElementById('painel-orcamento-nome').value = orcAtual.nome;
  document.getElementById('painel-orcamento-vendedor').value = orcAtual.vendedor || '';
  document.getElementById('painel-orcamento-codigo').value = orcAtual.codigo;
  
  // Renderiza itens vazios
  renderizarItensModal();
  calcularEGerarOrcamentoModal();
  
  // Abre modal
  const modal = document.getElementById('orcamento-modal');
  modal.style.display = 'flex';
  
  // Event listeners para fechar modal
  function onOverlayClick(e){
    if(e.target === modal){
      if(confirm('Deseja sair sem salvar?')){
        fecharPainelOrcamento();
      }
    }
  }
  function onEsc(e){ 
    if(e.key === 'Escape'){ 
      if(confirm('Deseja sair sem salvar?')){
        fecharPainelOrcamento();
      }
    } 
  }
  
  // Remove listeners antigos se existirem
  if(modal.__onOverlayClick){
    modal.removeEventListener('click', modal.__onOverlayClick);
  }
  if(modal.__onEsc){
    document.removeEventListener('keydown', modal.__onEsc);
  }
  
  // Adiciona novos listeners
  modal.__onOverlayClick = onOverlayClick;
  modal.__onEsc = onEsc;
  modal.addEventListener('click', onOverlayClick);
  document.addEventListener('keydown', onEsc);
}

// Abre o modal de orçamento vinculado a um Lead específico
function abrirPainelOrcamentoLead(leadId){
  try{
    const lead = (Array.isArray(leads) ? leads.find(x=>String(x.id)===String(leadId)) : null) || null;
    // cria nova estrutura do orçamento no modal
    abrirPainelOrcamento(null);
    // marca vínculo com o lead e ajusta título
    if(orcAtual){
      orcAtual.leadId = String(leadId);
      orcAtual.nome = 'Orçamento - ' + ((lead && lead.nome) ? lead.nome : 'Lead');
      const nomeInp = document.getElementById('painel-orcamento-nome');
      if(nomeInp) nomeInp.value = orcAtual.nome;
    }
    if(lead && lead.nome){ showMessage('Novo orçamento para ' + lead.nome, 'sucesso'); }
  }catch(err){ console.error('abrirPainelOrcamentoLead error', err); showMessage('Falha ao abrir orçamento do lead','erro'); }
}

function fecharPainelOrcamento(){
  const modal = document.getElementById('orcamento-modal');
  if(!modal) return;
  
  // Remove event listeners
  if(modal.__onOverlayClick){
    modal.removeEventListener('click', modal.__onOverlayClick);
  }
  if(modal.__onEsc){
    document.removeEventListener('keydown', modal.__onEsc);
  }
  
  modal.style.display = 'none';
  orcAtual = null;
}

function renderizarItensModal(){
  if(!orcAtual) return;
  const tbody = document.getElementById('painel-itens-tbody');
  tbody.innerHTML = '';
  
  orcAtual.itens.forEach(it=>{
    const desconto = it.desconto || 0;
    const valorDesc = ((it.preco_unitario ||0) * desconto/100)*it.quantidade;
    const total = (parseFloat(it.quantidade)||0)*(parseFloat(it.preco_unitario)||0)-valorDesc;
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
<td>
  <input class="qtd small" type="number" step="0.01" value="${(it.quantidade||0).toFixed(2)}" onchange="atualizarItemModal(${it.id},'quantidade',this.value)" required>
  <div style="font-size:12px;color:#666;margin-top:4px">${escapeHtml(it.unidade||'un')}</div>
</td>
<td><input class="desc" value="${escapeHtml(it.descricao)}" onchange="atualizarItemModal(${it.id},'descricao',this.value)" required></td>
<td class="right"><input class="price small" type="number" step="0.01" value="${(it.preco_unitario||0).toFixed(2)}" onchange="atualizarItemModal(${it.id},'preco_unitario',this.value)" required></td>
<td class="right">${formatarMoeda(total + valorDesc)}</td>
<td><input type="number" value="${desconto}" step="0.01" onchange="atualizarItemModal(${it.id},'desconto',this.value)"></td>
<td class="right">${formatarMoeda(valorDesc)}</td>
<td><button class="danger" onclick="removerItemModal(${it.id})">X</button></td>`;
    
    tbody.appendChild(tr);
  });
}

function atualizarItemModal(id, campo, valor){
  if(!orcAtual) return;
  const it = orcAtual.itens.find(x=>x.id===id);
  if(it){
    if(campo==='quantidade' || campo==='preco_unitario' || campo==='desconto'){
      it[campo] = parseFloat(valor) || 0;
    } else {
      it[campo] = valor;
    }
  }
  renderizarItensModal();
  calcularEGerarOrcamentoModal();
}

function removerItemModal(id){
  if(!orcAtual) return;
  orcAtual.itens = orcAtual.itens.filter(x=>x.id!==id);
  renderizarItensModal();
  calcularEGerarOrcamentoModal();
}

function adicionarItemSelecionadoModal(){
  const sel = document.getElementById('painel-novo-item-select');
  const idx = sel.value;
  if(idx===''){ 
    showMessage('Selecione um item do catálogo','erro'); 
    return;
  }
  
  const modelo = catalogo[Number(idx)];
  if(!modelo) return;
  
  const novo = {
    id: Date.now()+Math.floor(Math.random()*999),
    descricao: modelo.descricao,
    quantidade: 0,
    unidade: modelo.unidade,
    preco_unitario: modelo.preco,
    desconto: modelo.desconto||0
  };
  
  orcAtual.itens.push(novo);
  renderizarItensModal();
  calcularEGerarOrcamentoModal();
}

function limparOrcamentoModal(){
  if(!confirm('Limpar todos os itens do orçamento?')) return;
  orcAtual.itens = [];
  renderizarItensModal();
  calcularEGerarOrcamentoModal();
  showMessage('Itens removidos');
}

function calcularEGerarOrcamentoModal(){
  if(!orcAtual) return;
  
  let total = 0;
  orcAtual.itens.forEach(i=>{
    const desc = i.desconto||0;
    total += (parseFloat(i.quantidade)||0)*(parseFloat(i.preco_unitario)||0)*(1 - desc/100);
  });
  
  const taxaPix = 0.01987, totalPix = total*(1-taxaPix);
  const taxa2x = 0.0403, taxa6x = 0.0695, taxa12x = 0.1165;
  const total2x = total*(1+taxa2x), total6x = total*(1+taxa6x), total12x = total*(1+taxa12x);
  const hoje = new Date(), validade = new Date(hoje); 
  validade.setDate(hoje.getDate()+3);
  const dataHoje = hoje.toLocaleDateString('pt-BR'), dataValidade = validade.toLocaleDateString('pt-BR');
  
  document.getElementById('painel-totais-box').innerHTML = `
<div style="display:flex;justify-content:space-between"><strong>Total à Vista:</strong><div><strong>${formatarMoeda(total)}</strong></div></div>
<div style="display:flex;justify-content:space-between"><span>*Desconto Pix (${(taxaPix*100).toFixed(2)}%):</span><div>${formatarMoeda(totalPix)}</div></div>
<hr style="margin:8px 0;border:none;border-top:1px dashed #ddd">
<div style="display:flex;justify-content:space-between"><strong>Parcelado 2x (${(taxa2x*100).toFixed(2)}%):</strong><div>${formatarMoeda(total2x)}</div></div>
<div style="display:flex;justify-content:space-between"><strong>Parcelado 6x (${(taxa6x*100).toFixed(2)}%):</strong><div>${formatarMoeda(total6x)}</div></div>
<div style="display:flex;justify-content:space-between"><strong>Parcelado 12x (${(taxa12x*100).toFixed(2)}%):</strong><div>${formatarMoeda(total12x)}</div></div>
<div style="margin-top:10px;font-size:13px;color:#555">
Orçamento emitido: <strong>${dataHoje}</strong> · Válido até: <strong>${dataValidade}</strong>
<div>Obs: Pagamento antecipado p/ emissão do pedido. Prazo entrega: 5-7 dias úteis.</div>
</div>`;
}

function salvarOrcamentoModal(){
  const nome = document.getElementById('painel-orcamento-nome').value.trim();
  const vendedor = document.getElementById('painel-orcamento-vendedor').value.trim();
  
  if(!nome){ 
    showMessage('Informe um nome para o orçamento','erro'); 
    return;
  }
  
  orcAtual.nome = nome;
  orcAtual.vendedor = vendedor;
  
  const index = orcamentos.findIndex(o=>o.codigo===orcAtual.codigo);
  if(index!==-1){
    orcamentos[index] = JSON.parse(JSON.stringify(orcAtual));
  } else {
    orcamentos.push(JSON.parse(JSON.stringify(orcAtual)));
  }
  
  saveOrcamentos();
  showMessage('Orçamento salvo com sucesso!','sucesso');
  
  // Atualiza painel do cliente se tiver clienteId
  if(orcAtual.clienteId){
    const cliente = clientes.find(c => String(c.id) === String(orcAtual.clienteId));
    if(cliente){
      popularPainelCliente(cliente);
    }
  }
  // Atualiza painel do lead se tiver leadId
  if(orcAtual.leadId){
    try{ renderLeadOrcamentos(orcAtual.leadId); }catch(e){}
  }
  
  fecharPainelOrcamento();
}

function gerarPDFModal(){
  if(!orcAtual) return;
  
  // Cria clone do modal para gerar PDF
  const modalBody = document.querySelector('.orcamento-modal-body');
  const clone = modalBody.cloneNode(true);
  
  // Remove botões
  clone.querySelectorAll('button').forEach(b=>b.remove());
  clone.querySelectorAll('select').forEach(s=>s.remove());
  
  // Remove campos de adicionar item
  const addSection = clone.querySelector('div[style*="border-top"]');
  if(addSection) addSection.remove();
  
  const opt = {
    margin: 0.4, 
    filename: (orcAtual.nome||'orcamento')+'.pdf', 
    html2canvas: {scale:2}, 
    jsPDF: {unit:'in',format:'a4',orientation:'portrait'}
  };
  
  html2pdf().set(opt).from(clone).save();
}

// ======================== FUNÇÕES DO MÓDULO LEADS ========================
let leads = [];
let filtrosLeads = {busca:'', ordenaPor:'nome', direcao:'asc'};
let editandoLeadId = null;

// Carregar e salvar leads no localStorage
function loadLeads(){ try{ leads=JSON.parse(localStorage.getItem('orc_leads')||'[]'); }catch(e){ leads=[]; } }
function saveLeads(){ try{ localStorage.setItem('orc_leads', JSON.stringify(leads)); }catch(e){ console.error('Erro ao salvar leads', e); } }

// Inicializar leads na carga da página
loadLeads();

function salvarLead(){
  const currentId = document.getElementById('form-lead').getAttribute('data-id');
  const nome = document.getElementById('lead-nome').value.trim();
  let tel1 = document.getElementById('lead-tel1').value.trim();
  let tel2 = document.getElementById('lead-tel2').value.trim();
  const cep = document.getElementById('lead-cep').value.trim();
  let doc = (document.getElementById('lead-doc').value||"").replace(/\D/g,'');
  const email = document.getElementById('lead-email').value.trim();
  
  // Validação de telefone 1 (somente se informado)
  if(tel1 && !telefoneValido(tel1)){
      showMessage('Telefone 1 inválido. Utilize DDD e número correto.','erro');
      document.getElementById('lead-tel1').focus();
      return;
  }
  
  // Validação de telefone 2 (somente se informado)
  if(tel2 && !telefoneValido(tel2)){
      showMessage('Telefone 2 inválido. Utilize DDD e número correto.','erro');
      document.getElementById('lead-tel2').focus();
      return;
  }
  
  // Validação de CPF/CNPJ (somente se informado)
  if(doc){
    if(!(doc.length===11?validarCPF(doc):doc.length===14?validarCNPJ(doc):false)){
      showMessage('CPF/CNPJ inválido','erro');
      document.getElementById('lead-doc').focus();
      return;
    }
  }
  
  let id = currentId||Date.now();
  let lead = leads.find(l=>String(l.id)===String(id));
  let agora = new Date().toISOString();
  let anexos = (lead && lead.anexos) ? [...lead.anexos] : [];
  let inputAnexo = document.getElementById('lead-anexo');
  
  if(inputAnexo && inputAnexo.files && inputAnexo.files.length){
    for(let f of inputAnexo.files){
      anexos.push({nome:f.name,tipo:f.type, data:agora});
    }
    inputAnexo.value = "";
  }
  
  let obj = {
    id,
    doc,
    nome,
    email,
    telefone1:tel1,
    telefone2:tel2,
    cep: cep,
    logradouro: document.getElementById('lead-logradouro').value.trim(),
    numero: document.getElementById('lead-numero').value.trim(),
    complemento: document.getElementById('lead-complemento').value.trim(),
    bairro: document.getElementById('lead-bairro').value.trim(),
    cidade: document.getElementById('lead-cidade').value.trim(),
    observacao: document.getElementById('lead-observacao').value.trim(),
    anexos,
    dataCadastro: (lead && lead.dataCadastro) ? lead.dataCadastro : agora,
    dataAtualizacao: agora,
    observacoes: (lead && lead.observacoes) ? lead.observacoes : []
  };
  
  if(lead){
    Object.assign(lead,obj);
  } else {
    leads.push(obj);
  }
  
  saveLeads();
  renderizarListaLeads();
  showMessage(lead ? 'Lead atualizado!':'Lead cadastrado!','sucesso');
  novoLeadForm();
}

function renderizarListaLeads(){
  let tb=document.getElementById('tabela-leads');
  if(!tb) return;
  let tbody = tb.querySelector('tbody');
  if(!tbody) return;
  
  tbody.innerHTML='';
  let busc= normalizarTexto(filtrosLeads.busca);
  let arr = leads.filter(l=>
    (!busc || 
      normalizarTexto(l.nome).includes(busc) || 
      normalizarTexto(l.doc).includes(busc) || 
      normalizarTexto(l.telefone1).includes(busc) ||
      normalizarTexto(l.telefone2).includes(busc) ||
      normalizarTexto(l.email).includes(busc) ||
      normalizarTexto(l.cidade).includes(busc)
    )
  );
  
  arr.sort((a,b)=>{
    let f = filtrosLeads.ordenaPor; 
    let dir = filtrosLeads.direcao=='asc'?1:-1;
    return (a[f]||'')>(b[f]||'')?dir:-dir;
  });
  
  arr.forEach(l=>{
    let tr=document.createElement('tr');
    
    const tdNome = document.createElement('td');
    const linkNome = document.createElement('a');
    linkNome.href = '#';
    linkNome.textContent = l.nome || '';
    linkNome.onclick = (e) => { e.preventDefault(); abrirPainelLead(l.id); return false; };
    tdNome.appendChild(linkNome);
    
    const tdDoc = document.createElement('td');
    tdDoc.textContent = l.doc || '';
    
    const tdTel = document.createElement('td');
    tdTel.textContent = l.telefone1 || '';
    
    const tdCidade = document.createElement('td');
    tdCidade.textContent = l.cidade || '';
    
    const tdData = document.createElement('td');
    tdData.textContent = formataData(l.dataAtualizacao);
    
    const tdAcoes = document.createElement('td');
    const btnEditar = document.createElement('button');
    btnEditar.textContent = 'Editar';
    btnEditar.onclick = () => editarLead(l.id);
    
    const btnExcluir = document.createElement('button');
    btnExcluir.textContent = 'Excluir';
    btnExcluir.className = 'danger';
    btnExcluir.onclick = () => excluirLead(l.id);
    
    tdAcoes.appendChild(btnEditar);
    tdAcoes.appendChild(document.createTextNode(' '));
    tdAcoes.appendChild(btnExcluir);
    
    tr.appendChild(tdNome);
    tr.appendChild(tdDoc);
    tr.appendChild(tdTel);
    tr.appendChild(tdCidade);
    tr.appendChild(tdData);
    tr.appendChild(tdAcoes);
    
    tbody.appendChild(tr);
  });
  
  // Atualiza ícones de ordenação
  updateSortIconsLeads();
}

function updateSortIconsLeads(){
  // Limpa todos os ícones
  ['nome','doc','telefone1','cidade','dataAtualizacao'].forEach(campo=>{
    const el = document.getElementById('sort-lead-'+campo);
    if(el) el.textContent = '↕';
  });
  
  // Define o ícone do campo atual
  const el = document.getElementById('sort-lead-'+filtrosLeads.ordenaPor);
  if(el) el.textContent = filtrosLeads.direcao==='asc'?'↑':'↓';
}

function ordenarLeads(campo){
  if(filtrosLeads.ordenaPor === campo){
    filtrosLeads.direcao = (filtrosLeads.direcao === 'asc' ? 'desc' : 'asc');
  } else {
    filtrosLeads.ordenaPor = campo;
    filtrosLeads.direcao = 'asc';
  }
  renderizarListaLeads();
}

function editarLead(id){
  const lead = leads.find(l=>String(l.id)===String(id));
  if(!lead){ showMessage('Lead não encontrado','erro'); return; }
  
  document.getElementById('lead-doc').value = lead.doc || '';
  document.getElementById('lead-nome').value = lead.nome || '';
  document.getElementById('lead-email').value = lead.email || '';
  document.getElementById('lead-tel1').value = lead.telefone1 || '';
  document.getElementById('lead-tel2').value = lead.telefone2 || '';
  document.getElementById('lead-cep').value = lead.cep || '';
  document.getElementById('lead-logradouro').value = lead.logradouro || '';
  document.getElementById('lead-numero').value = lead.numero || '';
  document.getElementById('lead-complemento').value = lead.complemento || '';
  document.getElementById('lead-bairro').value = lead.bairro || '';
  document.getElementById('lead-cidade').value = lead.cidade || '';
  document.getElementById('lead-observacao').value = lead.observacao || '';
  
  const form = document.getElementById('form-lead');
  form.setAttribute('data-id', id);
  form.style.display = 'block';
  form.scrollIntoView({behavior:'smooth'});
}

function excluirLead(id){
  const lead = leads.find(l=>String(l.id)===String(id));
  if(!lead){ showMessage('Lead não encontrado','erro'); return; }
  
  if(confirm(`Excluir o lead "${lead.nome}"?`)){
    leads = leads.filter(l=>String(l.id)!==String(id));
    saveLeads();
    renderizarListaLeads();
    showMessage('Lead excluído com sucesso!','sucesso');
  }
}

function novoLeadForm(){
  const form = document.getElementById('form-lead');
  if(form){
    form.reset();
    form.removeAttribute('data-id');
    form.style.display = 'block';
  }
}

function toggleLeadsTable(){
  const tb = document.getElementById('tabela-leads');
  const icon = document.getElementById('leads-header-icon');
  if(!tb || !icon) return;
  
  if(tb.style.display === 'none' || !tb.style.display){
    tb.style.display = 'table';
    icon.textContent = '▾';
  } else {
    tb.style.display = 'none';
    icon.textContent = '▸';
  }
}

function abrirCadastroLead(){
  const form = document.getElementById('form-lead');
  const modal = document.getElementById('lead-modal');
  
  if(form){
    form.reset();
    form.removeAttribute('data-id');
  }
  
  // Hide inline form and open modal instead
  if(form) form.style.display = 'none';
  
  try{
    const tb = document.getElementById('tabela-leads');
    const icon = document.getElementById('leads-header-icon');
    if(tb) tb.style.display = 'none';
    if(icon) icon.textContent = '▸';
  }catch(e){}
  
  // Open modal with empty lead
  try{
    const empty = { id: '', nome: '', doc:'', email:'', telefone1:'', telefone2:'', cep:'', logradouro:'', numero:'', complemento:'', bairro:'', cidade:'', observacao:'', anexos:[], observacoes:[] };
    popularPainelLead(empty);
    if(modal){
      modal.style.display = 'flex';
    }
    setTimeout(()=>{ 
      const el = document.getElementById('painel-lead-nome'); 
      if(el) el.focus(); 
    },120);
  }catch(e){ 
    console.warn('abrirCadastroLead modal open failed', e); 
  }
}

function abrirListaLeads(){
  try{ 
    if(typeof renderizarListaLeads==='function') {
      renderizarListaLeads(); 
    }
  }catch(e){
    console.error('Erro ao renderizar lista:', e);
  }
  
  try{
    const tb = document.getElementById('tabela-leads');
    const icon = document.getElementById('leads-header-icon');
    const form = document.getElementById('form-lead');
    if(form){ form.style.display = 'none'; }
    if(tb){ 
      tb.style.display = 'table'; 
      tb.scrollIntoView({behavior:'smooth',block:'start'}); 
    }
    if(icon) icon.textContent = '▾';
  }catch(e){
    console.error('Erro ao mostrar tabela:', e);
  }
}

function abrirBuscaLead(){
  const modal = document.getElementById('busca-lead-modal');
  const input = document.getElementById('busca-lead-input');
  const resultados = document.getElementById('busca-lead-resultados');
  
  if(modal) modal.style.display = 'flex';
  if(input) {
    input.value = '';
    setTimeout(() => input.focus(), 100);
  }
  if(resultados) {
    resultados.innerHTML = '<div style="color:#999;text-align:center;padding:40px">Digite para buscar leads...</div>';
  }
}

function fecharBuscaLead(){
  const modal = document.getElementById('busca-lead-modal');
  if(modal) modal.style.display = 'none';
}

function realizarBuscaLead(){
  const input = document.getElementById('busca-lead-input');
  const resultados = document.getElementById('busca-lead-resultados');
  if(!input || !resultados) return;
  
  const termo = normalizarTexto(input.value.trim());
  
  if(!termo){
    resultados.innerHTML = '<div style="color:#999;text-align:center;padding:40px">Digite para buscar leads...</div>';
    return;
  }
  
  const encontrados = leads.filter(l => 
    normalizarTexto(l.nome).includes(termo) ||
    normalizarTexto(l.doc).includes(termo) ||
    normalizarTexto(l.email).includes(termo) ||
    normalizarTexto(l.telefone1).includes(termo) ||
    normalizarTexto(l.telefone2).includes(termo) ||
    normalizarTexto(l.cep).includes(termo) ||
    normalizarTexto(l.logradouro).includes(termo) ||
    normalizarTexto(l.cidade).includes(termo) ||
    normalizarTexto(l.bairro).includes(termo)
  );
  
  if(encontrados.length === 0){
    resultados.innerHTML = '<div style="color:#999;text-align:center;padding:40px">Nenhum lead encontrado com esse termo.</div>';
    return;
  }
  
  resultados.innerHTML = '';
  encontrados.forEach(l => {
    const card = document.createElement('div');
    card.style.cssText = 'padding:16px;margin-bottom:12px;border:1px solid #ddd;border-radius:8px;cursor:pointer;transition:all 0.2s';
    card.onmouseover = () => card.style.background = '#f5f5f5';
    card.onmouseout = () => card.style.background = '';
    card.onclick = () => {
      abrirPainelLead(l.id);
      fecharBuscaLead();
    };
    
    const nome = document.createElement('div');
    nome.style.cssText = 'font-weight:600;font-size:16px;margin-bottom:8px';
    nome.textContent = l.nome;
    
    const info = document.createElement('div');
    info.style.cssText = 'font-size:14px;color:#666;display:flex;flex-direction:column;gap:4px';
    info.innerHTML = `
      ${l.doc ? `<div>📄 ${l.doc}</div>` : ''}
      ${l.email ? `<div>📧 ${escapeHtml(l.email)}</div>` : ''}
      <div>📞 ${escapeHtml(l.telefone1)}${l.telefone2 ? ' / '+escapeHtml(l.telefone2) : ''}</div>
      ${l.cidade ? `<div>📍 ${escapeHtml(l.cidade)}</div>` : ''}
    `;
    
    card.appendChild(nome);
    card.appendChild(info);
    resultados.appendChild(card);
  });
}

function abrirPainelLead(id){
  const l = leads.find(x=>String(x.id)===String(id));
  if(!l) {
    return showMessage('Lead não encontrado','erro');
  }
  
  // Armazena globalmente o lead aberto para ações do modal (ex: Novo Orçamento)
  try{ window.leadAtualId = id; }catch(e){ leadAtualId = id; }

  popularPainelLead(l);
  const modal = document.getElementById('lead-modal');
  if(modal) {
    modal.style.display = 'flex';
    // também grava no atributo data para fallback
    modal.setAttribute('data-lead-id', id);
  }
  
  // Garante que o botão "Novo Orçamento" abre o modal de orçamento para este lead
  const novoBtn = document.getElementById('painel-lead-novo-orc');
  if(novoBtn){
    novoBtn.onclick = function(e){ e.stopPropagation(); abrirPainelOrcamentoLead(id); };
  }
  
  function onOverlayClick(e){
    if(e.target && e.target.id === 'lead-modal'){
      fecharPainelLead();
    }
  }
  
  function onEsc(e){ 
    if(e.key === 'Escape'){ 
      fecharPainelLead(); 
    } 
  }
  
  modal.__onOverlayClick = onOverlayClick;
  modal.__onEsc = onEsc;
  modal.addEventListener('click', onOverlayClick);
  document.addEventListener('keydown', onEsc);
}

function fecharPainelLead(){
  const modal = document.getElementById('lead-modal');
  if(!modal) return;
  
  if(modal.__onOverlayClick){
    modal.removeEventListener('click', modal.__onOverlayClick);
  }
  if(modal.__onEsc){
    document.removeEventListener('keydown', modal.__onEsc);
  }
  // remove Novo Orçamento handler if present
  const novoBtn = document.getElementById('painel-lead-novo-orc');
  if(novoBtn) novoBtn.onclick = null;
  
  // limpa id global e atributo data
  try{ window.leadAtualId = null; }catch(e){ leadAtualId = null; }
  modal.removeAttribute('data-lead-id');

  modal.style.display = 'none';
}

function popularPainelLead(l){
  editandoLeadId = l.id || null;
  
  document.getElementById('painel-lead-nome').value = l.nome || '';
  document.getElementById('painel-lead-doc').value = l.doc || '';
  document.getElementById('painel-lead-email').value = l.email || '';
  document.getElementById('painel-lead-tel1').value = l.telefone1 || '';
  document.getElementById('painel-lead-tel2').value = l.telefone2 || '';
  document.getElementById('painel-lead-cep').value = l.cep || '';
  document.getElementById('painel-lead-logradouro').value = l.logradouro || '';
  document.getElementById('painel-lead-numero').value = l.numero || '';
  document.getElementById('painel-lead-complemento').value = l.complemento || '';
  document.getElementById('painel-lead-bairro').value = l.bairro || '';
  document.getElementById('painel-lead-cidade').value = l.cidade || '';
  document.getElementById('painel-lead-observacao').value = l.observacao || '';
  
  // Renderizar anexos
  renderizarAnexosModalLead(l.anexos || []);
  
  // Renderizar observações
  renderizarObservacoesModalLead(l.observacoes || []);
}

function salvarPainelLead(){
  if(!editandoLeadId){
    // Novo lead
    const nome = document.getElementById('painel-lead-nome').value.trim();
    const tel1 = document.getElementById('painel-lead-tel1').value.trim();
    const cep = document.getElementById('painel-lead-cep').value.trim();
    
    // Validação de telefone 1 (somente se informado)
    if(tel1 && !telefoneValido(tel1)){
      showMessage('Telefone 1 inválido','erro');
      return;
    }
    
    const tel2 = document.getElementById('painel-lead-tel2').value.trim();
    if(tel2 && !telefoneValido(tel2)){
      showMessage('Telefone 2 inválido','erro');
      return;
    }
    
    const doc = (document.getElementById('painel-lead-doc').value||"").replace(/\D/g,'');
    if(doc){
      if(!(doc.length===11?validarCPF(doc):doc.length===14?validarCNPJ(doc):false)){
        showMessage('CPF/CNPJ inválido','erro');
        return;
      }
    }
    
    const agora = new Date().toISOString();
    const novoLead = {
      id: Date.now(),
      nome,
      doc,
      email: document.getElementById('painel-lead-email').value.trim(),
      telefone1: tel1,
      telefone2: tel2,
      cep,
      logradouro: document.getElementById('painel-lead-logradouro').value.trim(),
      numero: document.getElementById('painel-lead-numero').value.trim(),
      complemento: document.getElementById('painel-lead-complemento').value.trim(),
      bairro: document.getElementById('painel-lead-bairro').value.trim(),
      cidade: document.getElementById('painel-lead-cidade').value.trim(),
      observacao: document.getElementById('painel-lead-observacao').value.trim(),
      anexos: [],
      observacoes: [],
      dataCadastro: agora,
      dataAtualizacao: agora
    };
    
    leads.push(novoLead);
    saveLeads();
    renderizarListaLeads();
    showMessage('Lead cadastrado com sucesso!','sucesso');
    fecharPainelLead();
    
  } else {
    // Editar lead existente
    const lead = leads.find(l=>String(l.id)===String(editandoLeadId));
    if(!lead){ showMessage('Lead não encontrado','erro'); return; }
    
    const nome = document.getElementById('painel-lead-nome').value.trim();
    const tel1 = document.getElementById('painel-lead-tel1').value.trim();
    const cep = document.getElementById('painel-lead-cep').value.trim();
    
    // Validação de telefone 1 (somente se informado)
    if(tel1 && !telefoneValido(tel1)){
      showMessage('Telefone 1 inválido','erro');
      return;
    }
    
    const tel2 = document.getElementById('painel-lead-tel2').value.trim();
    if(tel2 && !telefoneValido(tel2)){
      showMessage('Telefone 2 inválido','erro');
      return;
    }
    
    const doc = (document.getElementById('painel-lead-doc').value||"").replace(/\D/g,'');
    if(doc){
      if(!(doc.length===11?validarCPF(doc):doc.length===14?validarCNPJ(doc):false)){
        showMessage('CPF/CNPJ inválido','erro');
        return;
      }
    }
    
    lead.nome = nome;
    lead.doc = doc;
    lead.email = document.getElementById('painel-lead-email').value.trim();
    lead.telefone1 = tel1;
    lead.telefone2 = tel2;
    lead.cep = cep;
    lead.logradouro = document.getElementById('painel-lead-logradouro').value.trim();
    lead.numero = document.getElementById('painel-lead-numero').value.trim();
    lead.complemento = document.getElementById('painel-lead-complemento').value.trim();
    lead.bairro = document.getElementById('painel-lead-bairro').value.trim();
    lead.cidade = document.getElementById('painel-lead-cidade').value.trim();
    lead.observacao = document.getElementById('painel-lead-observacao').value.trim();
    lead.dataAtualizacao = new Date().toISOString();
    
    saveLeads();
    renderizarListaLeads();
    showMessage('Lead atualizado com sucesso!','sucesso');
    fecharPainelLead();
  }
}

function validarDocModalLead(){
  const input = document.getElementById('painel-lead-doc');
  if(!input) return;
  const doc = input.value.replace(/\D/g,'');
  if(doc && doc.length > 0){
    if(doc.length === 11){
      if(!validarCPF(doc)){
        input.style.borderColor = 'red';
        showMessage('CPF inválido','erro');
      } else {
        input.style.borderColor = '';
      }
    } else if(doc.length === 14){
      if(!validarCNPJ(doc)){
        input.style.borderColor = 'red';
        showMessage('CNPJ inválido','erro');
      } else {
        input.style.borderColor = '';
      }
    }
  }
}

function validarTelModalLead(num){
  const input = document.getElementById('painel-lead-tel'+num);
  if(!input) return;
  const tel = input.value.trim();
  if(tel && !telefoneValido(tel)){
    input.style.borderColor = 'red';
  } else {
    input.style.borderColor = '';
  }
}

function buscarEnderecoLead(){
  const cep = document.getElementById('lead-cep').value.replace(/\D/g,'');
  if(cep.length !== 8) return;
  
  fetch(`https://viacep.com.br/ws/${cep}/json/`)
    .then(r=>r.json())
    .then(data=>{
      if(!data.erro){
        document.getElementById('lead-logradouro').value = data.logradouro || '';
        document.getElementById('lead-bairro').value = data.bairro || '';
        document.getElementById('lead-cidade').value = data.localidade || '';
      } else {
        showMessage('CEP não encontrado','erro');
      }
    })
    .catch(e=>console.error('Erro ao buscar CEP:', e));
}

function buscarEnderecoModalLead(){
  const cep = document.getElementById('painel-lead-cep').value.replace(/\D/g,'');
  if(cep.length !== 8) return;
  
  fetch(`https://viacep.com.br/ws/${cep}/json/`)
    .then(r=>r.json())
    .then(data=>{
      if(!data.erro){
        document.getElementById('painel-lead-logradouro').value = data.logradouro || '';
        document.getElementById('painel-lead-bairro').value = data.bairro || '';
        document.getElementById('painel-lead-cidade').value = data.localidade || '';
      } else {
        showMessage('CEP não encontrado','erro');
      }
    })
    .catch(e=>console.error('Erro ao buscar CEP:', e));
}

function adicionarAnexosModalLead(){
  const input = document.getElementById('painel-lead-anexo');
  if(!input || !input.files || !input.files.length) return;
  
  const lead = leads.find(l=>String(l.id)===String(editandoLeadId));
  if(!lead){ showMessage('Lead não encontrado','erro'); return; }
  
  if(!lead.anexos) lead.anexos = [];
  
  const agora = new Date().toISOString();
  for(let f of input.files){
    lead.anexos.push({nome:f.name, tipo:f.type, data:agora});
  }
  
  saveLeads();
  renderizarAnexosModalLead(lead.anexos);
  showMessage('Anexos adicionados!','sucesso');
  input.value = '';
}

function renderizarAnexosModalLead(anexos){
  const container = document.getElementById('painel-lead-anexos');
  if(!container) return;
  
  container.innerHTML = '';
  if(!anexos || anexos.length === 0){
    container.innerHTML = '<div style="color:#999;font-size:13px;padding:8px">Nenhum anexo</div>';
    return;
  }
  
  anexos.forEach((a,i)=>{
    const div = document.createElement('div');
    div.style.cssText = 'display:flex;align-items:center;gap:8px;padding:8px;background:#fff;border:1px solid #ddd;border-radius:4px;font-size:13px';
    
    const icone = document.createElement('span');
    icone.textContent = a.tipo.includes('pdf')?'📄':a.tipo.includes('image')?'🖼️':'📎';
    
    const nome = document.createElement('span');
    nome.textContent = a.nome;
    nome.style.flex = '1';
    nome.style.cursor = 'pointer';
    nome.onclick = () => abrirAnexoSlide(a, editandoLeadId, 'lead');
    
    const btnDel = document.createElement('button');
    btnDel.textContent = '🗑️';
    btnDel.className = 'danger';
    btnDel.style.cssText = 'padding:4px 8px;font-size:12px';
    btnDel.onclick = () => removerAnexoModalLead(i);
    
    div.appendChild(icone);
    div.appendChild(nome);
    div.appendChild(btnDel);
    container.appendChild(div);
  });
}

function removerAnexoModalLead(index){
  const lead = leads.find(l=>String(l.id)===String(editandoLeadId));
  if(!lead || !lead.anexos) return;
  
  if(confirm('Excluir este anexo?')){
    lead.anexos.splice(index, 1);
    saveLeads();
    renderizarAnexosModalLead(lead.anexos);
    showMessage('Anexo removido!','sucesso');
  }
}

function adicionarObservacaoModalLead(){
  const textarea = document.getElementById('painel-lead-observacao');
  if(!textarea) return;
  
  const texto = textarea.value.trim();
  if(!texto){ showMessage('Digite uma observação','erro'); return; }
  
  const lead = leads.find(l=>String(l.id)===String(editandoLeadId));
  if(!lead){ showMessage('Lead não encontrado','erro'); return; }
  
  if(!lead.observacoes) lead.observacoes = [];
  
  lead.observacoes.push({
    texto,
    data: new Date().toISOString(),
    usuario: 'Usuário'
  });
  
  saveLeads();
  renderizarObservacoesModalLead(lead.observacoes);
  showMessage('Observação adicionada!','sucesso');
  textarea.value = '';
}

function renderizarObservacoesModalLead(observacoes){
  const tbody = document.getElementById('painel-observacoes-lead-tbody');
  if(!tbody) return;
  
  tbody.innerHTML = '';
  if(!observacoes || observacoes.length === 0){
    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#999;padding:12px">Nenhuma observação</td></tr>';
    return;
  }
  
  observacoes.forEach(obs=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:6px">${escapeHtml(obs.texto)}</td>
      <td style="padding:6px">${formataData(obs.data)}</td>
      <td style="padding:6px">${escapeHtml(obs.usuario)}</td>
    `;
    tbody.appendChild(tr);
  });
}

let sortObsLeadCampo = 'data';
let sortObsLeadDir = 'desc';

function ordenarObservacoesLead(campo){
  if(sortObsLeadCampo === campo){
    sortObsLeadDir = (sortObsLeadDir === 'asc' ? 'desc' : 'asc');
  } else {
    sortObsLeadCampo = campo;
    sortObsLeadDir = 'asc';
  }
  
  const lead = leads.find(l=>String(l.id)===String(editandoLeadId));
  if(!lead || !lead.observacoes) return;
  
  lead.observacoes.sort((a,b)=>{
    const dir = sortObsLeadDir==='asc'?1:-1;
    return (a[campo]||'')>(b[campo]||'')?dir:-dir;
  });
  
  renderizarObservacoesModalLead(lead.observacoes);
  
  // Atualiza ícones
  ['texto','data','usuario'].forEach(c=>{
    const el = document.getElementById('sort-obs-lead-'+c);
    if(el) el.textContent = '↕';
  });
  const el = document.getElementById('sort-obs-lead-'+campo);
  if(el) el.textContent = sortObsLeadDir==='asc'?'↑':'↓';
}

// ======================== FIM FUNÇÕES DO MÓDULO LEADS ========================

// ========== Funções do Modal de Catálogo de Produtos ==========
let editingProductIndex = null;

function abrirCatalogoProdutos(){
  const modal = document.getElementById('catalogo-produtos-modal');
  modal.style.display = 'flex';
  renderizarCatalogoProdutos();
  
  // Event listeners para fechar modal
  function onOverlayClick(e){
    if(e.target === modal){
      fecharCatalogoProdutos();
    }
  }
  function onEsc(e){ 
    if(e.key === 'Escape'){ 
      fecharCatalogoProdutos();
    } 
  }
  
  // Remove listeners antigos se existirem
  if(modal.__onOverlayClick){
    modal.removeEventListener('click', modal.__onOverlayClick);
  }
  if(modal.__onEsc){
    document.removeEventListener('keydown', modal.__onEsc);
  }
  
  // Adiciona novos listeners
  modal.__onOverlayClick = onOverlayClick;
  modal.__onEsc = onEsc;
  modal.addEventListener('click', onOverlayClick);
  document.addEventListener('keydown', onEsc);
}

function fecharCatalogoProdutos(){
  const modal = document.getElementById('catalogo-produtos-modal');
  if(!modal) return;
  
  // Remove event listeners
  if(modal.__onOverlayClick){
    modal.removeEventListener('click', modal.__onOverlayClick);
  }
  if(modal.__onEsc){
    document.removeEventListener('keydown', modal.__onEsc);
  }
  
  modal.style.display = 'none';
  cancelarEdicaoProduto();
}

function renderizarCatalogoProdutos(){
  const tbody = document.getElementById('catalogo-produtos-tbody');
  if(!tbody) return;
  
  tbody.innerHTML = '';
  
  catalogo.forEach((produto, index) => {
    const tr = document.createElement('tr');
    tr.style.borderBottom = '1px solid #eee';
    
    tr.innerHTML = `
      <td style="padding:10px">${escapeHtml(produto.descricao)}</td>
      <td style="padding:10px">${escapeHtml(produto.unidade || 'un')}</td>
      <td style="padding:10px;text-align:right">${formatarMoeda(produto.preco)}</td>
      <td style="padding:10px;text-align:center">${produto.desconto || 0}%</td>
      <td style="padding:10px;text-align:center">
        <button onclick="editarProdutoCatalogo(${index})" style="margin-right:4px">Editar</button>
        <button onclick="removerProdutoCatalogo(${index})" class="danger">Excluir</button>
      </td>
    `;
    
    tbody.appendChild(tr);
  });
  
  // Atualiza contador
  const count = document.getElementById('total-produtos-count');
  if(count) count.textContent = catalogo.length;
}

function adicionarProdutoCatalogo(){
  const desc = document.getElementById('cat-modal-desc').value.trim();
  const unit = document.getElementById('cat-modal-unit').value.trim() || 'un';
  const price = parseFloat(document.getElementById('cat-modal-price').value) || 0;
  const discount = parseFloat(document.getElementById('cat-modal-discount').value) || 0;
  
  if(!desc){
    showMessage('Informe a descrição do produto', 'erro');
    return;
  }
  
  if(price <= 0){
    showMessage('Informe um preço válido', 'erro');
    return;
  }
  
  if(editingProductIndex !== null){
    // Editando produto existente
    catalogo[editingProductIndex] = {
      descricao: desc,
      unidade: unit,
      preco: price,
      desconto: discount
    };
    showMessage('Produto atualizado com sucesso!', 'sucesso');
  } else {
    // Adicionando novo produto
    catalogo.push({
      descricao: desc,
      unidade: unit,
      preco: price,
      desconto: discount
    });
    showMessage('Produto adicionado com sucesso!', 'sucesso');
  }
  
  saveCatalogo();
  renderizarCatalogoProdutos();
  limparFormularioProduto();
  
  // Atualiza os selects de produtos nos orçamentos
  atualizarSelectsProdutos();
}

function editarProdutoCatalogo(index){
  editingProductIndex = index;
  const produto = catalogo[index];
  
  document.getElementById('cat-modal-desc').value = produto.descricao;
  document.getElementById('cat-modal-unit').value = produto.unidade || 'un';
  document.getElementById('cat-modal-price').value = produto.preco;
  document.getElementById('cat-modal-discount').value = produto.desconto || 0;
  
  const addBtn = document.getElementById('cat-modal-add-btn');
  addBtn.textContent = 'Salvar Alterações';
  addBtn.classList.add('btn-save');
  
  document.getElementById('cat-modal-cancel-btn').style.display = 'inline-block';
}

function cancelarEdicaoProduto(){
  editingProductIndex = null;
  limparFormularioProduto();
  
  const addBtn = document.getElementById('cat-modal-add-btn');
  addBtn.textContent = '+ Adicionar Produto';
  addBtn.classList.remove('btn-save');
  
  document.getElementById('cat-modal-cancel-btn').style.display = 'none';
}

function limparFormularioProduto(){
  document.getElementById('cat-modal-desc').value = '';
  document.getElementById('cat-modal-unit').value = '';
  document.getElementById('cat-modal-price').value = '';
  document.getElementById('cat-modal-discount').value = '';
}

function removerProdutoCatalogo(index){
  const produto = catalogo[index];
  
  if(confirm(`Excluir o produto "${produto.descricao}"?`)){
    catalogo.splice(index, 1);
    saveCatalogo();
    renderizarCatalogoProdutos();
    showMessage('Produto removido com sucesso!', 'sucesso');
    
    // Atualiza os selects de produtos nos orçamentos
    atualizarSelectsProdutos();
    
    // Atualiza dashboard
    try { 
      if(typeof renderDashboardCounts === 'function') renderDashboardCounts(); 
    } catch(e) {}
  }
}

function atualizarSelectsProdutos(){
  // Atualiza select na aba de orçamentos
  const sel1 = document.getElementById('novo-item-select');
  if(sel1){
    sel1.innerHTML = '<option value="">Selecione um produto</option>';
    catalogo.forEach((p,i)=>{
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `${p.descricao} - ${formatarMoeda(p.preco)} / ${p.unidade}`;
      sel1.appendChild(opt);
    });
  }
  
  // Atualiza select no modal de orçamentos
  const sel2 = document.getElementById('painel-novo-item-select');
  if(sel2){
    sel2.innerHTML = '<option value="">Selecione um produto</option>';
    catalogo.forEach((p,i)=>{
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `${p.descricao} - ${formatarMoeda(p.preco)} / ${p.unidade}`;
      sel2.appendChild(opt);
    });
  }
}

function salvarCliente(){
  const currentId = document.getElementById('form-cliente').getAttribute('data-id');
  const nome = document.getElementById('cliente-nome').value.trim();
  let tel1 = document.getElementById('cliente-tel1').value.trim();
  let tel2 = document.getElementById('cliente-tel2').value.trim();
  const cep = document.getElementById('cliente-cep').value.trim();
  let doc = (document.getElementById('cliente-doc').value||"").replace(/\D/g,'');
  if(!nome){ showMessage('Nome obrigatório','erro'); return;}
  if(!tel1){ showMessage('Telefone 1 é obrigatório','erro'); return;}
  // Validação de telefone 1
  if(!telefoneValido(tel1)){
      showMessage('Telefone 1 inválido. Utilize DDD e número correto.','erro');
      document.getElementById('cliente-tel1').focus();
      return;
  }
  // Validação de telefone 2 se informado
  if(tel2 && !telefoneValido(tel2)){
      showMessage('Telefone 2 inválido. Utilize DDD e número correto.','erro');
      document.getElementById('cliente-tel2').focus();
      return;
  }
  if(!cep){ showMessage('CEP é obrigatório','erro'); return;}
  if(doc){
    if(!(doc.length===11?validarCPF(doc):doc.length===14?validarCNPJ(doc):false)){
      showMessage('CPF/CNPJ inválido','erro');
      document.getElementById('cliente-doc').focus();
      return;
    }
  }
  // valida telefone1 e telefone2
  if(!telefoneValido(tel1)){
    showMessage('Telefone 1 inválido. Utilize DDD e número correto.','erro');
    document.getElementById('cliente-tel1').focus();
    return;
  }
  if(tel2 && !telefoneValido(tel2)){
    showMessage('Telefone 2 inválido. Utilize DDD e número correto.','erro');
    document.getElementById('cliente-tel2').focus();
    return;
  }
  let status = (nome && doc) ? "Cliente" : "Lead";
  let id = currentId||Date.now();
  let cliente = clientes.find(c=>String(c.id)===String(id));
  let agora = new Date().toISOString();
  let anexos = (cliente && cliente.anexos) ? [...cliente.anexos] : [];
  let inputAnexo = document.getElementById('cliente-anexo');
  if(inputAnexo && inputAnexo.files && inputAnexo.files.length){
    for(let f of inputAnexo.files){
      anexos.push({nome:f.name,tipo:f.type, data:agora});
    }
    inputAnexo.value = "";
  }
  let obj = {
    id,
    doc,
    nome,
    telefone1:tel1,
    telefone2:tel2,
    cep: cep,
    logradouro: document.getElementById('cliente-logradouro').value.trim(),
    numero: document.getElementById('cliente-numero').value.trim(),
    complemento: document.getElementById('cliente-complemento').value.trim(),
    bairro: document.getElementById('cliente-bairro').value.trim(),
    cidade: document.getElementById('cliente-cidade').value.trim(),
    observacao: document.getElementById('cliente-observacao').value.trim(),
    anexos,
    status,
    dataCadastro: (cliente && cliente.dataCadastro) ? cliente.dataCadastro : agora,
    dataAtualizacao: agora
  };
  if(cliente){
    Object.assign(cliente,obj);
  } else {
    clientes.push(obj);
  }
  saveClientes();
  renderizarListaClientes();
  showMessage(cliente ? 'Cliente atualizado!':'Cliente cadastrado!','sucesso');
  // Após salvar, limpa o formulário do cliente
  if(typeof novoClienteForm === 'function') novoClienteForm();
}

// Função para normalizar texto: remove acentos, converte para minúsculas
function normalizarTexto(texto){
  if(!texto) return '';
  return texto.toString()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '') // Remove acentos
    .replace(/[^a-z0-9\s]/gi, ''); // Remove caracteres especiais, mantém letras, números e espaços
}

function renderizarListaClientes(){
  let tb=document.getElementById('tabela-clientes').querySelector('tbody');
  if(!tb) return;
  tb.innerHTML='';
  let busc= normalizarTexto(filtrosClientes.busca);
  let arr = clientes.filter(c=>
    (!busc || 
      normalizarTexto(c.nome).includes(busc) || 
      normalizarTexto(c.doc).includes(busc) || 
      normalizarTexto(c.telefone1).includes(busc) ||
      normalizarTexto(c.email).includes(busc) ||
      normalizarTexto(c.cidade).includes(busc)
    )
  );
  arr.sort((a,b)=>{
    let f = filtrosClientes.ordenaPor; let dir = filtrosClientes.direcao=='asc'?1:-1;
    return (a[f]||'')>(b[f]||'')?dir:-dir;
  });
  arr.forEach(c=>{
    let tr=document.createElement('tr');
    
    // Cria células individualmente para evitar problemas com caracteres especiais
    const tdNome = document.createElement('td');
    const linkNome = document.createElement('a');
    linkNome.href = '#';
    linkNome.textContent = c.nome || '';
    linkNome.onclick = (e) => { e.preventDefault(); abrirPainelCliente(c.id); return false; };
    tdNome.appendChild(linkNome);
    
    const tdDoc = document.createElement('td');
    tdDoc.textContent = c.doc || '';
    
    const tdTel = document.createElement('td');
    tdTel.textContent = c.telefone1 || '';
    
    const tdCidade = document.createElement('td');
    tdCidade.textContent = c.cidade || '';
    
    const tdData = document.createElement('td');
    tdData.textContent = formataData(c.dataAtualizacao);
    
    const tdAcoes = document.createElement('td');
    const btnEditar = document.createElement('button');
    btnEditar.textContent = 'Editar';
    btnEditar.onclick = () => editarCliente(c.id);
    
    const btnExcluir = document.createElement('button');
    btnExcluir.textContent = 'Excluir';
    btnExcluir.className = 'danger';
    btnExcluir.onclick = () => excluirCliente(c.id);
    
    tdAcoes.appendChild(btnEditar);
    tdAcoes.appendChild(document.createTextNode(' '));
    tdAcoes.appendChild(btnExcluir);
    
    tr.appendChild(tdNome);
    tr.appendChild(tdDoc);
    tr.appendChild(tdTel);
    tr.appendChild(tdCidade);
    tr.appendChild(tdData);
    tr.appendChild(tdAcoes);
    
    tb.appendChild(tr);
  });
  // Atualiza ícones de ordenação após renderizar
  if(typeof updateSortIcons==='function') updateSortIcons();
}

/* --- Painel / Modal do Cliente --- */
function abrirPainelCliente(id){
  console.log('abrirPainelCliente chamada com ID:', id);
  const c = clientes.find(x=>String(x.id)===String(id));
  if(!c) {
    console.error('Cliente não encontrado com ID:', id);
    return showMessage('Cliente não encontrado','erro');
  }
  console.log('Cliente encontrado:', c.nome);
  popularPainelCliente(c);
  const modal = document.getElementById('cliente-modal');
  if(modal) {
    modal.style.display = 'flex';
    console.log('Modal do cliente aberto');
  } else {
    console.error('Modal cliente-modal não encontrado');
  }
  // garantimos que não existam botões Salvar/Cancelar nas laterais após abrir
  if(typeof cleanupModalSideButtons === 'function') cleanupModalSideButtons();
  // attach click-outside handler to close when clicking overlay
  function onOverlayClick(e){
    if(e.target && e.target.id === 'cliente-modal'){
      fecharPainelCliente();
    }
  }
  // attach Esc key to close
  function onEsc(e){ if(e.key === 'Escape'){ fecharPainelCliente(); } }
  // store handlers so we can remove them later
  modal.__onOverlayClick = onOverlayClick;
  modal.__onEsc = onEsc;
  modal.addEventListener('click', onOverlayClick);
  document.addEventListener('keydown', onEsc);
}

function fecharPainelCliente(){
  const modal = document.getElementById('cliente-modal');
  if(!modal) return;
  modal.style.display = 'none';
}

// Abre formulário de cadastro limpo (novo cliente)
function abrirCadastroCliente(){
  if(window.__modalClosing){ console.debug('abrirCadastroCliente: suppressed because modal is closing'); return; }
  // reset form fields
  const f = document.getElementById('form-cliente');
  if(f){
    f.reset();
    f.removeAttribute('data-id');
  }
  // ensure painel modal uses empty data
  const modal = document.getElementById('cliente-modal');
  const clienteIdInput = document.getElementById('painel-cliente-id');
  if(clienteIdInput) clienteIdInput.value = '';
  // Hide inline form (we'll use the modal instead)
  try{ const form = document.getElementById('form-cliente'); if(form) form.style.display = 'none'; }catch(e){}
  // Hide the clients table while modal is open
  try{ const tbl = document.getElementById('tabela-clientes'); const icon = document.getElementById('clientes-header-icon'); if(tbl) tbl.style.display = 'none'; if(icon) icon.textContent = '▸'; }catch(e){}
  // Open the modal for a new client
  try{
    // ensure modal fields are empty via popularPainelCliente on an empty object
    const empty = { id: '', nome: '', doc:'', telefone1:'', telefone2:'', cep:'', logradouro:'', numero:'', complemento:'', bairro:'', cidade:'', observacao:'', anexos:[], observacoes:[] };
    popularPainelCliente(empty);
    if(modal){
      // clear any stale overlay-close handlers if present
      try{ if(modal.__removeOverlayClose && typeof modal.__removeOverlayClose === 'function'){ modal.__removeOverlayClose(); } }catch(e){}
      modal.hidden = false;
      modal.style.display = 'flex';
      modal.style.visibility = 'visible';
      modal.style.opacity = '1';
      modal.style.pointerEvents = '';
      modal.setAttribute('aria-hidden', 'false');
    }
    // focus first input inside modal after it opens
    setTimeout(()=>{ const el = document.getElementById('painel-cliente-nome'); if(el) el.focus(); },120);
  }catch(e){ console.warn('abrirCadastroCliente modal open failed', e); }
}

// Mostrar lista de clientes e focar a tabela
function abrirListaClientes(){
  // renderiza e garante que a lista esteja visível
  try{ 
    if(typeof renderizarListaClientes==='function') {
      renderizarListaClientes(); 
    }
  }catch(e){
    console.error('Erro ao renderizar lista:', e);
  }
  // Hide inline cadastro form and show the table
  try{
    const tb = document.getElementById('tabela-clientes');
    const icon = document.getElementById('clientes-header-icon');
    const form = document.getElementById('form-cliente');
    if(form){ form.style.display = 'none'; }
    if(tb){ 
      tb.style.display = 'table'; 
      tb.scrollIntoView({behavior:'smooth',block:'start'}); 
    }
    if(icon) icon.textContent = '▾';
  }catch(e){
    console.error('Erro ao mostrar tabela:', e);
  }
}

function abrirBuscaCliente(){
  const modal = document.getElementById('busca-cliente-modal');
  const input = document.getElementById('busca-cliente-input');
  const resultados = document.getElementById('busca-cliente-resultados');
  
  if(modal) modal.style.display = 'flex';
  if(input) {
    input.value = '';
    setTimeout(() => input.focus(), 100);
  }
  if(resultados) {
    resultados.innerHTML = '<div style="color:#999;text-align:center;padding:40px">Digite para buscar clientes...</div>';
  }
}

function fecharBuscaCliente(){
  const modal = document.getElementById('busca-cliente-modal');
  if(modal) modal.style.display = 'none';
}

function realizarBuscaCliente(){
  const input = document.getElementById('busca-cliente-input');
  const resultados = document.getElementById('busca-cliente-resultados');
  if(!input || !resultados) return;
  
  const termo = normalizarTexto(input.value.trim());
  
  if(!termo){
    resultados.innerHTML = '<div style="color:#999;text-align:center;padding:40px">Digite para buscar clientes...</div>';
    return;
  }
  
  const clientes = loadClientes();
  const encontrados = clientes.filter(c => {
    // Busca normalizada em todos os campos (ignora acentos, maiúsculas/minúsculas e caracteres especiais)
    return (
      normalizarTexto(c.nome).includes(termo) ||
      normalizarTexto(c.doc).includes(termo) ||
      normalizarTexto(c.telefone1).includes(termo) ||
      normalizarTexto(c.telefone2).includes(termo) ||
      normalizarTexto(c.email).includes(termo) ||
      normalizarTexto(c.cep).includes(termo) ||
      normalizarTexto(c.logradouro).includes(termo) ||
      normalizarTexto(c.numero).includes(termo) ||
      normalizarTexto(c.complemento).includes(termo) ||
      normalizarTexto(c.bairro).includes(termo) ||
      normalizarTexto(c.cidade).includes(termo)
    );
  });
  
  if(encontrados.length === 0){
    resultados.innerHTML = `
      <div style="color:#999;text-align:center;padding:40px">
        <div style="font-size:48px;margin-bottom:12px">🔍</div>
        <div>Nenhum cliente encontrado para "<strong>${termo}</strong>"</div>
      </div>
    `;
    return;
  }
  
  // Renderiza os resultados
  let html = `<div style="margin-bottom:12px;color:#666;font-size:14px">Encontrado${encontrados.length > 1 ? 's' : ''} <strong>${encontrados.length}</strong> cliente${encontrados.length > 1 ? 's' : ''}:</div>`;
  
  encontrados.forEach(c => {
    html += `
      <div onclick="abrirClienteDaBusca('${c.id}')" style="padding:12px;border:1px solid #eee;border-radius:6px;margin-bottom:8px;cursor:pointer;transition:all 0.2s" 
        onmouseover="this.style.background='#f5f5f5';this.style.borderColor='#2b76d2'" 
        onmouseout="this.style.background='#fff';this.style.borderColor='#eee'">
        <div style="font-weight:600;color:#333;margin-bottom:4px">👤 ${c.nome || 'Sem nome'}</div>
        <div style="font-size:13px;color:#666;display:flex;gap:16px;flex-wrap:wrap">
          ${c.doc ? `<span>📄 ${c.doc}</span>` : ''}
          ${c.telefone1 ? `<span>📞 ${c.telefone1}</span>` : ''}
          ${c.email ? `<span>📧 ${c.email}</span>` : ''}
          ${c.cidade ? `<span>📍 ${c.cidade}</span>` : ''}
        </div>
      </div>
    `;
  });
  
  resultados.innerHTML = html;
}

function abrirClienteDaBusca(clienteId){
  fecharBuscaCliente();
  abrirPainelCliente(clienteId);
}

function showPainelActions(){
  const bar = document.getElementById('painel-cliente-actions');
  if(!bar) return;
  // move the bar to body so it's not hidden by modal stacking or parent display:none
  try{
    if(bar.parentNode !== document.body){ document.body.appendChild(bar); }
  } catch(e){ console.warn('showPainelActions move failed', e); }
  bar.style.display='flex';
  bar.style.zIndex = '99999';
  bar.style.background='rgba(255,255,255,0.98)';
  bar.style.boxShadow='0 8px 24px rgba(0,0,0,0.12)';
  console.log('showPainelActions: actions bar visible');
  positionPainelActions();
  window.addEventListener('resize', positionPainelActions);
  window.addEventListener('scroll', positionPainelActions, true);
}
function hidePainelActions(){
  const bar = document.getElementById('painel-cliente-actions');
  if(!bar) return;
  bar.style.display='none';
  window.removeEventListener('resize', positionPainelActions);
  window.removeEventListener('scroll', positionPainelActions, true);
}
function positionPainelActions(){
  const modal = document.getElementById('cliente-modal');
  const bar = document.getElementById('painel-cliente-actions');
  if(!modal || !bar) return;
  try{
    // tenta obter o content do modal (o filho direto do overlay)
    const modalContent = modal.querySelector(':scope > div') || modal.firstElementChild;
    const modalRect = modalContent ? modalContent.getBoundingClientRect() : modal.getBoundingClientRect();
    const footer = document.getElementById('cliente-modal-footer');
    const footerHeight = footer ? footer.getBoundingClientRect().height : 0;
    // Se houver espaço à direita do modal, fixa o bar alinhado a essa margem
    if(window.innerWidth > 720 && modalRect.width < window.innerWidth){
      const spaceRight = window.innerWidth - modalRect.right;
      const right = Math.max(12, spaceRight + 12);
      bar.style.right = `${right}px`;
      bar.style.left = 'auto';
      // limita largura máxima para não ultrapassar modal
      bar.style.maxWidth = `${Math.min(420, window.innerWidth - modalRect.width - 48)}px`;
    } else {
      // mobile / narrow: full width with small margins
      bar.style.left = '12px';
      bar.style.right = '12px';
      bar.style.maxWidth = 'none';
    }
    bar.style.bottom = `${footerHeight + 20}px`;
    bar.style.display = 'flex';
  } catch(e){
    console.warn('positionPainelActions fallback', e);
    // fallback: center bottom
    bar.style.left = '12px';
    bar.style.right = '12px';
    bar.style.bottom = '90px';
    bar.style.display = 'flex';
  }
}

function popularPainelCliente(c){
  document.getElementById('painel-cliente-nome').value = c.nome||'';
  document.getElementById('painel-cliente-doc').value = c.doc||'';
  document.getElementById('painel-cliente-tel1').value = c.telefone1||'';
  document.getElementById('painel-cliente-tel2').value = c.telefone2||'';
  document.getElementById('painel-cliente-email').value = c.email||'';
  document.getElementById('painel-cliente-cep').value = c.cep||'';
  document.getElementById('painel-cliente-logradouro').value = c.logradouro||'';
  document.getElementById('painel-cliente-numero').value = c.numero||'';
  document.getElementById('painel-cliente-complemento').value = c.complemento||'';
  document.getElementById('painel-cliente-bairro').value = c.bairro||'';
  document.getElementById('painel-cliente-cidade').value = c.cidade||'';
  document.getElementById('painel-cliente-observacao').value = c.observacao||'';
  // anexos
  if(!c.anexos) c.anexos = [];
  renderizarAnexosModal(c.anexos);
  // observações
  if(!c.observacoes) c.observacoes = [];
  renderizarObservacoesModal(c.observacoes);
  // inicializa ícones de ordenação das observações
  ordenarObservacoes('data');
  // Áreas destacadas (espaços para orçamentos/pedidos/histórico)
  document.getElementById('painel-orcamentos').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <strong class="panel-heading">Orçamentos em aberto</strong>
      <button onclick="event.stopPropagation(); novoOrcamentoCliente('${c.id}')" style="padding:6px 12px;font-size:13px;background:#2b76d2;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600">+ Novo Orçamento</button>
    </div>
    <div style="padding:8px;color:#666;font-size:13px">Nenhum orçamento em aberto</div>
  `;
  document.getElementById('painel-pedidos').innerHTML = '<div style="padding:8px;color:#666">Pedidos em aberto (placeholder)</div>';
  document.getElementById('painel-historico').innerHTML = '<div style="padding:8px;color:#666">Histórico de pedidos finalizados (placeholder)</div>';
  // Remove qualquer botão Salvar/Cancelar dentro das áreas laterais para evitar duplicação
  ['painel-orcamentos','painel-pedidos','painel-historico'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    const buttons = el.querySelectorAll('button');
    buttons.forEach(b=>{
      const txt = (b.textContent||'').trim().toLowerCase();
      if(txt==='salvar' || txt==='cancelar' || txt.includes('salvar') || txt.includes('cancelar')) b.remove();
    });
  });
  // Guarda id atual
  document.getElementById('cliente-modal').setAttribute('data-id', c.id);
  // Se houver CEP, valide-o e habilite/desabilite campos conforme resultado
  const cepVal = document.getElementById('painel-cliente-cep').value.replace(/\D/g,'');
  if(cepVal && cepVal.length===8){
    // dispara validação/auto-preenchimento (não bloqueante)
    buscarEnderecoModal(true);
  } else {
    // se não há CEP, deixa campos editáveis para permitir edição manual
    setAddressFieldsModal(true);
  }
}

function salvarPainelCliente(){
  const id = document.getElementById('cliente-modal').getAttribute('data-id');
  const c = clientes.find(x=>String(x.id)===String(id));
  // If modal was opened for a new client, create a new record
  let clienteObj = c || null;
  if(!clienteObj){
    // require CPF/CNPJ for modal saves
    const mustDoc = (document.getElementById('painel-cliente-doc')&& (document.getElementById('painel-cliente-doc').value||'').replace(/\D/g,'')) || '';
    if(!mustDoc){
      showMessage('preenchimento obrigatório','erro');
      const docEl = document.getElementById('painel-cliente-doc'); if(docEl){ setFieldError(docEl,'preenchimento obrigatório'); docEl.focus(); }
      return;
    }
    // create a minimal client object and push to clients so further code updates it
    clienteObj = { id: Date.now().toString(), anexos:[], observacoes:[] };
    clientes.push(clienteObj);
    // persist the new id on the modal so subsequent saves/edits target the record
    try{ document.getElementById('cliente-modal').setAttribute('data-id', clienteObj.id); }catch(e){}
  }
  const novoDoc = (document.getElementById('painel-cliente-doc').value||'').replace(/\D/g,'');
  const novoTel1 = document.getElementById('painel-cliente-tel1').value.trim();
  const novoTel2 = document.getElementById('painel-cliente-tel2').value.trim();
  // continue using clienteObj from now on
  const cRef = clienteObj;
  // valida CPF/CNPJ (required for modal save)
  if(!novoDoc){ showMessage('preenchimento obrigatório','erro'); const docEl = document.getElementById('painel-cliente-doc'); if(docEl){ setFieldError(docEl,'preenchimento obrigatório'); docEl.focus(); } return; }
  if(!(novoDoc.length===11?validarCPF(novoDoc):novoDoc.length===14?validarCNPJ(novoDoc):false)){
    showMessage('CPF/CNPJ inválido','erro');
    document.getElementById('painel-cliente-doc').focus();
    return;
  }
  // valida usando validadores com marcação de campo
  if(!validarDocModal()) return;
  if(!validarTelModal(1)) return;
  if(!validarTelModal(2)) return;
  // valida telefones
  if(!telefoneValido(novoTel1)){
    showMessage('Telefone 1 inválido. Utilize DDD e número correto.','erro');
    document.getElementById('painel-cliente-tel1').focus();
    return;
  }
  if(novoTel2 && !telefoneValido(novoTel2)){
    showMessage('Telefone 2 inválido. Utilize DDD e número correto.','erro');
    document.getElementById('painel-cliente-tel2').focus();
    return;
  }
  cRef.nome = document.getElementById('painel-cliente-nome').value.trim();
  cRef.doc = novoDoc;
  cRef.telefone1 = novoTel1;
  cRef.telefone2 = novoTel2;
  cRef.cep = document.getElementById('painel-cliente-cep').value.trim();
  cRef.logradouro = document.getElementById('painel-cliente-logradouro').value.trim();
  cRef.numero = document.getElementById('painel-cliente-numero').value.trim();
  cRef.complemento = document.getElementById('painel-cliente-complemento').value.trim();
  cRef.bairro = document.getElementById('painel-cliente-bairro').value.trim();
  cRef.cidade = document.getElementById('painel-cliente-cidade').value.trim();
  cRef.observacao = document.getElementById('painel-cliente-observacao').value.trim();
  // opcional: email do cliente
  cRef.email = (document.getElementById('painel-cliente-email') && document.getElementById('painel-cliente-email').value) ? document.getElementById('painel-cliente-email').value.trim() : '';
  cRef.dataAtualizacao = new Date().toISOString();
  
  // Salva os dados de forma segura
  try {
    saveClientes();
    console.log('Dados salvos com sucesso');
    
    // Atualiza a lista com ordenação por data (mais recente primeiro)
    if(typeof renderizarListaClientes === 'function') {
      renderizarListaClientes();
    }
    if(typeof updateSortIcons === 'function') {
      updateSortIcons(); // Atualiza os ícones de ordenação
    }
    console.log('Lista renderizada e ordenada');
    
    showMessage('Cliente salvo','sucesso');
    console.log('Mensagem exibida');
    
  } catch(e) {
    console.error('Erro ao salvar:', e);
    showMessage('Erro ao salvar cliente','erro');
  }
  
  // Fecha o modal - SEMPRE executar, mesmo se houver erro
  try {
    const modal = document.getElementById('cliente-modal');
    if(modal) {
      modal.style.display = 'none';
      console.log('Modal fechado');
    } else {
      console.error('Modal não encontrado!');
    }
  } catch(e) {
    console.error('Erro ao fechar modal:', e);
  }
}

// Helpers para indicar erro em campo
function setFieldError(el,msg){
  if(!el) return;
  if(typeof el === 'string') el = document.getElementById(el);
  if(!el) return;
  el.style.border = '1px solid #e03a3a';
  let hint = el.nextElementSibling;
  if(!hint || !hint.classList || !hint.classList.contains('field-err')){
    hint = document.createElement('div'); hint.className='field-err'; hint.style.color='#e03a3a'; hint.style.fontSize='12px'; hint.style.marginTop='4px'; el.parentNode.insertBefore(hint, el.nextSibling);
  }
  hint.textContent = msg||'';
}

// Remove botões Salvar/Cancelar (ou que tenham onclick para salvar/fechar) dentro do modal,
// preservando apenas os botões do rodapé (`cliente-modal-footer`).
function cleanupModalSideButtons(){
  const modal = document.getElementById('cliente-modal');
  if(!modal) return;
  const footer = document.getElementById('cliente-modal-footer');
  // Seleciona todos os botões dentro do modal exceto os que estejam no footer
  const buttons = Array.from(modal.querySelectorAll('button'));
  buttons.forEach(b=>{
    if(footer && footer.contains(b)) return; // preserva botões do footer
    // preserva explicitamente botões marcados com data-preserve ou dentro do painel de ações
    if(b.dataset && b.dataset.preserve==='true') return;
    const actionsPanel = document.getElementById('painel-cliente-actions');
    if(actionsPanel && actionsPanel.contains(b)) return;
    const txt = (b.textContent||'').trim().toLowerCase();
    const onclick = (b.getAttribute('onclick')||'').toLowerCase();
    if(txt.includes('salvar') || txt.includes('cancelar') || onclick.includes('salvarpainelcliente') || onclick.includes('fecharpainelcliente')){
      b.remove();
    }
  });
}
function clearFieldError(el){
  if(!el) return;
  if(typeof el === 'string') el = document.getElementById(el);
  if(!el) return;
  el.style.border='';
  let hint = el.parentNode.querySelector('.field-err');
  if(hint) hint.remove();
}

function validarDocModal(){
  const el = document.getElementById('painel-cliente-doc'); if(!el) return true;
  const val = (el.value||'').replace(/\D/g,'');
  if(!val){ clearFieldError(el); return true; }
  const ok = (val.length===11?validarCPF(val):val.length===14?validarCNPJ(val):false);
  if(!ok){ setFieldError(el,'CPF/CNPJ inválido'); el.focus(); return false; }
  clearFieldError(el); return true;
}

function validarTelModal(which){
  const id = which===2? 'painel-cliente-tel2' : 'painel-cliente-tel1';
  const el = document.getElementById(id); if(!el) return true;
  const val = (el.value||'').trim();
  if(which===2 && !val){ clearFieldError(el); return true; }
  if(!telefoneValido(val)) { setFieldError(el,'Telefone inválido'); el.focus(); return false; }
  clearFieldError(el); return true;
}

// Observações: toggle input
function toggleObservacaoInput(){
  const main = document.getElementById('painel-cliente-observacao');
  if(!main) return;
  // toggle visibility by focusing/clearing placeholder; we will visually indicate insertion mode by focusing the textarea
  if(document.activeElement===main){ main.blur(); }
  else { main.focus(); }
}

function adicionarObservacaoModal(){
  try{
    console.debug('adicionarObservacaoModal: start');
    const id = document.getElementById('cliente-modal').getAttribute('data-id');
    console.debug('adicionarObservacaoModal: modal data-id', id);
    const cliente = clientes.find(x=>String(x.id)===String(id));
    let clienteObj = cliente || null;
    // If modal was opened for a new client (no existing record), create a minimal client record so observations can be attached
    if(!clienteObj){
      const nomeTmp = (document.getElementById('painel-cliente-nome') && document.getElementById('painel-cliente-nome').value) ? document.getElementById('painel-cliente-nome').value.trim() : '';
      const docTmp = (document.getElementById('painel-cliente-doc') && document.getElementById('painel-cliente-doc').value) ? (document.getElementById('painel-cliente-doc').value||'').replace(/\D/g,'') : '';
      clienteObj = { id: Date.now().toString(), nome: nomeTmp, doc: docTmp, telefone1: (document.getElementById('painel-cliente-tel1')?document.getElementById('painel-cliente-tel1').value.trim() : ''), telefone2: (document.getElementById('painel-cliente-tel2')?document.getElementById('painel-cliente-tel2').value.trim() : ''), anexos:[], observacoes:[] };
      clientes.push(clienteObj);
      try{ document.getElementById('cliente-modal').setAttribute('data-id', clienteObj.id); }catch(e){}
    }
    const textoEl = document.getElementById('painel-cliente-observacao');
    if(!textoEl) return showMessage('Campo de observação não encontrado','erro');
    const texto = textoEl.value.trim();
    if(!texto) return showMessage('Escreva a observação antes de adicionar','erro');
    if(!clienteObj.observacoes) clienteObj.observacoes = [];
    const obs = {texto, data:new Date().toISOString(), usuario: (window.__usuario_atual||'local') };
    clienteObj.observacoes.push(obs);
    // sempre ordenar mais recente primeiro
    clienteObj.observacoes.sort((a,b)=> (a.data<b.data)?1:-1 );
    try{ saveClientes(); }catch(e){ console.warn('saveClientes failed', e); }
    // Clear input and re-render observations
    textoEl.value = '';
    // re-query client by id to get canonical object reference
    const canonicalId = clienteObj.id;
    const canonical = clientes.find(x=>String(x.id)===String(canonicalId)) || clienteObj;
    renderizarObservacoesModal(canonical.observacoes);
    // small delay so DOM is updated, then scroll wrapper and focus
    setTimeout(()=>{
      try{
        const tb = document.getElementById('painel-observacoes-tbody');
        if(tb){
          // tb -> tbody, tb.parentElement -> table, table.parentElement -> wrapper div
          let wrapper = null;
          if(tb.parentElement && tb.parentElement.tagName && tb.parentElement.tagName.toLowerCase()==='table'){
            wrapper = tb.parentElement.parentElement;
          }
          if(!wrapper) wrapper = tb.closest('div');
          if(wrapper && typeof wrapper.scrollTop !== 'undefined') wrapper.scrollTop = 0;
        }
      }catch(e){ console.warn('scroll failed', e); }
      try{ textoEl.focus(); }catch(e){}
    }, 40);
    try{ if(typeof renderizarListaClientes === 'function') renderizarListaClientes(); }catch(e){}
    console.debug('adicionarObservacaoModal: done, obs added to client', canonicalId);
    showMessage('Observação adicionada','sucesso');
  }catch(err){ console.error('adicionarObservacaoModal error', err); showMessage('Erro ao adicionar observação','erro'); }
}

function renderizarObservacoesModal(observacoes){
  const tb = document.getElementById('painel-observacoes-tbody'); if(!tb) return;
  tb.innerHTML='';
  if(!observacoes || observacoes.length===0){ tb.innerHTML='<tr><td colspan="3" style="padding:8px;color:#666">Nenhuma observação</td></tr>'; return; }
  observacoes.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td style="padding:6px;border-top:1px solid #eee">${escapeHtml(o.texto)}</td><td style="padding:6px;border-top:1px solid #eee">${formataData(o.data)}</td><td style="padding:6px;border-top:1px solid #eee">${escapeHtml(o.usuario||'local')}</td>`;
    // apply fade-in to the first row (newest) for emphasis
    if(tb.children.length===0){ tr.classList.add('obs-fade'); }
    tb.appendChild(tr);
  });
}

function ordenarObservacoes(campo){
  if(filtrosObservacao.ordenaPor===campo) filtrosObservacao.direcao = filtrosObservacao.direcao==='asc'?'desc':'asc';
  else { filtrosObservacao.ordenaPor = campo; filtrosObservacao.direcao='desc'; }
  // reordena a observações do cliente atual e re-renderiza
  const id = document.getElementById('cliente-modal').getAttribute('data-id');
  const cliente = clientes.find(x=>String(x.id)===String(id)); if(!cliente || !cliente.observacoes) return;
  cliente.observacoes.sort((a,b)=>{
    let dir = filtrosObservacao.direcao==='asc'?1:-1;
    let A = a[filtrosObservacao.ordenaPor]||'';
    let B = b[filtrosObservacao.ordenaPor]||'';
    if(filtrosObservacao.ordenaPor==='data') { A=a.data; B=b.data; return (A>B)?-dir:dir; }
    return (A>B)?dir:-dir;
  });
  renderizarObservacoesModal(cliente.observacoes);
  // update icons
  ['texto','data','usuario'].forEach(f=>{ const el=document.getElementById('sort-obs-'+f); if(!el) return; el.textContent = filtrosObservacao.ordenaPor===f ? (filtrosObservacao.direcao==='asc'?'▲':'▼') : '↕'; });
}

// Enhancements to attachment viewer: toggle close by clicking the body and open in new tab
function abrirAnexoSlide(anexos, index){
  const a = anexos[index];
  if(!a) return;
  const body = document.getElementById('anexo-slide-body'); body.innerHTML='';
  const title = document.getElementById('anexo-slide-title'); title.textContent = a.nome;
  // create viewer element
  if(a._url){
    if(a.tipo && a.tipo.startsWith('image/')){
      const img = document.createElement('img'); img.src = a._url; img.style.maxWidth='100%'; img.style.height='auto'; img.style.cursor='pointer'; img.onclick = ()=>{ fecharAnexoSlide(); };
      body.appendChild(img);
    } else if(a.tipo && a.tipo.includes('pdf')){
      const iframe = document.createElement('iframe'); iframe.src = a._url; iframe.style.width='100%'; iframe.style.height='80vh'; iframe.style.cursor='pointer'; iframe.onclick = ()=>{ fecharAnexoSlide(); };
      body.appendChild(iframe);
    } else {
      // For other types, show a download/open link
      const p = document.createElement('div'); p.style.display='flex'; p.style.flexDirection='column'; p.style.gap='8px';
      const info = document.createElement('div'); info.textContent = 'Tipo: '+(a.tipo||'desconhecido')+' · Tamanho: '+(a.tamanho?Math.round(a.tamanho/1024)+'KB':'-');
      const btnOpen = document.createElement('button'); btnOpen.textContent='Abrir em nova aba'; btnOpen.onclick = ()=>{ window.open(a._url,'_blank'); };
      p.appendChild(info); p.appendChild(btnOpen);
      p.onclick = ()=>{ fecharAnexoSlide(); };
      body.appendChild(p);
    }
  } else {
    const p = document.createElement('div'); p.textContent = 'Visualização não disponível para este arquivo.'; p.style.cursor='pointer'; p.onclick=()=>{ fecharAnexoSlide(); };
    body.appendChild(p);
  }
  const actions = document.getElementById('anexo-slide-actions'); actions.innerHTML = '';
  const btnDel = document.createElement('button'); btnDel.className='danger'; btnDel.textContent='Excluir anexo'; btnDel.onclick = (ev)=>{ ev.stopPropagation(); const id = document.getElementById('cliente-modal').getAttribute('data-id'); excluirAnexoModal(index); fecharAnexoSlide(); };
  const btnOpen2 = document.createElement('button'); btnOpen2.textContent='Abrir em nova aba'; btnOpen2.onclick = ()=>{ if(a._url) window.open(a._url,'_blank'); };
  actions.appendChild(btnOpen2); actions.appendChild(btnDel);
  const slide = document.getElementById('anexo-slide'); slide.style.transform='translateX(0)';
}


// Busca de endereço para o modal (reusa viacep)
function buscarEnderecoModal(force){
  const cepEl = document.getElementById('painel-cliente-cep');
  const cep = (cepEl && cepEl.value||'').replace(/\D/g, '');
  return new Promise((resolve)=>{
    if(cep.length!==8){
      if(force) setFieldError('painel-cliente-cep','CEP inválido');
      setAddressFieldsModal(false);
      return resolve(false);
    }
    fetch('https://viacep.com.br/ws/'+cep+'/json/').then(r=>r.json()).then(data=>{
      if(force) console.debug('buscarEnderecoModal viaCEP response for',cep,data);
      if(data.erro){
        setFieldError('painel-cliente-cep','CEP não encontrado');
        setAddressFieldsModal(false);
        return resolve(false);
      } else {
        clearFieldError('painel-cliente-cep');
        document.getElementById('painel-cliente-logradouro').value = data.logradouro||'';
        document.getElementById('painel-cliente-bairro').value = data.bairro||'';
        document.getElementById('painel-cliente-cidade').value = data.localidade||'';
        setAddressFieldsModal(true);
        return resolve(true);
      }
    }).catch(()=>{
      if(force) setFieldError('painel-cliente-cep','Erro ao buscar CEP');
      setAddressFieldsModal(false);
      return resolve(false);
    });
  });
}

function setAddressFieldsModal(enable){
  const ids = ['painel-cliente-logradouro','painel-cliente-numero','painel-cliente-complemento','painel-cliente-bairro','painel-cliente-cidade'];
  ids.forEach(id=>{ const el=document.getElementById(id); if(el){ el.readOnly = !enable; el.disabled = !enable; if(!enable) el.value=''; }});
}

// Valida CEP, preenche campos do formulário ou do modal e retorna Promise<boolean>
function validarEPreencherCEP(cep, target){
  return new Promise((resolve)=>{
    try{
      const only = (cep||'').replace(/\D/g,'');
      if(only.length!==8) return resolve(false);
      fetch('https://viacep.com.br/ws/'+only+'/json/').then(r=>r.json()).then(data=>{
  if(!data || data.erro) return resolve(false);
  if(target==='modal') console.debug('validarEPreencherCEP modal response for', only, data);
  const returnedCep = (data.cep||'').replace(/\D/g,'');
  const onlyReq = only;
  if(returnedCep && returnedCep!==onlyReq) return resolve(false);
  // Rejeita se ViaCEP não retornar nenhum dado de endereço
  if(!(data.logradouro||data.bairro||data.localidade)) return resolve(false);
        // preenche campos apropriados
        if(target==='modal'){
          const elCep = document.getElementById('painel-cliente-cep'); if(elCep) clearFieldError(elCep);
          const elL = document.getElementById('painel-cliente-logradouro'); if(elL) elL.value = data.logradouro||'';
          const elB = document.getElementById('painel-cliente-bairro'); if(elB) elB.value = data.bairro||'';
          const elC = document.getElementById('painel-cliente-cidade'); if(elC) elC.value = data.localidade||'';
        } else {
          const elCep = document.getElementById('cliente-cep'); if(elCep) clearFieldError(elCep);
          const elL = document.getElementById('cliente-logradouro'); if(elL) elL.value = data.logradouro||'';
          const elB = document.getElementById('cliente-bairro'); if(elB) elB.value = data.bairro||'';
          const elC = document.getElementById('cliente-cidade'); if(elC) elC.value = data.localidade||'';
        }
        resolve(true);
      }).catch(()=>resolve(false));
    }catch(e){ resolve(false); }
  });
}

// Anexos: adicionar via input do modal
function adicionarAnexosModal(){
  const input = document.getElementById('painel-cliente-anexo');
  const id = document.getElementById('cliente-modal').getAttribute('data-id');
  const cliente = clientes.find(x=>String(x.id)===String(id));
  if(!cliente) return showMessage('Cliente não encontrado','erro');
  if(!input || !input.files || input.files.length===0) return showMessage('Selecione arquivos para anexar','erro');
  if(!cliente.anexos) cliente.anexos = [];
  
  // Processa cada arquivo
  let processados = 0;
  const total = input.files.length;
  
  for(let f of input.files){
    const reader = new FileReader();
    reader.onload = function(e){
      // Armazena como base64 para persistir no localStorage
      cliente.anexos.push({
        nome: f.name,
        tipo: f.type,
        tamanho: f.size,
        data: new Date().toISOString(),
        conteudo: e.target.result // base64 data URL
      });
      processados++;
      if(processados === total){
        input.value='';
        renderizarAnexosModal(cliente.anexos);
        saveClientes();
        showMessage('Anexos adicionados','sucesso');
      }
    };
    reader.onerror = function(){
      // Fallback: salva só os metadados
      cliente.anexos.push({nome:f.name,tipo:f.type,tamanho:f.size,data:new Date().toISOString()});
      processados++;
      if(processados === total){
        input.value='';
        renderizarAnexosModal(cliente.anexos);
        saveClientes();
        showMessage('Anexos adicionados (alguns sem conteúdo)','erro');
      }
    };
    reader.readAsDataURL(f);
  }
}

function renderizarAnexosModal(anexos){
  const box = document.getElementById('painel-cliente-anexos'); box.innerHTML='';
  if(!anexos || anexos.length===0) { box.innerHTML='<div style="color:#666">Nenhum anexo</div>'; return; }
  anexos.forEach((a,i)=>{
    const el = document.createElement('div');
    el.style.display='flex'; el.style.alignItems='center'; el.style.gap='6px'; el.style.padding='6px'; el.style.border='1px solid #eee'; el.style.borderRadius='6px';
    el.style.cursor='pointer';
    const ico = document.createElement('div'); ico.style.width='36px'; ico.style.height='36px'; ico.style.display='flex'; ico.style.alignItems='center'; ico.style.justifyContent='center'; ico.style.borderRadius='4px'; ico.style.background='#fafafa'; ico.style.border='1px solid #ddd';
    ico.textContent = a.tipo && a.tipo.startsWith('image/') ? '🖼️' : (a.tipo && a.tipo.includes('pdf') ? '📄' : '📎');
    const nome = document.createElement('div'); nome.textContent = a.nome; nome.style.flex='1'; nome.style.fontSize='13px'; nome.style.color='#333';
    const del = document.createElement('button'); del.textContent='Excluir'; del.className='danger'; del.onclick = (ev)=>{ ev.stopPropagation(); excluirAnexoModal(i); };
    el.appendChild(ico); el.appendChild(nome); el.appendChild(del);
    el.onclick = ()=>{ abrirAnexoSlide(anexos,i); };
    box.appendChild(el);
  });
}

function abrirAnexoSlide(anexos, index){
  const a = anexos[index];
  if(!a) return;
  const body = document.getElementById('anexo-slide-body'); body.innerHTML='';
  const title = document.getElementById('anexo-slide-title'); title.textContent = a.nome;
  
  // Usa 'conteudo' (base64) se disponível, senão tenta _url (temporário)
  let src = a.conteudo || a._url;
  
  // Verifica DWG/DXF PRIMEIRO (antes de image/), pois alguns navegadores classificam DWG como image/vnd.dwg
  if(src && (a.nome.toLowerCase().endsWith('.dwg') || a.nome.toLowerCase().endsWith('.dxf') || (a.tipo && (a.tipo.includes('dwg') || a.tipo.includes('dxf') || a.tipo.includes('acad'))))){
    // Arquivos DWG/DXF (AutoCAD)
    const container = document.createElement('div');
    container.style.padding='20px';
    container.style.background='linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    container.style.borderRadius='8px';
    container.style.color='#fff';
    container.style.textAlign='center';
    
    const icon = document.createElement('div');
    icon.style.fontSize='80px';
    icon.style.marginBottom='20px';
    icon.textContent = '📐';
    
    const title = document.createElement('h3');
    title.style.margin='0 0 10px 0';
    title.style.color='#fff';
    title.textContent = 'Arquivo AutoCAD';
    
    const fileName = document.createElement('div');
    fileName.style.fontSize='16px';
    fileName.style.marginBottom='20px';
    fileName.style.fontWeight='600';
    fileName.textContent = a.nome;
    
    const info = document.createElement('div');
    info.style.background='rgba(255,255,255,0.2)';
    info.style.padding='15px';
    info.style.borderRadius='6px';
    info.style.marginBottom='20px';
    info.style.fontSize='14px';
    info.innerHTML = `
      <div style="margin-bottom:8px">📄 Formato: ${a.nome.toLowerCase().endsWith('.dwg') ? 'DWG' : 'DXF'}</div>
      <div style="margin-bottom:8px">📏 Tipo: Desenho técnico CAD</div>
      ${a.tamanho ? `<div>💾 Tamanho: ${(a.tamanho / 1024).toFixed(2)} KB</div>` : ''}
    `;
    
    const instructions = document.createElement('div');
    instructions.style.background='rgba(255,255,255,0.15)';
    instructions.style.padding='15px';
    instructions.style.borderRadius='6px';
    instructions.style.marginBottom='20px';
    instructions.style.fontSize='13px';
    instructions.style.lineHeight='1.6';
    instructions.innerHTML = `
      <div style="font-weight:600;margin-bottom:8px">💡 Para visualizar este arquivo:</div>
      <div style="text-align:left;padding-left:20px">
        • Baixe o arquivo usando o botão abaixo<br>
        • Abra com AutoCAD, DraftSight ou LibreCAD<br>
        • Visualizadores online: Autodesk Viewer, ShareCAD<br>
        • Conversores: CloudConvert (DWG → PDF)
      </div>
    `;
    
    const btnDownload = document.createElement('a');
    btnDownload.href = src;
    btnDownload.download = a.nome;
    btnDownload.textContent = 'Baixar DWG';
    btnDownload.style.display='inline-block';
    btnDownload.style.padding='12px 24px';
    btnDownload.style.background='#fff';
    btnDownload.style.color='#667eea';
    btnDownload.style.borderRadius='6px';
    btnDownload.style.textDecoration='none';
    btnDownload.style.fontWeight='700';
    btnDownload.style.fontSize='16px';
    btnDownload.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';
    btnDownload.style.transition='transform 0.2s, box-shadow 0.2s';
    btnDownload.onmouseover = function() {
      this.style.transform = 'translateY(-2px)';
      this.style.boxShadow = '0 6px 16px rgba(0,0,0,0.3)';
    };
    btnDownload.onmouseout = function() {
      this.style.transform = 'translateY(0)';
      this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
    };
    
    container.appendChild(icon);
    container.appendChild(title);
    container.appendChild(fileName);
    container.appendChild(info);
    container.appendChild(instructions);
    container.appendChild(btnDownload);
    body.appendChild(container);
  } else if(src && a.tipo && a.tipo.startsWith('image/') && !a.tipo.includes('dwg') && !a.tipo.includes('dxf')){
    // Visualizador avançado de imagens
    const container = document.createElement('div');
    container.style.width='100%';
    container.style.minHeight='600px';
    container.style.background='#2a2a2a';
    container.style.borderRadius='6px';
    container.style.overflow='hidden';
    container.style.position='relative';
    
    // Controles de imagem
    const controls = document.createElement('div');
    controls.style.background='#fff';
    controls.style.padding='8px';
    controls.style.borderRadius='6px 6px 0 0';
    controls.style.display='flex';
    controls.style.gap='8px';
    controls.style.alignItems='center';
    controls.style.justifyContent='center';
    controls.style.flexWrap='wrap';
    controls.innerHTML = `
      <button id="img-zoom-out" style="padding:6px 12px">−</button>
      <span id="img-zoom-info" style="padding:0 8px;color:#333;min-width:60px;text-align:center">100%</span>
      <button id="img-zoom-in" style="padding:6px 12px">+</button>
      <button id="img-zoom-fit" style="padding:6px 12px;margin-left:8px">Ajustar</button>
      <button id="img-rotate-left" style="padding:6px 12px;margin-left:16px">↺ 90°</button>
      <button id="img-rotate-right" style="padding:6px 12px">↻ 90°</button>
      <button id="img-reset" style="padding:6px 12px;margin-left:16px">Resetar</button>
    `;
    
    // Container da imagem com centralização
    const imgWrapper = document.createElement('div');
    imgWrapper.style.width='100%';
    imgWrapper.style.height='600px';
    imgWrapper.style.display='flex';
    imgWrapper.style.alignItems='center';
    imgWrapper.style.justifyContent='center';
    imgWrapper.style.overflow='auto';
    imgWrapper.style.background='#2a2a2a';
    
    const img = document.createElement('img');
    img.src = src;
    
    // Handler de erro para debug
    img.onerror = function(){
      console.error('Erro ao carregar imagem');
      console.log('Src completo length:', src.length);
      imgWrapper.innerHTML = '<div style="color:#fff;padding:20px;text-align:center">❌ Erro ao carregar imagem<br><small>Verifique o console</small></div>';
    };
    
    img.onload = function(){
      console.log('Imagem carregada com sucesso!', img.naturalWidth, 'x', img.naturalHeight);
    };
    
    img.style.maxWidth='100%';
    img.style.maxHeight='100%';
    img.style.objectFit='contain';
    img.style.transition='transform 0.3s ease';
    img.style.cursor='grab';
    img.id = 'viewer-img';
    
    imgWrapper.appendChild(img);
    container.appendChild(controls);
    container.appendChild(imgWrapper);
    body.appendChild(container);
    
    // Estado do visualizador
    let currentZoom = 1.0;
    let currentRotation = 0;
    
    function updateTransform() {
      img.style.transform = `scale(${currentZoom}) rotate(${currentRotation}deg)`;
      document.getElementById('img-zoom-info').textContent = Math.round(currentZoom * 100) + '%';
    }
    
    function zoomIn() {
      currentZoom = Math.min(currentZoom + 0.25, 5.0);
      updateTransform();
    }
    
    function zoomOut() {
      currentZoom = Math.max(currentZoom - 0.25, 0.25);
      updateTransform();
    }
    
    function zoomFit() {
      currentZoom = 1.0;
      currentRotation = 0;
      updateTransform();
    }
    
    function rotateLeft() {
      currentRotation -= 90;
      updateTransform();
    }
    
    function rotateRight() {
      currentRotation += 90;
      updateTransform();
    }
    
    function resetView() {
      currentZoom = 1.0;
      currentRotation = 0;
      updateTransform();
    }
    
    // Attach event listeners
    setTimeout(() => {
      const zoomInBtn = document.getElementById('img-zoom-in');
      const zoomOutBtn = document.getElementById('img-zoom-out');
      const zoomFitBtn = document.getElementById('img-zoom-fit');
      const rotateLeftBtn = document.getElementById('img-rotate-left');
      const rotateRightBtn = document.getElementById('img-rotate-right');
      const resetBtn = document.getElementById('img-reset');
      
      if(zoomInBtn) zoomInBtn.addEventListener('click', zoomIn);
      if(zoomOutBtn) zoomOutBtn.addEventListener('click', zoomOut);
      if(zoomFitBtn) zoomFitBtn.addEventListener('click', zoomFit);
      if(rotateLeftBtn) rotateLeftBtn.addEventListener('click', rotateLeft);
      if(rotateRightBtn) rotateRightBtn.addEventListener('click', rotateRight);
      if(resetBtn) resetBtn.addEventListener('click', resetView);
    }, 100);
    
    // Zoom com scroll do mouse
    imgWrapper.addEventListener('wheel', function(e) {
      e.preventDefault();
      if(e.deltaY < 0) {
        zoomIn();
      } else {
        zoomOut();
      }
    }, { passive: false });
    
    // Pan/drag da imagem
    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;
    
    imgWrapper.addEventListener('mousedown', function(e) {
      if(e.target === img) {
        isDragging = true;
        img.style.cursor = 'grabbing';
        startX = e.pageX - imgWrapper.offsetLeft;
        startY = e.pageY - imgWrapper.offsetTop;
        scrollLeft = imgWrapper.scrollLeft;
        scrollTop = imgWrapper.scrollTop;
      }
    });
    
    imgWrapper.addEventListener('mouseleave', function() {
      isDragging = false;
      img.style.cursor = 'grab';
    });
    
    imgWrapper.addEventListener('mouseup', function() {
      isDragging = false;
      img.style.cursor = 'grab';
    });
    
    imgWrapper.addEventListener('mousemove', function(e) {
      if(!isDragging) return;
      e.preventDefault();
      const x = e.pageX - imgWrapper.offsetLeft;
      const y = e.pageY - imgWrapper.offsetTop;
      const walkX = (x - startX) * 2;
      const walkY = (y - startY) * 2;
      imgWrapper.scrollLeft = scrollLeft - walkX;
      imgWrapper.scrollTop = scrollTop - walkY;
    });
    
  } else if(src && a.tipo && a.tipo.includes('pdf')){
    // Renderizar PDF usando PDF.js
    const container = document.createElement('div');
    container.style.width='100%';
    container.style.minHeight='600px';
    container.style.border='1px solid #ddd';
    container.style.borderRadius='6px';
    container.style.overflow='auto';
    container.style.background='#525659';
    container.style.padding='10px';
    container.id = 'pdf-viewer-container';
    
    // Controles de navegação
    const controls = document.createElement('div');
    controls.style.background='#fff';
    controls.style.padding='8px';
    controls.style.borderRadius='6px';
    controls.style.marginBottom='10px';
    controls.style.display='flex';
    controls.style.gap='8px';
    controls.style.alignItems='center';
    controls.style.justifyContent='center';
    controls.innerHTML = `
      <button id="pdf-prev" style="padding:6px 12px">← Anterior</button>
      <span id="pdf-page-info" style="padding:0 12px;color:#333">Página 1 de 1</span>
      <button id="pdf-next" style="padding:6px 12px">Próxima →</button>
      <button id="pdf-zoom-out" style="padding:6px 12px;margin-left:16px">-</button>
      <span id="pdf-zoom-info" style="padding:0 8px;color:#333">100%</span>
      <button id="pdf-zoom-in" style="padding:6px 12px">+</button>
    `;
    
    // Canvas para renderizar o PDF
    const canvas = document.createElement('canvas');
    canvas.id = 'pdf-canvas';
    canvas.style.display='block';
    canvas.style.margin='0 auto';
    canvas.style.background='#fff';
    canvas.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)';
    
    // Loading message
    const loading = document.createElement('div');
    loading.style.padding='40px';
    loading.style.textAlign='center';
    loading.style.color='#fff';
    loading.innerHTML = '<p>Carregando PDF...</p>';
    
    container.appendChild(controls);
    container.appendChild(loading);
    container.appendChild(canvas);
    body.appendChild(container);
    
    // Renderizar PDF com PDF.js
    let pdfDoc = null;
    let pageNum = 1;
    let pageRendering = false;
    let pageNumPending = null;
    let scale = 1.0;
    
    function renderPage(num) {
      pageRendering = true;
      pdfDoc.getPage(num).then(function(page) {
        const viewport = page.getViewport({scale: scale});
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        
        const renderContext = {
          canvasContext: canvas.getContext('2d'),
          viewport: viewport
        };
        
        const renderTask = page.render(renderContext);
        renderTask.promise.then(function() {
          pageRendering = false;
          loading.style.display = 'none';
          if (pageNumPending !== null) {
            renderPage(pageNumPending);
            pageNumPending = null;
          }
        });
      });
      
      document.getElementById('pdf-page-info').textContent = `Página ${num} de ${pdfDoc.numPages}`;
    }
    
    function queueRenderPage(num) {
      if (pageRendering) {
        pageNumPending = num;
      } else {
        renderPage(num);
      }
    }
    
    function onPrevPage() {
      if (pageNum <= 1) return;
      pageNum--;
      queueRenderPage(pageNum);
    }
    
    function onNextPage() {
      if (pageNum >= pdfDoc.numPages) return;
      pageNum++;
      queueRenderPage(pageNum);
    }
    
    function onZoomIn() {
      scale += 0.25;
      document.getElementById('pdf-zoom-info').textContent = Math.round(scale * 100) + '%';
      queueRenderPage(pageNum);
    }
    
    function onZoomOut() {
      if(scale <= 0.5) return;
      scale -= 0.25;
      document.getElementById('pdf-zoom-info').textContent = Math.round(scale * 100) + '%';
      queueRenderPage(pageNum);
    }
    
    // Attach event listeners
    setTimeout(() => {
      const prevBtn = document.getElementById('pdf-prev');
      const nextBtn = document.getElementById('pdf-next');
      const zoomInBtn = document.getElementById('pdf-zoom-in');
      const zoomOutBtn = document.getElementById('pdf-zoom-out');
      
      if(prevBtn) prevBtn.addEventListener('click', onPrevPage);
      if(nextBtn) nextBtn.addEventListener('click', onNextPage);
      if(zoomInBtn) zoomInBtn.addEventListener('click', onZoomIn);
      if(zoomOutBtn) zoomOutBtn.addEventListener('click', onZoomOut);
    }, 100);
    
    // Carregar PDF
    if(typeof pdfjsLib !== 'undefined'){
      pdfjsLib.getDocument(src).promise.then(function(pdfDoc_) {
        pdfDoc = pdfDoc_;
        renderPage(pageNum);
      }).catch(function(error) {
        console.error('Erro ao carregar PDF:', error);
        loading.innerHTML = `
          <p style="color:#fff;margin-bottom:16px">Erro ao carregar o PDF.</p>
          <a href="${src}" download="${a.nome}" style="display:inline-block;padding:10px 20px;background:#2b76d2;color:#fff;border-radius:6px;text-decoration:none;font-weight:600">📥 Baixar PDF</a>
        `;
      });
    } else {
      loading.innerHTML = `
        <p style="color:#fff;margin-bottom:16px">Biblioteca PDF.js não carregada.</p>
        <a href="${src}" download="${a.nome}" style="display:inline-block;padding:10px 20px;background:#2b76d2;color:#fff;border-radius:6px;text-decoration:none;font-weight:600">📥 Baixar PDF</a>
      `;
    }
  } else if(src){
    // Outros tipos: oferece download
    const p = document.createElement('div'); 
    p.innerHTML = `<p style="color:#666;margin-bottom:12px">Visualização não disponível para este tipo de arquivo.</p>`;
    const btnDownload = document.createElement('a');
    btnDownload.href = src;
    btnDownload.download = a.nome;
    btnDownload.textContent = '📥 Baixar arquivo';
    btnDownload.style.display='inline-block';
    btnDownload.style.padding='8px 12px';
    btnDownload.style.background='#2b76d2';
    btnDownload.style.color='#fff';
    btnDownload.style.borderRadius='6px';
    btnDownload.style.textDecoration='none';
    p.appendChild(btnDownload);
    body.appendChild(p);
  } else {
    const p = document.createElement('div'); 
    p.textContent = 'Conteúdo não disponível. Tipo: '+(a.tipo||'desconhecido'); 
    p.style.color='#999';
    body.appendChild(p);
  }
  
  const actions = document.getElementById('anexo-slide-actions'); actions.innerHTML = '';
  
  // Botão de download (sempre disponível se houver conteúdo)
  if(src){
    const btnDownload = document.createElement('a');
    btnDownload.href = src;
    btnDownload.download = a.nome;
    btnDownload.textContent = '📥 Baixar';
    btnDownload.style.display='inline-block';
    btnDownload.style.padding='8px 16px';
    btnDownload.style.background='#2b76d2';
    btnDownload.style.color='#fff';
    btnDownload.style.borderRadius='6px';
    btnDownload.style.textDecoration='none';
    btnDownload.style.fontWeight='600';
    btnDownload.style.marginRight='8px';
    btnDownload.style.cursor='pointer';
    actions.appendChild(btnDownload);
  }
  
  // Botão de excluir
  const btnDel = document.createElement('button'); 
  btnDel.className='danger'; 
  btnDel.textContent='Excluir anexo'; 
  btnDel.onclick = ()=>{ excluirAnexoModal(index); fecharAnexoSlide(); };
  actions.appendChild(btnDel);
  
  // abrir slide
  const slide = document.getElementById('anexo-slide'); 
  slide.style.transform='translateX(0)';
  const overlay = document.getElementById('anexo-slide-overlay');
  if(overlay) overlay.style.display='block';
}

function fecharAnexoSlide(){ 
  const slide=document.getElementById('anexo-slide'); 
  if(slide) slide.style.transform='translateX(110%)'; 
  const overlay = document.getElementById('anexo-slide-overlay');
  if(overlay) overlay.style.display='none';
}

function excluirAnexoModal(index){
  const id = document.getElementById('cliente-modal').getAttribute('data-id');
  const cliente = clientes.find(x=>String(x.id)===String(id));
  if(!cliente || !cliente.anexos || !cliente.anexos[index]) return showMessage('Anexo não encontrado','erro');
  if(!confirm('Excluir este anexo?')) return;
  // Revoga objectURL se existir
  if(cliente.anexos[index]._url) try{ URL.revokeObjectURL(cliente.anexos[index]._url); }catch(e){}
  cliente.anexos.splice(index,1);
  saveClientes();
  renderDashboardCounts();
  renderizarAnexosModal(cliente.anexos);
  showMessage('Anexo removido','sucesso');
}
function ordenarClientes(campo, direc){
  // Se direc não informado, alterna direção quando mesmo campo
  if(typeof direc==='undefined' || direc===null){
    if(filtrosClientes.ordenaPor===campo){
      filtrosClientes.direcao = filtrosClientes.direcao==='asc'?'desc':'asc';
    } else {
      filtrosClientes.ordenaPor = campo;
      filtrosClientes.direcao = 'asc';
    }
  } else {
    filtrosClientes.ordenaPor = campo;
    filtrosClientes.direcao = direc;
  }
  renderizarListaClientes();
}

function updateSortIcons(){
  const fields = ['nome','doc','telefone1','cidade','dataAtualizacao'];
  fields.forEach(f=>{
    const el = document.getElementById('sort-'+f);
    if(!el) return;
    if(filtrosClientes.ordenaPor===f){
      el.textContent = filtrosClientes.direcao==='asc' ? '▲' : '▼';
    } else {
      el.textContent = '↕';
    }
  });
}
function ordenarLeads(campo, direc){
  if(typeof direc==='undefined' || direc===null){
    if(filtrosLeads.ordenaPor===campo){ filtrosLeads.direcao = filtrosLeads.direcao==='asc'?'desc':'asc'; }
    else { filtrosLeads.ordenaPor = campo; filtrosLeads.direcao = 'asc'; }
  } else { filtrosLeads.ordenaPor = campo; filtrosLeads.direcao = direc; }
  renderLeadsList();
}
function updateSortIconsLeads(){
  const fields = ['nome','doc','telefone1','cidade','dataAtualizacao'];
  fields.forEach(f=>{
    const el = document.getElementById('sort-lead-'+f);
    if(!el) return;
    if(filtrosLeads.ordenaPor===f){ el.textContent = filtrosLeads.direcao==='asc' ? '▲' : '▼'; }
    else { el.textContent = '↕'; }
  });
}
function editarCliente(id){
  let c = clientes.find(cl=>String(cl.id)===String(id));
  if(!c) return;
  // Open the modal and populate it for editing
  try{
    popularPainelCliente(c);
    const modal = document.getElementById('cliente-modal');
    if(modal) modal.style.display = 'flex';
  }catch(e){
    // Fallback: populate inline form if modal fails
    let f = document.getElementById('form-cliente');
    if(f){
      f.setAttribute('data-id',c.id);
      f['cliente-nome'].value = c.nome||'';
      f['cliente-doc'].value = c.doc||'';
      f['cliente-tel1'].value = c.telefone1||'';
      f['cliente-tel2'].value = c.telefone2||'';
      f['cliente-cep'].value = c.cep||'';
      f['cliente-logradouro'].value = c.logradouro||'';
      f['cliente-numero'].value = c.numero||'';
      f['cliente-complemento'].value = c.complemento||'';
      f['cliente-bairro'].value = c.bairro||'';
      f['cliente-cidade'].value = c.cidade||'';
      f['cliente-observacao'].value = c.observacao||'';
      window.scrollTo({top:0,behavior:"smooth"});
    }
  }
}
function excluirCliente(id){
  if(confirm('Excluir cliente?')){
    clientes=clientes.filter(c=>String(c.id)!==String(id));
    saveClientes();
    renderizarListaClientes();
    showMessage('Excluído!','sucesso');
  }
}
</script>
<script>
// Sidebar removed: stub functions to avoid runtime errors from remaining callers
function renderSidebarModules(){
  // intentionally no-op while sidebar DOM is removed; re-enable to repopulate modules
  return;
}
function toggleSidebar(){
  // no-op: sidebar UI removed
  return;
}

// Adjust sidebar width and main card margin to avoid overlap dynamically
function adjustSidebarLayout(){
  const sb = document.getElementById('module-sidebar');
  const btn = document.getElementById('module-sidebar-toggle');
  const card = document.querySelector('.card');
  if(!sb || !btn || !card) return;
  const defaultWidth = 280;
  // compute available space to the left of the centered card
  const cardRect = card.getBoundingClientRect();
  const cardLeft = Math.max(0, Math.floor(cardRect.left));
  // allow a small gap between sidebar and card
  const gap = 20;
  // maximum allowed sidebar width so it doesn't overlap the card
  const maxAllowed = Math.max(100, cardLeft - gap);
  let sidebarWidth = defaultWidth;
  if(maxAllowed < defaultWidth) sidebarWidth = maxAllowed;
  // apply computed width
  sb.style.width = sidebarWidth + 'px';
  // set card margin to push content (only when sidebar visible)
  if(!sb.classList.contains('hidden')){
    card.style.marginLeft = (sidebarWidth + gap) + 'px';
    document.body.classList.add('sidebar-open');
  } else {
    card.style.marginLeft = '';
  }
  // position toggle inside bar when open, or to the left when closed
  if(sb.classList.contains('hidden')){
    btn.style.left = '12px';
  } else {
    // place the toggle slightly inset from the right edge of the sidebar
    const leftPos = sidebarWidth - (btn.offsetWidth - 4);
    btn.style.left = leftPos + 'px';
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  renderSidebarModules();
  const btn = document.getElementById('module-sidebar-toggle');
  if(btn){
    btn.onclick = toggleSidebar;
    btn.onkeydown = (ev)=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); toggleSidebar(); } };
    // ensure initial aria-pressed state
    if(document.getElementById('module-sidebar') && !document.getElementById('module-sidebar').classList.contains('hidden')){
      btn.classList.add('open');
      btn.setAttribute('aria-pressed','true');
      btn.setAttribute('aria-label','Fechar módulos');
    } else {
      btn.setAttribute('aria-pressed','false');
      btn.setAttribute('aria-label','Abrir módulos');
    }
    // initial layout adjustment
    setTimeout(adjustSidebarLayout,50);
  }
  // adjust on window resize
  window.addEventListener('resize', ()=>{ setTimeout(adjustSidebarLayout,50); });
  // safety: sometimes other inits run after DOMContentLoaded and may clear or reorder nodes.
  // Retry rendering once on full window load and once more after a short delay to ensure sidebar is populated.
  window.addEventListener('load', ()=>{
    try{ if(typeof renderSidebarModules==='function') renderSidebarModules(); }catch(e){}
    setTimeout(()=>{ try{ if(typeof renderSidebarModules==='function') renderSidebarModules(); }catch(e){} }, 220);
    setTimeout(()=>{ try{ setTimeout(adjustSidebarLayout,50); }catch(e){} }, 240);
  });
  // initialize dashboard counters
  try{ renderDashboardCounts(); }catch(e){}
});

// Micro-interaction: ripple effect for module cards
function createRipple(ev){
  const el = ev.currentTarget;
  const rect = el.getBoundingClientRect();
  const r = document.createElement('span');
  const size = Math.max(rect.width, rect.height) * 1.2;
  r.style.position = 'absolute';
  r.style.left = (ev.clientX - rect.left - size/2) + 'px';
  r.style.top = (ev.clientY - rect.top - size/2) + 'px';
  r.style.width = r.style.height = size + 'px';
  r.style.borderRadius = '50%';
  r.style.background = 'rgba(255,255,255,0.12)';
  r.style.pointerEvents = 'none';
  r.style.transform = 'scale(0)';
  r.style.opacity = '0.9';
  r.style.transition = 'transform .6s ease, opacity .6s ease';
  r.className = 'ripple-span';
  el.style.position = el.style.position || 'relative';
  el.appendChild(r);
  requestAnimationFrame(()=>{ r.style.transform='scale(1)'; r.style.opacity='0'; });
  setTimeout(()=>{ try{ r.remove(); }catch(e){} }, 700);
}

// Attach ripple and keyboard-friendly click handling
document.addEventListener('DOMContentLoaded', ()=>{
  const cards = document.querySelectorAll('.module-card');
  cards.forEach(c=>{
    c.addEventListener('click', createRipple);
    // ensure keyboard Enter/Space also show ripple
    c.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter' || ev.key===' '){ createRipple({currentTarget:c, clientX: c.getBoundingClientRect().left + c.offsetWidth/2, clientY: c.getBoundingClientRect().top + c.offsetHeight/2}); } });
  });
});

// --- Logo management: store as base64 in localStorage, upload/export ---
const KEY_APP_LOGO = 'orc_app_logo_base64_v1';
// Dashboard counters: update counts in the dashboard cards
function renderDashboardCounts(){
  try{
    const cCount = (Array.isArray(clientes)?clientes.length:0);
    const oCount = (Array.isArray(orcamentos)?orcamentos.length:0);
    const pCount = (Array.isArray(catalogo)?catalogo.length:0);
    let aCount = 0;
    if(Array.isArray(clientes)){
      clientes.forEach(cl=>{ if(Array.isArray(cl.anexos)) aCount += cl.anexos.length; });
    }
    const elC = document.getElementById('db-clientes-count'); if(elC) elC.textContent = cCount;
    const elO = document.getElementById('db-orcamentos-count'); if(elO) elO.textContent = oCount;
    const elP = document.getElementById('db-produtos-count'); if(elP) elP.textContent = pCount;
    const elA = document.getElementById('db-anexos-count'); if(elA) elA.textContent = aCount;
    const lCount = (Array.isArray(leads)?leads.length:0);
    const elL = document.getElementById('db-leads-count'); if(elL) elL.textContent = lCount;
    // per-status counts
    try{
      const statusContainer = document.getElementById('db-leads-statuses');
      if(statusContainer){
        loadLeadStatuses();
        const counts = {};
        (Array.isArray(leads)?leads:[]).forEach(l=>{ const s=(l.status||'Lead'); counts[s]= (counts[s]||0)+1; });
        // render statuses in defined order
        statusContainer.innerHTML = leadStatuses.map(s=>`${escapeHtml(s)}: ${counts[s]||0}`).join(' · ');
      }
    }catch(e){ /* ignore */ }
  }catch(e){ console.warn('renderDashboardCounts failed',e); }
}

// Favorites: Funções auxiliares (principais já declaradas no início do HTML)
// renderFavoritosArea removida para evitar redeclaração - está declarada no script inicial

function renderFavoritesUI(){
  const favs = loadFavorites();
  // update any module-level fav buttons (backwards compatible)
  document.querySelectorAll('.module-card').forEach(card=>{
    const modKey = card.getAttribute('data-module');
    const btn = card.querySelector('.fav-btn');
    if(btn && modKey){ 
      const pressed = favs.indexOf(modKey)!==-1; 
      btn.setAttribute('aria-pressed', pressed ? 'true' : 'false'); 
      // Mantém sempre ⭐, o CSS muda a cor via grayscale
    }
  });
  // update internal-card fav buttons (data-fav-key)
  document.querySelectorAll('[data-fav-key]').forEach(card=>{
    const key = card.getAttribute('data-fav-key');
    const btn = card.querySelector('.fav-btn');
    if(btn){ 
      const pressed = favs.indexOf(key)!==-1; 
      btn.setAttribute('aria-pressed', pressed ? 'true' : 'false'); 
      // Mantém sempre ⭐, o CSS muda a cor via grayscale
    }
  });
  // render highlight strip for internal favorites
  const highlight = document.getElementById('internal-favorites-highlight');
  const strip = document.getElementById('internal-favs-strip');
  if(!strip || !highlight) return;
  strip.innerHTML='';
  // find DOM elements that match fav keys and render them in strip
  const internalItems = [];
  favs.forEach(k=>{
    // only internal keys contain ':' (module:action)
    if(typeof k==='string' && k.indexOf(':')!==-1){
      const el = document.querySelector(`[data-fav-key="${k}"]`);
      if(el){
        // extract an icon and title from the element
        const iconEl = el.querySelector('.icon');
        const titleEl = el.querySelector('.title');
        internalItems.push({key:k, icon: iconEl? iconEl.textContent : '🔖', title: titleEl? titleEl.textContent : k, el});
      }
    }
  });
  if(internalItems.length===0){ highlight.style.display='none'; return; }
  highlight.style.display='block';
  internalItems.forEach(it=>{
    const m = document.createElement('div'); m.className='fav-item'; m.setAttribute('role','button'); m.tabIndex=0;
    // If the internal element has a direct action (onclick) or is a known quick-action (novo/list), open directly.
    const quickAction = (it.key && (it.key.endsWith(':novo') || it.key.endsWith(':list')));
    m.onclick = ()=>{
      try{
        if(it.el && (it.el.onclick || quickAction)){
          // If it's a ':list' quick action, ensure the module/section is opened first
          if(it.key && it.key.endsWith(':list')){
            const mod = (it.key.split(':')||[])[0];
            try{ abrir(mod); }catch(e){}
            // small delay so section becomes active before scrolling
            setTimeout(()=>{ try{ 
                // ensure the target list/table is visible (expand if collapsed)
                try{ ensureListVisible(mod); }catch(e){}
                it.el.click(); // after opening, focus/highlight the list
                highlightAndFocusList(mod);
              }catch(e){} }, 80);
            return;
          }
          // prefer invoking element's click to follow existing behavior
          it.el.click();
          return;
        }
      }catch(e){/* ignore and fallback to panel */}
      openFavoritePanel(it.key, it.el);
    };
    m.onkeydown = (ev)=>{ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); m.onclick(); } };
    m.innerHTML = `<div class="icon">${escapeHtml(it.icon)}</div><div class="title">${escapeHtml(it.title)}</div>`;
    strip.appendChild(m);
  });
}

// Initialize favorites UI on load
document.addEventListener('DOMContentLoaded', ()=>{ 
  renderFavoritesUI(); 
  renderFavoritosArea(); // Renderiza a área de favoritos na página inicial
});

// Favorite panel helpers
let __lastFavTarget = null; // {key, el}
function openFavoritePanel(key, el){
  __lastFavTarget = {key, el};
  const title = document.querySelector(`[data-fav-key="${key}"] .title`);
  const icon = document.querySelector(`[data-fav-key="${key}"] .icon`);
  const sub = document.querySelector(`[data-fav-key="${key}"] .subtitle`);
  const panel = document.getElementById('fav-panel');
  const content = document.getElementById('fav-panel-content');
  if(!panel || !content) return;
  content.innerHTML = `<div style="display:flex;gap:12px;align-items:center"><div style="font-size:28px">${escapeHtml(icon?icon.textContent:'🔖')}</div><div><div style="font-weight:800">${escapeHtml(title?title.textContent:key)}</div><div style="color:#666;margin-top:6px">${escapeHtml(sub?sub.textContent:'')}</div></div></div>`;
  panel.style.display='flex';
  // close when clicking overlay or pressing Escape
  try{ if(typeof attachOverlayClose === 'function'){ attachOverlayClose(panel, closeFavPanel); } }catch(e){}
}
function favPanelOpen(){
  if(!__lastFavTarget) return;
  try{
    // prefer invoking the element's click handler if present
    const el = __lastFavTarget.el;
    if(el){ el.click(); }
    // if the key maps to a module, open module instead
    else if(typeof __lastFavTarget.key === 'string' && __lastFavTarget.key.indexOf(':')===-1){ abrir(__lastFavTarget.key); }
  }catch(e){ console.warn('favPanelOpen error', e); }
  closeFavPanel();
}
function closeFavPanel(){ const panel = document.getElementById('fav-panel'); if(panel) panel.style.display='none'; __lastFavTarget = null; }

// Focus and briefly highlight main list/table for a module after opening
function highlightAndFocusList(moduleKey){
  try{
    let selector = null;
    if(moduleKey === 'clientes') selector = '#tabela-clientes';
    else if(moduleKey === 'leads') selector = '#tabela-leads';
    else if(moduleKey === 'orc') selector = '#itens-table';
    if(!selector) return;
    const el = document.querySelector(selector);
    if(!el) return;
    // focus and add highlight class
    el.focus({preventScroll:false});
    el.classList.add('list-focus-highlight');
    // remove highlight after a short interval
    setTimeout(()=>{ try{ el.classList.remove('list-focus-highlight'); }catch(e){} }, 1500);
  }catch(e){ console.warn('highlightAndFocusList failed', e); }
}

// Ensure the module's table is expanded (if it has a toggle) before triggering actions
function ensureListVisible(moduleKey){
  try{
    if(moduleKey === 'clientes'){
      const tbl = document.getElementById('tabela-clientes'); const icon = document.getElementById('clientes-header-icon');
      if(tbl && tbl.style.display==='none'){ tbl.style.display='table'; if(icon) icon.textContent='▾'; }
    } else if(moduleKey === 'leads'){
      const tbl = document.getElementById('tabela-leads'); const icon = document.getElementById('leads-header-icon');
      if(tbl && tbl.style.display==='none'){ tbl.style.display='table'; if(icon) icon.textContent='▾'; }
    }
  }catch(e){ console.warn('ensureListVisible failed', e); }
}

// Leads storage helpers (main declarations in line ~2162)
// const KEY_LEADS = 'orc_leads_v1';
// let leads = [];
// function loadLeads(){ const s = localStorage.getItem(KEY_LEADS); leads = s?JSON.parse(s):[]; }
// function saveLeads(){ localStorage.setItem(KEY_LEADS, JSON.stringify(leads)); renderLeadsList(); renderDashboardCounts(); }

// Initialize leads on load
document.addEventListener('DOMContentLoaded', ()=>{ loadLeads(); renderLeadsList(); renderDashboardCounts(); });
document.addEventListener('DOMContentLoaded', ()=>{ const pl=document.getElementById('painel-lead'); if(pl){ pl.style.display='none'; pl.innerHTML=''; } });

// Backup: garante abertura na home se o script anterior falhar
document.addEventListener('DOMContentLoaded', ()=>{ 
  // Só executa se a home não estiver ativa
  const homeSection = document.getElementById('home');
  if(homeSection && !homeSection.classList.contains('active')) {
    if(typeof abrir === 'function') abrir('home');
  }
});

// Leads CRUD and render functions (mirrors clientes but fields optional)
function novoLeadForm(){
  const f = document.getElementById('form-lead');
  if(f){ f.reset(); f.removeAttribute('data-id'); populateLeadStatusOptions(); const s=document.getElementById('lead-status'); if(s) s.value='Lead'; }
  const modal = document.getElementById('lead-modal'); if(modal) modal.style.display='flex';
}
function salvarLead(){
  const f = document.getElementById('form-lead'); if(!f) return;
  const currentId = f.getAttribute('data-id');
  const nome = (document.getElementById('lead-nome').value||'').trim();
  const tel1 = (document.getElementById('lead-tel1').value||'').trim();
  const tel2 = (document.getElementById('lead-tel2').value||'').trim();
  const cep = (document.getElementById('lead-cep').value||'').trim();
  const doc = ((document.getElementById('lead-doc').value||'').replace(/\D/g,''))||'';
  const agora = new Date().toISOString();
  let id = currentId || Date.now();
  let existing = leads.find(l=>String(l.id)===String(id));
  let anexos = (existing && existing.anexos)? [...existing.anexos] : [];
  // collect attachment metadata only (actual content can be added via anexos UI if needed later)
  const inputAnexo = document.getElementById('lead-anexo');
  if(inputAnexo && inputAnexo.files && inputAnexo.files.length){
    for(let fobj of inputAnexo.files){ anexos.push({nome:fobj.name,tipo:fobj.type,data:agora}); }
    inputAnexo.value='';
  }
  const obj = {
    id, doc, nome,
    telefone1: tel1,
    telefone2: tel2,
    cep: cep,
    logradouro: document.getElementById('lead-logradouro').value.trim(),
    numero: document.getElementById('lead-numero').value.trim(),
    complemento: document.getElementById('lead-complemento').value.trim(),
    bairro: document.getElementById('lead-bairro').value.trim(),
    cidade: document.getElementById('lead-cidade').value.trim(),
    observacao: document.getElementById('lead-observacao').value.trim(),
    anexos,
    status: document.getElementById('lead-status') ? document.getElementById('lead-status').value.trim() : (existing && existing.status? existing.status : 'Lead'),
    dataCadastro: (existing && existing.dataCadastro)? existing.dataCadastro : agora,
    dataAtualizacao: agora
  };
  if(existing){ Object.assign(existing,obj); }
  else { leads.push(obj); }
  saveLeads();
  // update UI
  showMessage(existing? 'Lead atualizado!':'Lead cadastrado!','sucesso');
  // close modal or reset form
  if(f){ f.reset(); f.removeAttribute('data-id'); }
  const modal = document.getElementById('lead-modal'); if(modal) modal.style.display='none';
}
function editarLead(id){
  const l = leads.find(x=>String(x.id)===String(id)); if(!l) return showMessage('Lead não encontrado','erro');
  const f = document.getElementById('form-lead'); if(!f) return;
  f.setAttribute('data-id', String(l.id));
  document.getElementById('lead-doc').value = l.doc||'';
  document.getElementById('lead-nome').value = l.nome||'';
  document.getElementById('lead-tel1').value = l.telefone1||'';
  document.getElementById('lead-tel2').value = l.telefone2||'';
  document.getElementById('lead-cep').value = l.cep||'';
  document.getElementById('lead-logradouro').value = l.logradouro||'';
  document.getElementById('lead-numero').value = l.numero||'';
  document.getElementById('lead-complemento').value = l.complemento||'';
  document.getElementById('lead-bairro').value = l.bairro||'';
  document.getElementById('lead-cidade').value = l.cidade||'';
  document.getElementById('lead-observacao').value = l.observacao||'';
  populateLeadStatusOptions();
  if(document.getElementById('lead-status')) document.getElementById('lead-status').value = l.status || 'Lead';
  const modal = document.getElementById('lead-modal'); if(modal) modal.style.display='flex';
}
function excluirLead(id){ if(!confirm('Excluir lead?')) return; leads = leads.filter(x=>String(x.id)!==String(id)); saveLeads(); showMessage('Lead removido','sucesso'); }
function renderLeadsList(){
  const tbody = (document.getElementById('tabela-leads')||{querySelector:()=>null}).querySelector? document.getElementById('tabela-leads').querySelector('tbody') : null;
  if(!tbody) return;
  tbody.innerHTML='';
  const busc = (filtrosLeads.busca||'').toLowerCase();
  let arr = leads.filter(l=>{
    if(busc && !((l.nome||'').toLowerCase().includes(busc) || (l.doc||'').includes(busc) || (l.telefone1||'').includes(busc))) return false;
    if(filtrosLeads.status && filtrosLeads.status.length && (l.status||'')!==filtrosLeads.status) return false;
    return true;
  });
  arr.sort((a,b)=>{ let f=filtrosLeads.ordenaPor; let dir = filtrosLeads.direcao=='asc'?1:-1; return (a[f]||'')>(b[f]||'')?dir:-dir; });
  arr.forEach(l=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><a href="#" onclick="abrirPainelLead('${l.id}');return false">${l.nome||''}</a></td>
      <td>${l.doc||''}</td>
      <td>${l.telefone1||''}</td>
      <td>${l.cidade||''}</td>
      <td>${l.status||'Lead'}</td>
      <td>${formataData(l.dataAtualizacao)}</td>
      <td><button onclick="editarLead('${l.id}')">Editar</button> <button onclick="excluirLead('${l.id}')" class="danger">Excluir</button></td>`;
    tbody.appendChild(tr);
  });
  if(typeof updateSortIconsLeads==='function') updateSortIconsLeads();
}
function abrirPainelLead(id){
  const l = leads.find(x=>String(x.id)===String(id));
  if(!l) return showMessage('Lead não encontrado','erro');
  leadAtualId = id; // Armazena globalmente
  popularPainelLead(l);
  const modal = document.getElementById('lead-modal');
  if(modal) {
    modal.style.display='flex';
    modal.setAttribute('data-lead-id', id);
  }
  // bind the Novo Orçamento button to create an orcamento for this lead
  const novoBtn = document.getElementById('painel-lead-novo-orc');
  if(novoBtn){
    novoBtn.onclick = function(e){ e.stopPropagation(); abrirPainelOrcamentoLead(id); };
  }
}
function popularPainelLead(l){
  const f = document.getElementById('painel-lead'); if(!f) return;
  f.querySelector('#painel-lead-id')?.remove();
  f.style.display='block';
  // Build a panel similar to cliente modal but inline: left = dados, anexos, observações gerais; right = orçamentos (novo + lista com observações por orçamento)
  f.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#fafafa;border:1px solid #eee;border-radius:6px">
      <div style="font-weight:700">${l.nome||'Lead'}</div>
      <div><button style="background:transparent;border:none;font-size:16px;cursor:pointer" onclick="fecharPainelLead()">✕</button></div>
    </div>
    <div style="padding:12px;border:1px solid #f0f0f0;border-radius:6px;margin-top:8px;display:flex;gap:12px;align-items:flex-start">
      <div style="flex:1">
        <div style="background:#fafafa;padding:12px;border-radius:6px;border:1px solid #eee">
          <h4 style="margin-top:0;text-align:center;color:#333;font-weight:700;padding-bottom:8px;border-bottom:1px solid #dcdcdc">Dados do Lead</h4>
          <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Nome:</label><input id="painel-lead-nome" style="flex:1" value="${escapeHtml(l.nome||'')}"></div>
          <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">CPF/CNPJ:</label><input id="painel-lead-doc" style="flex:1" maxlength="18" value="${escapeHtml(l.doc||'')}" oninput="mascaraNumDoc(this)"></div>
          <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Tel 1:</label><input id="painel-lead-tel1" style="flex:1" value="${escapeHtml(l.telefone1||'')}" oninput="mascaraTelefone(this)"></div>
          <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Tel 2:</label><input id="painel-lead-tel2" style="flex:1" value="${escapeHtml(l.telefone2||'')}" oninput="mascaraTelefone(this)"></div>
          <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">CEP:</label><input id="painel-lead-cep" style="flex:1" maxlength="8" value="${escapeHtml(l.cep||'')}" oninput="mascaraNumCep(this); if(this.value.replace(/\D/g,'').length===8) buscarEnderecoModal(false);" onchange="buscarEnderecoModal(false)"></div>
          <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Rua:</label><input id="painel-lead-logradouro" style="flex:1" value="${escapeHtml(l.logradouro||'')}"></div>
          <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Número:</label><input id="painel-lead-numero" style="width:120px" value="${escapeHtml(l.numero||'')}"><label style="width:90px">Complemento:</label><input id="painel-lead-complemento" style="flex:1" value="${escapeHtml(l.complemento||'')}"></div>
          <div style="display:flex;gap:8px;margin-bottom:8px"><label style="width:120px">Bairro:</label><input id="painel-lead-bairro" style="flex:1" value="${escapeHtml(l.bairro||'')}"><label style="width:90px">Cidade:</label><input id="painel-lead-cidade" style="width:160px" value="${escapeHtml(l.cidade||'')}"></div>
          <hr style="margin:10px 0">
          <div style="margin-top:6px;margin-bottom:6px">
            <div style="background:#f0f0f2;padding:8px;border-radius:6px;border:1px solid #e6e6e6">
              <div style="margin-bottom:8px;text-align:center;color:#333;font-weight:700;padding-bottom:6px;border-bottom:1px solid #e0e0e0">Anexos</div>
              <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px">
                <input type="file" id="painel-lead-anexo" multiple style="display:none" onchange="adicionarAnexosLeadPanel()">
                <label for="painel-lead-anexo" style="cursor:pointer;display:inline-flex;align-items:center;gap:8px;padding:8px 12px;background:#2b76d2;color:#fff;border-radius:6px;font-weight:600;border:1px solid rgba(0,0,0,0.08)">📎 Anexar arquivos</label>
                <small style="color:#666;margin-left:8px">PNG, JPG, PDF — clique para selecionar</small>
              </div>
              <div id="painel-lead-anexos" style="display:flex;flex-wrap:wrap;gap:8px"></div>
            </div>
          </div>
        </div>
        <hr style="margin:10px 0">
        <div style="background:#f5f5f7;padding:10px;border-radius:6px;margin-top:8px;display:flex;flex-direction:column;gap:8px">
          <div style="text-align:center;color:#333;font-weight:700;padding-bottom:8px;border-bottom:1px solid #dcdcdc;margin-bottom:8px">Observações Gerais</div>
          <div>
            <textarea id="painel-lead-observacao-geral" class="cliente-textarea" style="height:80px;width:100%">${escapeHtml(l.observacao||'')}</textarea>
          </div>
          <div style="display:flex;justify-content:flex-start;margin-top:6px">
            <button data-preserve="true" onclick="adicionarObservacaoGeralLead('${l.id}')">Adicionar observação</button>
          </div>
          <div style="margin-top:4px">
            <div style="font-weight:600;margin-bottom:6px">Histórico de Observações</div>
            <div style="overflow:auto;max-height:180px;border:1px solid #eee;border-radius:6px">
              <table style="width:100%;border-collapse:collapse;font-size:13px"><thead><tr>
                <th style="padding:6px;border-bottom:1px solid #eee">Observação</th>
                <th style="padding:6px;border-bottom:1px solid #eee">Data / Hora</th>
              </tr></thead><tbody id="painel-lead-observacoes-tbody"></tbody></table>
            </div>
          </div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
            <button id="painel-lead-salvar" data-preserve="true" onclick="salvarPainelLead()">Salvar</button>
            <button id="painel-lead-cancelar" data-preserve="true" onclick="fecharPainelLead()">Cancelar</button>
          </div>
        </div>
      </div>
      <div style="width:420px;display:flex;flex-direction:column;gap:10px">
        <div id="painel-lead-orcamentos" style="flex:1;border:1px solid #eee;padding:10px;border-radius:6px;background:#fbfbff">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong>Orçamentos</strong>
            <button id="painel-lead-novo-orc" onclick="abrirPainelOrcamentoLead('${l.id}')">+ Novo Orçamento</button>
          </div>
          <div id="painel-lead-orc-list" style="display:flex;flex-direction:column;gap:8px;max-height:420px;overflow:auto"></div>
        </div>
      </div>
    </div>`;
  // populate attachments and observations lists
  renderLeadAttachments(l.id);
  renderLeadObservacoesGerais(l.id);
  renderLeadOrcamentos(l.id);
}

function fecharPainelLead(){
  leadAtualId = null; // Limpa a variável global
  const modal = document.getElementById('lead-modal');
  if(modal) {
    modal.style.display='none';
    modal.removeAttribute('data-lead-id');
  }
  const f=document.getElementById('painel-lead');
  if(f) {
    // clear Novo Orçamento button handler if present
    const novoBtn = document.getElementById('painel-lead-novo-orc');
    if(novoBtn) novoBtn.onclick = null;
    f.style.display='none';
    f.innerHTML='';
  }
}

// Helpers: attachments for lead panel
function renderLeadAttachments(leadId){ const l = leads.find(x=>String(x.id)===String(leadId)); const container = document.getElementById('painel-lead-anexos'); if(!container) return; container.innerHTML=''; if(!l || !l.anexos) return; l.anexos.forEach((a,idx)=>{ const el=document.createElement('div'); el.style.padding='6px 8px'; el.style.border='1px solid #eee'; el.style.borderRadius='6px'; el.style.background='#fff'; el.textContent = a.nome + ' · ' + formataData(a.data); container.appendChild(el); }); }
function adicionarAnexosLeadPanel(){ const inp = document.getElementById('painel-lead-anexo'); const modalId = document.getElementById('painel-lead').querySelector('div[style*="font-weight:700"]')?.textContent||''; const l = leads.find(x=>String(x.nome)===String(modalId) || String(x.id)===String(modalId)); // fallback not ideal
  // better: find visible lead by reading painel content title
  const title = document.querySelector('#painel-lead > div:first-child > div:first-child')?.textContent || '';
  const leadObj = leads.find(x=>x.nome===title) || leads[0];
  if(!leadObj) return;
  if(inp && inp.files && inp.files.length){ const agora=new Date().toISOString(); for(let f of inp.files){ leadObj.anexos = leadObj.anexos||[]; leadObj.anexos.push({nome:f.name,tipo:f.type,data:agora}); } saveLeads(); renderLeadAttachments(leadObj.id); inp.value=''; }
}

// Observações gerais do lead (simples lista)
function renderLeadObservacoesGerais(leadId){ const tbody = document.getElementById('painel-lead-observacoes-tbody'); if(!tbody) return; tbody.innerHTML=''; const l = leads.find(x=>String(x.id)===String(leadId)); if(!l || !l.obsGerais) return; l.obsGerais.slice().reverse().forEach(o=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td style="padding:6px;border-bottom:1px solid #eee">${escapeHtml(o.texto)}</td><td style="padding:6px;border-bottom:1px solid #eee">${formataData(o.data)}</td>`; tbody.appendChild(tr); }); }
function adicionarObservacaoGeralLead(leadId){ const txt = document.getElementById('painel-lead-observacao-geral').value.trim(); if(!txt){ showMessage('Digite a observação','erro'); return;} const l = leads.find(x=>String(x.id)===String(leadId)); if(!l) return; const agora=new Date().toISOString(); l.obsGerais = l.obsGerais||[]; l.obsGerais.push({texto:txt,data:agora}); saveLeads(); renderLeadObservacoesGerais(leadId); document.getElementById('painel-lead-observacao-geral').value=''; showMessage('Observação adicionada','sucesso'); }

// Orçamentos por lead
function renderLeadOrcamentos(leadId){ const container = document.getElementById('painel-lead-orc-list'); if(!container) return; container.innerHTML=''; const los = orcamentos.filter(o=>String(o.leadId)===String(leadId)); if(!los.length){ container.innerHTML='<div style="color:#666">Nenhum orçamento encontrado para este lead.</div>'; return; }
  los.sort((a,b)=> (b.dataEnvio||'') > (a.dataEnvio||'')?1:-1);
  los.forEach(o=>{ const card=document.createElement('div'); card.style.padding='8px'; card.style.border='1px solid #eee'; card.style.borderRadius='6px'; card.style.background='#fff';
    const titulo = document.createElement('div'); titulo.style.display='flex'; titulo.style.justifyContent='space-between'; titulo.style.alignItems='center'; titulo.innerHTML = `<div style="font-weight:700">${escapeHtml(o.nome||'Orçamento')}</div><div style="font-size:12px;color:#666">${formataData(o.dataEnvio)}</div>`;
    const obsList = document.createElement('div'); obsList.style.marginTop='6px'; obsList.style.fontSize='13px'; obsList.style.color='#333';
    const obsHtml = (o.observacoes||[]).slice().reverse().map(obs=>`<div style="padding:6px;border-top:1px solid #f0f0f0"><div style="font-size:13px;color:#333">${escapeHtml(obs.texto)}</div><div style="font-size:12px;color:#666">Agendado: ${formataData(obs.proximaContato)} · Status: ${escapeHtml(obs.status||'')}</div></div>`).join('');
    obsList.innerHTML = obsHtml || '<div style="color:#666">Sem observações para este orçamento</div>';
    const controls = document.createElement('div'); controls.style.display='flex'; controls.style.gap='6px'; controls.style.marginTop='8px';
    const btnNovaObs = document.createElement('button'); btnNovaObs.textContent='Adicionar observação'; btnNovaObs.onclick = ()=>{ abrirAdicionarObservacaoOrcamento(o.codigo); };
    const btnAbrir = document.createElement('button'); btnAbrir.textContent='Abrir Orçamento'; btnAbrir.onclick = ()=>{ carregarOrcamento(o.codigo); };
    controls.appendChild(btnAbrir); controls.appendChild(btnNovaObs);
    card.appendChild(titulo); card.appendChild(obsList); card.appendChild(controls);
    container.appendChild(card);
  }); }

function novoOrcamentoParaLead(leadId){ // create a new orcamento linked to lead and open editor
  const o = {codigo: Date.now(), nome: 'Orçamento para '+ ( (leads.find(x=>String(x.id)===String(leadId))||{}).nome || '' ), vendedor:'', itens: [], leadId: String(leadId), dataEnvio: null, observacoes: [] };
  orcamentos.push(o); saveOrcamentos(); renderLeadOrcamentos(leadId); carregarOrcamento(o.codigo);
}

// Função auxiliar para criar orçamento do lead aberto no modal
function criarNovoOrcamentoLead(){
  if(!leadAtualId){
    showMessage('Nenhum lead aberto','erro');
    return;
  }
  
  const lead = leads.find(l => String(l.id) === String(leadAtualId));
  if(!lead){
    showMessage('Lead não encontrado','erro');
    return;
  }
  
  // Abre o modal de orçamento vinculado ao lead atual
  abrirPainelOrcamentoLead(leadAtualId);
}

function abrirAdicionarObservacaoOrcamento(orcCodigo){ const o = orcamentos.find(x=>x.codigo===orcCodigo); if(!o) return; // show a small modal to add obs with next-contact datetime and status
  let modal = document.getElementById('add-obs-orc-modal'); if(!modal){ modal = document.createElement('div'); modal.id='add-obs-orc-modal'; modal.style.position='fixed'; modal.style.left='0'; modal.style.top='0'; modal.style.right='0'; modal.style.bottom='0'; modal.style.background='rgba(0,0,0,0.45)'; modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex=2600; modal.innerHTML = `<div style="background:#fff;padding:16px;border-radius:10px;max-width:560px;width:92%;box-shadow:0 18px 60px rgba(0,0,0,0.24)">
    <h3>Adicionar observação ao Orçamento</h3>
    <div style="display:flex;flex-direction:column;gap:8px">
      <textarea id="add-obs-orc-text" placeholder="Observação" style="min-height:80px"></textarea>
      <div style="display:flex;gap:8px"><input id="add-obs-orc-datetime" type="datetime-local" style="flex:1"><select id="add-obs-orc-status" class="cliente-input" style="width:180px"></select></div>
      <div style="display:flex;gap:8px;justify-content:flex-end"><button id="add-obs-orc-cancel">Cancelar</button><button id="add-obs-orc-save">Salvar observação</button></div>
    </div>
  </div>`; document.body.appendChild(modal);
    try{ if(typeof attachOverlayClose === 'function'){ attachOverlayClose(modal, ()=>{ try{ if(modal && modal.__removeOverlayClose) modal.__removeOverlayClose(); modal.remove(); }catch(e){} }); } }catch(e){}
    document.getElementById('add-obs-orc-cancel').onclick = ()=>{ try{ if(modal && modal.__removeOverlayClose) modal.__removeOverlayClose(); }catch(e){} modal.remove(); };
    document.getElementById('add-obs-orc-save').onclick = ()=>{ const txt = document.getElementById('add-obs-orc-text').value.trim(); const dt = document.getElementById('add-obs-orc-datetime').value; const status = document.getElementById('add-obs-orc-status').value; if(!txt){ showMessage('Observação vazia','erro'); return;} if(!dt){ showMessage('Preencha data/hora de próximo contato','erro'); return;} if(!status){ showMessage('Selecione um status para o lead','erro'); return;} o.observacoes = o.observacoes||[]; o.observacoes.push({texto:txt,proximaContato: new Date(dt).toISOString(), data: new Date().toISOString(), status: status}); saveOrcamentos(); renderLeadOrcamentos(o.leadId); try{ if(modal && modal.__removeOverlayClose) modal.__removeOverlayClose(); }catch(e){} modal.remove(); showMessage('Observação adicionada ao orçamento','sucesso'); };
  }
function loadAppLogo(){
  const img = document.getElementById('app-logo');
  if(!img) return;
  // 1) try localStorage
  const data = localStorage.getItem(KEY_APP_LOGO);
  if(data){ img.src = data; img.style.display='block'; return; }
  // 2) try project-local file (relative)
  const rel = './LOGO.png';
  // quick existence check by attempting to load it
  checkImageLoadable(rel).then(ok=>{ if(ok){ img.src = rel; img.style.display='block'; } else {
    // 3) try desktop file URL (encoded path)
    const desktopPath = 'file:///home/joao/%C3%81rea%20de%20Trabalho/LOGO.png';
    checkImageLoadable(desktopPath).then(ok2=>{ if(ok2){ img.src = desktopPath; img.style.display='block'; } else {
      // 4) fallback inline SVG placeholder
      img.src = 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect rx="12" ry="12" width="100%" height="100%" fill="%23f7f7f9"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial,Helvetica,sans-serif" font-size="18" fill="%23701212">LOGO</text></svg>');
      img.style.display='block';
    }}).catch(()=>{ img.src = rel; img.style.display='block'; });
  }}).catch(()=>{ img.style.display='none'; });
}

function checkImageLoadable(url){
  return new Promise((resolve)=>{
    const t = new Image();
    let settled = false;
    t.onload = ()=>{ if(!settled){ settled=true; resolve(true); } };
    t.onerror = ()=>{ if(!settled){ settled=true; resolve(false); } };
    // try to load (some browsers block file:// when served over http, so this may fail)
    t.src = url;
    // timeout fallback
    setTimeout(()=>{ if(!settled){ settled=true; resolve(false); } }, 900);
  });
}
// --- Lead status auxiliary table (Configurações) ---
const KEY_LEAD_STATUS = 'orc_lead_statuses_v1';
let leadStatuses = [];
function loadLeadStatuses(){ const s = localStorage.getItem(KEY_LEAD_STATUS); leadStatuses = s?JSON.parse(s):['Lead','Contato','Interessado','Cliente','Perdido']; }
function saveLeadStatuses(){ localStorage.setItem(KEY_LEAD_STATUS, JSON.stringify(leadStatuses)); }
// After saving statuses, refresh UI bindings
const origSaveLeadStatuses = saveLeadStatuses;
function saveLeadStatuses(){ localStorage.setItem(KEY_LEAD_STATUS, JSON.stringify(leadStatuses)); try{ populateLeadStatusOptions(); populateLeadFilterOptions(); renderDashboardCounts(); }catch(e){} }

// Render a simple modal/list for statuses
function abrirStatusLeads(){ loadLeadStatuses();
  // create or reuse container
  let container = document.getElementById('status-leads-modal');
  if(!container){
    container = document.createElement('div'); container.id='status-leads-modal';
    container.style.position='fixed'; container.style.left='0'; container.style.top='0'; container.style.right='0'; container.style.bottom='0'; container.style.background='rgba(0,0,0,0.45)'; container.style.display='flex'; container.style.alignItems='center'; container.style.justifyContent='center'; container.style.zIndex=2200;
    container.innerHTML = `<div style="background:#fff;padding:16px;border-radius:10px;max-width:720px;width:92%;box-shadow:0 18px 60px rgba(0,0,0,0.24)">
      <h3>Status dos Leads</h3>
      <div id="status-leads-list" style="max-height:320px;overflow:auto;margin-top:8px"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <input id="novo-status-input" placeholder="Novo status" class="cliente-input" style="flex:1">
        <button onclick="adicionarStatusLead()">Adicionar</button>
        <button onclick="fecharStatusLeads()" class="btn-cancel">Fechar</button>
      </div>
    </div>`;
    document.body.appendChild(container);
    try{ if(typeof attachOverlayClose === 'function'){ attachOverlayClose(container, fecharStatusLeads); } }catch(e){}
  }
  renderStatusLeadsList();
}

function fecharStatusLeads(){ const c = document.getElementById('status-leads-modal'); if(c){ c.remove(); } }

function renderStatusLeadsList(){ const list = document.getElementById('status-leads-list'); if(!list) return; list.innerHTML='';
  loadLeadStatuses();
  leadStatuses.forEach((s,idx)=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.justifyContent='space-between'; row.style.padding='6px 8px'; row.style.borderBottom='1px solid #f0f0f0';
    const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='8px';
    const inp = document.createElement('input'); inp.value = s; inp.style.border='none'; inp.style.background='transparent'; inp.style.fontSize='14px'; inp.onchange = (e)=>{ leadStatuses[idx]=e.target.value; saveLeadStatuses(); renderStatusLeadsList(); };
    left.appendChild(inp);
    row.appendChild(left);
    const actions = document.createElement('div');
    const btnUp = document.createElement('button'); btnUp.textContent='↑'; btnUp.title='Mover para cima'; btnUp.style.marginRight='6px'; btnUp.onclick = ()=>{ if(idx>0){ const a=leadStatuses[idx-1]; leadStatuses[idx-1]=leadStatuses[idx]; leadStatuses[idx]=a; saveLeadStatuses(); renderStatusLeadsList(); } };
    const btnDown = document.createElement('button'); btnDown.textContent='↓'; btnDown.title='Mover para baixo'; btnDown.style.marginRight='6px'; btnDown.onclick = ()=>{ if(idx<leadStatuses.length-1){ const a=leadStatuses[idx+1]; leadStatuses[idx+1]=leadStatuses[idx]; leadStatuses[idx]=a; saveLeadStatuses(); renderStatusLeadsList(); } };
    const btnDel = document.createElement('button'); btnDel.textContent='Excluir'; btnDel.className='danger'; btnDel.onclick = ()=>{
      // prevent deleting a status that is in use
      loadLeads(); const used = leads.filter(l=> (l.status||'')===s );
      if(used.length>0){ // show modal listing the leads
        showStatusUsedModal(s, used); return; }
      if(confirm('Excluir status "'+s+'"?')){ leadStatuses = leadStatuses.filter((v,i)=>i!==idx); saveLeadStatuses(); renderStatusLeadsList(); populateLeadStatusOptions(); populateLeadFilterOptions(); }
    };
    actions.appendChild(btnUp); actions.appendChild(btnDown); actions.appendChild(btnDel);
    row.appendChild(actions);
    list.appendChild(row);
  });
}

function adicionarStatusLead(){ const v=document.getElementById('novo-status-input'); if(!v) return; const txt=(v.value||'').trim(); if(!txt) return; loadLeadStatuses(); if(leadStatuses.includes(txt)){ showMessage('Status já existe','erro'); return; } leadStatuses.push(txt); saveLeadStatuses(); v.value=''; renderStatusLeadsList(); }

// Helper to populate status select in lead form dynamically
function populateLeadStatusOptions(){ loadLeadStatuses(); const sel = document.getElementById('lead-status'); if(!sel) return; sel.innerHTML=''; leadStatuses.forEach(s=>{ const o = document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); }); }

// Also populate the leads list status filter
function populateLeadFilterOptions(){ loadLeadStatuses(); const sel = document.getElementById('lead-filtro-status'); if(!sel) return; const cur = sel.value || ''; sel.innerHTML=''; const optAll = document.createElement('option'); optAll.value=''; optAll.textContent='Todos os status'; sel.appendChild(optAll);
  leadStatuses.forEach(s=>{ const o = document.createElement('option'); o.value=s; o.textContent=s; sel.appendChild(o); });
  if(cur) sel.value = cur;
}

// Ensure statuses loaded on startup
document.addEventListener('DOMContentLoaded', ()=>{ loadLeadStatuses(); populateLeadStatusOptions(); populateLeadFilterOptions(); });
function saveLogoFileAsBase64(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=>{ try{ localStorage.setItem(KEY_APP_LOGO, fr.result); resolve(fr.result); }catch(e){ reject(e); } };
    fr.onerror = (e)=> reject(e);
    fr.readAsDataURL(file);
  });
}
// Reusable modal for status-used warnings
function showStatusUsedModal(status, usedLeads){
  // ensure modal container
  let m = document.getElementById('status-used-modal');
  if(!m){
    m = document.createElement('div'); m.id='status-used-modal';
    m.style.position='fixed'; m.style.left='0'; m.style.top='0'; m.style.right='0'; m.style.bottom='0'; m.style.background='rgba(0,0,0,0.45)'; m.style.display='flex'; m.style.alignItems='center'; m.style.justifyContent='center'; m.style.zIndex=2300;
    m.innerHTML = `<div style="background:#fff;padding:14px;border-radius:10px;max-width:760px;width:92%;box-shadow:0 18px 60px rgba(0,0,0,0.24)">
      <h3>Status em uso</h3>
      <div id="status-used-content" style="max-height:320px;overflow:auto;margin-top:6px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="status-used-view">Ver Leads</button>
        <button id="status-used-close" class="btn-cancel">Fechar</button>
      </div>
    </div>`;
    document.body.appendChild(m);
    try{ if(typeof attachOverlayClose === 'function'){ attachOverlayClose(m, ()=>{ try{ if(m && m.__removeOverlayClose) m.__removeOverlayClose(); m.remove(); }catch(e){} }); } }catch(e){}
    document.getElementById('status-used-close').onclick = ()=>{ try{ if(m && m.__removeOverlayClose) m.__removeOverlayClose(); }catch(e){} m.remove(); };
    document.getElementById('status-used-view').onclick = ()=>{
      // open leads and filter
      abrir('leads'); const sel = document.getElementById('lead-filtro-status'); if(sel){ sel.value = status; filtrosLeads.status = status; renderLeadsList(); }
      try{ if(m && m.__removeOverlayClose) m.__removeOverlayClose(); }catch(e){}
      m.remove();
    };
  }
  // populate content
  const content = document.getElementById('status-used-content'); if(!content) return;
  content.innerHTML = `<div>O status "<strong>${escapeHtml(status)}</strong>" está sendo usado pelos seguintes leads (${usedLeads.length}):</div>`;
  const ul = document.createElement('div'); ul.style.marginTop='8px'; ul.style.display='flex'; ul.style.flexDirection='column'; ul.style.gap='6px';
  usedLeads.forEach(l=>{
    const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center'; el.style.padding='6px 8px'; el.style.border='1px solid #f3f3f3'; el.style.borderRadius='6px';
    const left = document.createElement('div'); left.textContent = (l.nome||l.doc||'Lead');
    const right = document.createElement('div');
    const btn = document.createElement('button'); btn.textContent='Abrir'; btn.onclick = ()=>{ abrir('leads'); editarLead(l.id); m.remove(); };
    right.appendChild(btn);
    el.appendChild(left); el.appendChild(right);
    ul.appendChild(el);
  });
  content.appendChild(ul);
}

// Attach overlay click and Escape key handlers to a modal overlay element.
// modalEl: the overlay element (covers the viewport). onClose: callback to invoke when overlay clicked outside panel or Escape pressed.
function attachOverlayClose(modalEl, onClose){
  if(!modalEl) return;
  // ensure we don't attach multiple times
  if(modalEl.__overlayCloseAttached) return;
  function onOverlayClick(e){
    // if click target is the overlay itself (not a child panel), close
    if(e.target === modalEl){ try{ onClose(); }catch(ex){} }
  }
  function onEsc(e){ if(e.key === 'Escape'){ try{ onClose(); }catch(ex){} } }
  modalEl.addEventListener('click', onOverlayClick);
  document.addEventListener('keydown', onEsc);
  // store references for cleanup
  modalEl.__overlayCloseAttached = true;
  modalEl.__overlayCloseHandlers = { onOverlayClick, onEsc };
  // patch/remove helper to allow explicit cleanup when modal is programmatically removed
  modalEl.__removeOverlayClose = function(){
    try{ if(modalEl.__overlayCloseHandlers){ modalEl.removeEventListener('click', modalEl.__overlayCloseHandlers.onOverlayClick); document.removeEventListener('keydown', modalEl.__overlayCloseHandlers.onEsc); } }catch(e){}
    delete modalEl.__overlayCloseAttached; delete modalEl.__overlayCloseHandlers; delete modalEl.__removeOverlayClose;
  };
}
function assignLogoHandlers(){
  try{
    loadAppLogo();
    const img = document.getElementById('app-logo');
    if(!img) return;
    // set accessible attributes
    img.setAttribute('role','button');
    img.setAttribute('aria-label','Ir para Início');
    img.style.cursor = 'pointer';
    // remove any previous inline onclick to avoid duplicate behavior
    img.onclick = null;
    // attach click handler: Ctrl/Cmd opens stored image, otherwise navigate to home
    img.addEventListener('click', function logoClickHandler(ev){
      if(ev.ctrlKey || ev.metaKey){ const data = localStorage.getItem(KEY_APP_LOGO); if(data) window.open(data,'_blank'); return; }
      abrir('home');
    });
    // keyboard support (Enter / Space)
    img.addEventListener('keydown', function logoKeyHandler(ev){ if(ev.key==='Enter' || ev.key===' '){ ev.preventDefault(); abrir('home'); } });
  }catch(e){/* ignore */}
}
document.addEventListener('DOMContentLoaded', assignLogoHandlers);
window.addEventListener('load', assignLogoHandlers);
</script>
  <script>
  // Sidebar removed: provide a safe no-op adjustSidebarLayout so callers don't error
  if(typeof adjustSidebarLayout !== 'function'){
    window.adjustSidebarLayout = function(){ /* no-op while sidebar is disabled */ };
  }
  // Nav tests removed
  </script>
  <script>
  // Delegated fallback: if clicking anywhere inside the header-logo container, go to Início
  document.addEventListener('click', function delegatedLogoClick(ev){
    try{
      const hit = ev.target && ev.target.closest && ev.target.closest('#header-logo-container');
      if(!hit) return;
      // Ctrl/Cmd-click should open stored image if present
      if(ev.ctrlKey || ev.metaKey){ const data = localStorage.getItem(KEY_APP_LOGO); if(data) window.open(data,'_blank'); return; }
      if(typeof abrir === 'function') abrir('home');
    }catch(e){}
  });
  // Keyboard support on the container itself
  document.addEventListener('keydown', function delegatedLogoKey(ev){
    try{
      const focused = document.activeElement;
      if(!focused) return;
      if(focused.id === 'header-logo-container' || focused.id === 'app-logo'){
        if(ev.key === 'Enter' || ev.key === ' '){ ev.preventDefault(); if(typeof abrir === 'function') abrir('home'); }
      }
    }catch(e){}
  });
  </script>
  <script>
  // Delegated handlers for client module cards (robust if inline handlers are blocked)
  (function(){
    function handleClientCardAction(el){
      try{
        const key = el.getAttribute('data-fav-key') || '';
        if(key === 'clientes:novo'){ if(typeof abrirCadastroCliente === 'function') abrirCadastroCliente(); }
        else if(key === 'clientes:list'){ if(typeof abrirListaClientes === 'function') abrirListaClientes(); }
      }catch(e){}
    }
    document.addEventListener('click', function(e){
      const card = e.target && e.target.closest && e.target.closest('.client-card');
      if(card) { handleClientCardAction(card); }
    });
    document.addEventListener('keydown', function(e){
      if(e.key !== 'Enter' && e.key !== ' ') return;
      const focused = document.activeElement;
      if(!focused) return;
      if(focused.classList && focused.classList.contains('client-card')){ 
        e.preventDefault(); 
        handleClientCardAction(focused); 
      }
    });
  })();
  </script>
</body>
</html>
